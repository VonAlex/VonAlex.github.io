<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ dict - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2018-09-08 14:04" pubdate>2018-09-08 14:04</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.4k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 46 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ dict</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2018-09-08 14:04</p><div class="markdown-body" id="post-body"><blockquote><p>å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨ (symbol table)ã€å…³è”æ•°ç»„(associative array) æˆ–è€…æ˜ å°„(map)ï¼Œæ˜¯ä¸€ç§ç”¨äºä¿å­˜é”®å€¼å¯¹(key-value pair) çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚</p></blockquote><p>dict æ˜¯ä¸€ç§éå¸¸å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œå› ä¸º c è¯­è¨€é‡Œæ²¡æœ‰å†…ç½®è¿™ç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ redis å†…éƒ¨å®ç°äº†è‡ªå·±çš„ dict æ•°æ®ç»“æ„ã€‚</p><!--more----><p>dict åœ¨ redis ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå¦‚ redis çš„æ•°æ®åº“å°±æ˜¯ä½¿ç”¨ dict æ¥ä½œä¸ºåº•å±‚å®ç°çš„ï¼Œå¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œä¹Ÿæ˜¯æ„å»ºåœ¨å¯¹ dict çš„æ“ä½œä¹‹ä¸Šçš„ã€‚æ­¤å¤–ï¼Œdict è¿˜æ˜¯å“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚</p><p>redis æºç ä¸­å…³äº dict çš„éƒ¨åˆ†ï¼Œä¸»è¦åœ¨ <code>dict.h</code> å’Œ <code>dict.c</code> è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚</p><h3 id="dict- çš„å®šä¹‰"><a href="#dict- çš„å®šä¹‰" class="headerlink" title="dict çš„å®šä¹‰"></a>dict çš„å®šä¹‰</h3><p>é¦–å…ˆåœ¨ <code>dict.h</code> ä¸­æ‰¾åˆ°å®šä¹‰ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dict</span> &#123;</span>
    dictType *type;   <span class="hljs-comment">// ç±»å‹ç‰¹å®šå‡½æ•°</span>
    <span class="hljs-keyword">void</span> *privdata;  <span class="hljs-comment">// ç§æœ‰æ•°æ®ï¼Œä¿å­˜ç€ dictType ç»“æ„ä¸­å‡½æ•°çš„å‚æ•°</span>
    dictht ht[<span class="hljs-number">2</span>];  <span class="hljs-comment">// å“ˆå¸Œè¡¨ï¼Œ2 ä¸ª</span>
    <span class="hljs-keyword">long</span> rehashidx; <span class="hljs-comment">/* æ ‡è®° rehash è¿›åº¦ï¼Œæ²¡æœ‰çš„è¯ä¸º -1 */</span>
    <span class="hljs-keyword">int</span> iterators; <span class="hljs-comment">/* number of iterators currently running */</span>
&#125; dict;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictht</span> &#123;</span>
    dictEntry **table;  <span class="hljs-comment">// å“ˆå¸ŒèŠ‚ç‚¹æ•°ç»„ï¼Œä¸€ä¸ªä¸ª hash æ¡¶</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size;  <span class="hljs-comment">// å“ˆå¸Œè¡¨å¤§å°</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> sizemask; <span class="hljs-comment">// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œè®¡ç®—ç´¢å¼•å€¼ï¼Œ= size-1</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> used;  <span class="hljs-comment">// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹ï¼ˆ k-v å¯¹ ï¼‰çš„æ•°é‡</span>
&#125; dictht;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> &#123;</span>
    <span class="hljs-keyword">void</span> *key;
    <span class="hljs-keyword">union</span> &#123;
        <span class="hljs-keyword">void</span> *val;
        <span class="hljs-keyword">uint64_t</span> u64;
        <span class="hljs-keyword">int64_t</span> s64;
        <span class="hljs-keyword">double</span> d;
    &#125; v;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> *<span class="hljs-title">next</span>;</span> <span class="hljs-comment">// é“¾è¡¨æ³•è§£å†³ hash å†²çª</span>
&#125; dictEntry;</code></pre></div><p>å°†ä»¥ä¸Šä¸‰ä¸ªç»“æ„ä½“ä½¿ç”¨å¦‚ä¸‹å›¾ç‰‡è¿›è¡Œè¡¨ç¤ºï¼Œå¯èƒ½ä¼šæ›´æ¸…æ¥šä¸€äº›ã€‚</p><p><img src="https://s1.ax1x.com/2018/09/08/iPRjfg.jpg" srcset="/img/loading.gif" alt="redis-dict"></p><p><code>dict</code> ç»“æ„åŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ <code>dictht</code>ï¼Œæ¯ä¸€ä¸ªå“ˆå¸Œè¡¨éƒ½æœ‰å¾ˆå¤šä¸ªå“ˆå¸Œæ¡¶ <code>dictEntry</code>ï¼Œ<code>table</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ç±»å‹å˜é‡ã€‚æ¯ä¸€ä¸ªå“ˆå¸Œæ¡¶æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä»¥ <strong>é“¾è¡¨æ³• </strong>è§£å†³å“ˆå¸Œå†²çªé—®é¢˜ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä½¿ç”¨ <code>ht[0]</code>ï¼Œå½“å‘ç”Ÿ rehash çš„æ—¶å€™æ‰ä¼šç”¨åˆ° <code>ht[1]</code>ï¼Œæ­¤æ—¶ <code>rehashidx</code> å˜é‡ä¼šè®°å½• rehash ç›®å‰çš„è¿›åº¦ï¼Œä¸è¿›è¡Œ rehash æ—¶ï¼Œå€¼ä¸º -1ã€‚</p><p><code>dictType</code> ç»“æ„ä½“å®šä¹‰äº†ä¸€äº›æ“ä½œ <code>dict</code> æ—¶è¦ç”¨åˆ°çš„å‡½æ•°æŒ‡é’ˆã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictType</span> &#123;</span>
    <span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-params">(*hashFunction)</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key)</span></span>;  <span class="hljs-comment">// è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°</span>
    <span class="hljs-keyword">void</span> *(*keyDup)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key); <span class="hljs-comment">// å¤åˆ¶ key çš„å‡½æ•°</span>
    <span class="hljs-keyword">void</span> *(*valDup)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *obj); <span class="hljs-comment">// å¤åˆ¶ val çš„å‡½æ•°</span>
    <span class="hljs-keyword">int</span> (*keyCompare)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key2); <span class="hljs-comment">// æ¯”è¾ƒ key çš„å‡½æ•°</span>
    <span class="hljs-keyword">void</span> (*keyDestructor)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">void</span> *key); <span class="hljs-comment">// é”€æ¯ key çš„ææ„å‡½æ•°</span>
    <span class="hljs-keyword">void</span> (*valDestructor)(<span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">void</span> *obj); <span class="hljs-comment">// é”€æ¯ val çš„ææ„å‡½æ•°</span>
&#125; dictType;</code></pre></div><p>å®šä¹‰äº†ä¸€äº›å®ï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°ä½¿ç”¨è¿™äº›å‡½æ•°æŒ‡é’ˆï¼Œæ¯”å¦‚ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> dictFreeVal(d, entry) \</span>
    <span class="hljs-keyword">if</span> ((d)-&gt;type-&gt;valDestructor) \
        (d)-&gt;type-&gt;valDestructor((d)-&gt;privdata, (entry)-&gt;v.val)</code></pre></div><p>å¦å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ª dict è¿­ä»£å™¨</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictIterator</span> &#123;</span>
    dict *d; <span class="hljs-comment">// è¢«è¿­ä»£çš„ dict</span>
    <span class="hljs-keyword">long</span> index; <span class="hljs-comment">// è¿­ä»£å™¨å½“å‰æ‰€æŒ‡å‘çš„å“ˆå¸Œè¡¨ç´¢å¼•ä½ç½®</span>
    <span class="hljs-comment">// table è¡¨ç¤ºæ­£è¿­ä»£çš„å“ˆå¸Œè¡¨å·ç ï¼Œht[0]æˆ– ht[1]ã€‚safe è¡¨ç¤ºè¿™ä¸ªè¿­ä»£å™¨æ˜¯å¦å®‰å…¨</span>
    <span class="hljs-keyword">int</span> table, safe;
    <span class="hljs-comment">// entry æŒ‡å‘å½“å‰è¿­ä»£çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼ŒnextEntry åˆ™æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
    dictEntry *entry, *nextEntry;
    <span class="hljs-comment">/* unsafe iterator fingerprint for misuse detection. */</span>
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> fingerprint;
&#125; dictIterator;</code></pre></div><h3 id="å“ˆå¸Œç›¸å…³"><a href="# å“ˆå¸Œç›¸å…³" class="headerlink" title="å“ˆå¸Œç›¸å…³"></a>å“ˆå¸Œç›¸å…³</h3><h4 id="å“ˆå¸Œå‡½æ•°"><a href="# å“ˆå¸Œå‡½æ•°" class="headerlink" title="å“ˆå¸Œå‡½æ•°"></a> å“ˆå¸Œå‡½æ•°</h4><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“è¦å¾€ hash è¡¨ä¸­æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå¿…é¡»è¦å…ˆè®¡ç®—ç›¸åº” key çš„ hash å€¼ã€‚</p><p>åœ¨ redis ä¸­å®šä¹‰äº†ä¸‰ç§å“ˆå¸Œå‡½æ•°ã€‚</p><p>ã€1ã€‘Thomas Wangâ€™s 32 bit Mix Function</p><p>ã€2ã€‘djb å“ˆå¸Œç®—æ³•</p><p>ã€3ã€‘MurmurHash2ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸º MurmurHash3</p><p>å½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°æ—¶ï¼Œæˆ–è€…å“ˆå¸Œ key çš„åº•å±‚å®ç°æ—¶ï¼Œ redis ä½¿ç”¨ MurmurHash2 ç®—æ³•æ¥è®¡ç®— key çš„å“ˆå¸Œå€¼ã€‚</p><p>hash å€¼ä½¿ç”¨ hash å‡½æ•°è¿›è¡Œè®¡ç®—ï¼Œç„¶åä¸ <code>dictht</code> çš„ <code>sizemask</code> å–æ¨¡ï¼Œå°±å¾—åˆ°äº†å“ˆå¸Œæ¡¶çš„ç´¢å¼•ã€‚</p><h4 id="å“ˆå¸Œå†²çª"><a href="# å“ˆå¸Œå†²çª" class="headerlink" title="å“ˆå¸Œå†²çª"></a>å“ˆå¸Œå†²çª</h4><p>redis ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</p><p>å› ä¸º <code>dictEntry</code> èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨æ²¡æœ‰æŒ‡å‘é“¾è¡¨è¡¨å°¾çš„æŒ‡é’ˆï¼Œè€ƒè™‘åˆ°æ·»åŠ èŠ‚ç‚¹çš„æˆæœ¬ï¼Œæ€»æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼Œä½¿å¾—å¤æ‚åº¦ä» <code>O(n)</code> é™ä½ä¸º <code>O(1)</code>ã€‚</p><h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h3><p>éšç€æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œhash è¡¨ä¸­ä¿å­˜çš„å…ƒç´ æ•°é‡ä¼šåŠ¨æ€å˜åŒ–ï¼Œä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ï¼Œéœ€è¦å¯¹å“ˆå¸Œè¡¨çš„å¤§å°å¤š <strong>åŠ¨æ€ </strong>è°ƒæ•´ã€‚</p><p>å¤§å°è°ƒæ•´è¿‡ç¨‹ä¸­å°±æ¶‰åŠåˆ°å“ˆå¸Œæ¡¶çš„åˆ†æ‹†æˆ–åˆå¹¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš rehashã€‚</p><p>å½“è´Ÿè½½å› å­è¿‡é«˜æ—¶ï¼Œäº§ç”Ÿ hash å†²çªçš„å‡ ç‡å°±å¢å¤§äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æŸäº›å“ˆå¸Œæ¡¶ä¸­çš„é“¾è¡¨ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè¿™æ ·æ—¶æŸ¥æ‰¾å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦è¶‹äº <code>O(n)</code>ï¼Œè¿™ä¸ªæ—¶å€™å¯¹ hash è¡¨æ‰©å®¹ã€‚</p><p>å¦åˆ™ï¼Œå…¶ä¸­å…ƒç´ å¤ªå°ï¼Œæµªè´¹ç©ºé—´ï¼Œå°±å…ˆé‡Šæ”¾ï¼Œè¦ç”¨çš„è¯å†ç”³è¯·ã€‚</p><h4 id="æ˜¯å¦éœ€è¦ -rehash"><a href="# æ˜¯å¦éœ€è¦ -rehash" class="headerlink" title="æ˜¯å¦éœ€è¦ rehash"></a>æ˜¯å¦éœ€è¦ rehash</h4><p>å¯¹äºæ˜¯å¦éœ€è¦è¿›è¡Œ rehashï¼Œæœ‰ä¸€ä¸ªç§æœ‰å‡½æ•°æ¥å°½è¿›è¡Œåˆ¤æ–­ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> _dictExpandIfNeeded(dict *d)
&#123;
    <span class="hljs-comment">/* Incremental rehashing already in progress. Return. */</span>
    <span class="hljs-keyword">if</span> (dictIsRehashing(d)) <span class="hljs-keyword">return</span> DICT_OK;


    <span class="hljs-comment">// å¦‚æœ hash table æ˜¯çœ‹çš„ï¼Œé‚£ä¹ˆæŠŠå®ƒæ”¶ç¼©æˆå‡ºåˆå§‹åŒ– size (= 4)</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> dictExpand(d, DICT_HT_INITIAL_SIZE);

    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].used &gt;= d-&gt;ht[<span class="hljs-number">0</span>].size &amp;&amp;
        (dict_can_resize ||
         d-&gt;ht[<span class="hljs-number">0</span>].used/d-&gt;ht[<span class="hljs-number">0</span>].size &gt; dict_force_resize_ratio))
    &#123;
        <span class="hljs-keyword">return</span> dictExpand(d, d-&gt;ht[<span class="hljs-number">0</span>].used*<span class="hljs-number">2</span>);
    &#125;
    <span class="hljs-keyword">return</span> DICT_OK;
&#125;</code></pre></div><p>ä»¥ä¸Šå‡½æ•°è‡ªåŠ¨åˆ¤æ–­çš„ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ‰‹åŠ¨å‘èµ· rehash çš„å‡½æ•°ï¼Œç”¨æ¥å¯¹å“ˆå¸Œè¡¨è¿›è¡Œç¼©å®¹æ“ä½œã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictResize</span><span class="hljs-params">(dict *d)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">int</span> minimal;

    <span class="hljs-comment">// å½“ dict_can_resize = 0 æˆ–è€… dict æ­£åœ¨åš rehash æ—¶</span>
    <span class="hljs-keyword">if</span> (!dict_can_resize || dictIsRehashing(d)) <span class="hljs-keyword">return</span> DICT_ERR;
    minimal = d-&gt;ht[<span class="hljs-number">0</span>].used;
    <span class="hljs-keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE) <span class="hljs-comment">// å°äº 4 çš„è¯æŒ‰ç…§ 4 æ¥ç®—</span>
        minimal = DICT_HT_INITIAL_SIZE;
    <span class="hljs-keyword">return</span> dictExpand(d, minimal); <span class="hljs-comment">// ç”¨ minimal è°ƒæ•´å­—å…¸ d çš„å¤§å°</span>
&#125;</code></pre></div><p><code>dict_can_resize</code> è¿™ä¸ªå˜é‡åšäº†æ ‡è®°ï¼Œè¯´æ˜ server åœ¨åš <code>BGSAVE</code> å‘½ä»¤æˆ–è€… <code>BGREWRITEAOF</code>ã€‚</p><h4 id="å¦‚ä½• -rehash"><a href="# å¦‚ä½• -rehash" class="headerlink" title="å¦‚ä½• rehash"></a>å¦‚ä½• rehash</h4><h5 id="æ‰©å®¹æ“ä½œ"><a href="# æ‰©å®¹æ“ä½œ" class="headerlink" title="æ‰©å®¹æ“ä½œ"></a>æ‰©å®¹æ“ä½œ</h5><p>åœ¨ <code>ht[0].size == 0</code>æ—¶ï¼Œå³ç©ºå“ˆå¸Œè¡¨ï¼Œè¿™æ—¶å€™æŠŠå“ˆå¸Œè¡¨ç¼©å®¹åˆ° size ä¸ºåˆå§‹å€¼ <strong>4</strong>ã€‚</p><p>åœ¨<code>used &gt; size</code> çš„æƒ…å†µä¸‹ï¼Œå³è¿™ä¸ªæ—¶å€™è‚¯å®šå‡ºç°äº†å“ˆå¸Œå†²çªï¼Œ</p><p>å¦‚æœå…è®¸ rehashï¼Œè¿›è¡Œå“ˆå¸Œè¡¨æ‰©å®¹æ“ä½œï¼Œsize ä¸º ç¬¬ä¸€ä¸ª <strong>&gt;=</strong> <code>ht[0].used*2</code></p><p>å³ä½¿ä¸å…è®¸ï¼Œåœ¨ <code>used:size &gt; 5</code>çš„æƒ…å†µä¸‹ä¹Ÿå¿…é¡»åšå¼ºåˆ¶ rehashã€‚</p><p>è¿™æ—¶ï¼Œæ–°çš„å“ˆå¸Œè¡¨ï¼Œå³ <code>ht[1]</code> å¤§å°ä¸ºç¬¬ä¸€ä¸ª &gt;= <code>ht[0].used*2</code>çš„ 2 çš„ n æ¬¡å¹‚ã€‚</p><h5 id="ç¼©å®¹æ“ä½œ"><a href="# ç¼©å®¹æ“ä½œ" class="headerlink" title="ç¼©å®¹æ“ä½œ"></a>ç¼©å®¹æ“ä½œ</h5><p>å³æ‰§è¡Œä¸Šé¢çš„ <code>dictResize</code>æ“ä½œï¼Œè¿™ä¸ªéœ€è¦ <strong>æ‰‹åŠ¨è§¦å‘</strong>ã€‚</p><p><code>ht[1]</code> å¤§å°ä¸ºç¬¬ä¸€ä¸ª &gt;= <code>ht[0].used</code>çš„ 2 çš„ n æ¬¡å¹‚ï¼Œæœ€å°ä¸èƒ½å°äº 4ã€‚</p><p>æ ¹æ®è®¡ç®—å¾—åˆ°çš„æ–°å“ˆå¸Œè¡¨çš„å¤§å°ï¼Œä¸º <code>ht[1]</code>åˆ†é…å†…å­˜ï¼Œå°† <code>ht[0]</code> ä¸Šçš„æ•°æ®éƒ½è¿ç§»åˆ° <code>ht[1]</code>ã€‚</p><p>ç„¶åå°†åŸæ¥ <code>ht[0]</code>çš„æŒ‡é’ˆæŒ‡å‘ <code>ht[1]</code>ï¼Œé‡Šæ”¾æ—§çš„ <code>ht[0]</code> å†…å­˜ï¼Œé‡ç½®å„ä¸ªæˆå‘˜å˜é‡ï¼Œç•™ç€ä¸‹æ¬¡å¤‡ç”¨ã€‚</p><h5 id="æ¸è¿›å¼ -rehash"><a href="# æ¸è¿›å¼ -rehash" class="headerlink" title="æ¸è¿›å¼ rehash"></a>æ¸è¿›å¼ rehash</h5><p>å¦‚æœæ˜¯ä¸€æ¬¡æ€§å®Œæˆå¦‚ä¸Šçš„ rehash æ“ä½œï¼Œé‚£å…ƒç´ å¾ˆå¤šçš„è¯ï¼Œå¯ä»¥é¢„è§ï¼Œæ€§èƒ½ä¼šå¾ˆå·®ã€‚æ‰€ä»¥ redis é‡Œé‡‡ç”¨äº†ä¸€ä¸ªå«æ¸è¿›å¼ rehash çš„æ–¹æ¡ˆæ¥åšè¿™ä»¶äº‹æƒ…ï¼ŒæŠŠä¸€æ¬¡æ€§è¦åšçš„äº‹æƒ…åˆ†ä¸ºå¤šæ­¥ã€‚</p><p>ä¸»è¦ç”± <code>_dictRehashStep</code> å’Œ <code>dictRehashMilliseconds</code> ä¸¤ä¸ªå‡½æ•°è´Ÿè´£ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _dictRehashStep(dict *d) &#123;
    <span class="hljs-keyword">if</span> (d-&gt;iterators == <span class="hljs-number">0</span>) dictRehash(d,<span class="hljs-number">1</span>);<span class="hljs-comment">// æ²¡æœ‰è¿­ä»£å™¨ï¼Œè¿›è¡Œ 1 æ­¥ rehash</span>
&#125;</code></pre></div><p><code>_dictRehashStep</code> ä¸ºè¢«åŠ¨ rehash ï¼Œæ¯æ¬¡åªè¿ç§»ä¸€ä¸ªå“ˆå¸Œæ¡¶ã€‚dict åœ¨åšå…¶ä»–æ“ä½œæ—¶ä¼šæŸ¥è¯¢ä¸€ä¸‹æ˜¯ä¸æ˜¯åœ¨åš rehashï¼Œæ˜¯çš„è¯ï¼Œå°±ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚</p><p>å¦‚ä¸‹ï¼š<br><img src="https://s1.ax1x.com/2018/09/09/iPzIIS.jpg" srcset="/img/loading.gif" alt="dict-rehash"></p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictRehashMilliseconds</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">int</span> ms)</span> </span>&#123;
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> start = timeInMilliseconds();
    <span class="hljs-keyword">int</span> rehashes = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">while</span>(dictRehash(d,<span class="hljs-number">100</span>)) &#123; <span class="hljs-comment">// ç›´åˆ° rehash å®Œæˆ–è€…æ—¶é—´åˆ°äº†</span>
        rehashes += <span class="hljs-number">100</span>;
        <span class="hljs-keyword">if</span> (timeInMilliseconds()-start &gt; ms) <span class="hljs-keyword">break</span>;
    &#125;
    <span class="hljs-keyword">return</span> rehashes;
&#125;</code></pre></div><p><code>dictRehashMilliseconds</code> åœ¨ç»™å®šçš„ <strong>æ¯«ç§’ </strong>æ—¶é—´å†…è¿›è¡Œ rehashï¼Œæ¯æ¬¡æ­¥é•¿ä¸º 100 ä¸ª hash æ¡¶ï¼Œè¿”å›å€¼ä¸º move äº†å¤šå°‘ä¸ª å“ˆå¸Œæ¡¶ã€‚å®ƒæ˜¯åœ¨ redis çš„ <code>serverCron</code> é‡Œä¸»åŠ¨è§¦å‘çš„ï¼Œè¿™æ˜¯ä¸€ä¸ª 1ms çš„å®šæ—¶ä»»åŠ¡ã€‚</p><h4 id="å‡½æ•°å®ç°"><a href="# å‡½æ•°å®ç°" class="headerlink" title="å‡½æ•°å®ç°"></a>å‡½æ•°å®ç°</h4><p><strong>æ³¨æ„</strong>ï¼š</p><ul><li>å› ä¸ºåœ¨ rehash æ—¶ï¼Œå­—å…¸ä¼šåŒæ—¶ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œæ‰€ä»¥åœ¨è¿™æœŸé—´çš„æ‰€æœ‰æŸ¥æ‰¾ã€åˆ é™¤ç­‰æ“ä½œï¼Œé™¤äº†åœ¨ <code>ht[0]</code> ä¸Šè¿›è¡Œï¼Œè¿˜éœ€è¦åœ¨ <code>ht[1]</code> ä¸Šè¿›è¡Œã€‚</li><li>åœ¨æ‰§è¡Œæ·»åŠ æ“ä½œæ—¶ï¼Œæ–°çš„èŠ‚ç‚¹ä¼šç›´æ¥æ·»åŠ åˆ° <code>ht[1]</code> è€Œä¸æ˜¯ <code>ht[0]</code> ï¼Œè¿™æ ·ä¿è¯ <code>ht[0]</code> çš„èŠ‚ç‚¹æ•°é‡åœ¨æ•´ä¸ª rehash è¿‡ç¨‹ä¸­éƒ½åªå‡ä¸å¢ã€‚</li></ul><h5 id="åˆ›å»º -dict"><a href="# åˆ›å»º -dict" class="headerlink" title="åˆ›å»º dict"></a>åˆ›å»º dict</h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ dict ç»“æ„</span>
<span class="hljs-function">dict *<span class="hljs-title">dictCreate</span><span class="hljs-params">(dictType *type, <span class="hljs-keyword">void</span> *privDataPtr)</span></span>
<span class="hljs-function"></span>&#123;
    dict *d = zmalloc(<span class="hljs-keyword">sizeof</span>(*d)); <span class="hljs-comment">// åˆ†é…å†…å­˜</span>
    _dictInit(d,type,privDataPtr);
    <span class="hljs-keyword">return</span> d;
&#125;

<span class="hljs-comment">/* Initialize the hash table */</span>
<span class="hljs-keyword">int</span> _dictInit(dict *d, dictType *type,
        <span class="hljs-keyword">void</span> *privDataPtr)
&#123;
    _dictReset(&amp;d-&gt;ht[<span class="hljs-number">0</span>]); <span class="hljs-comment">// ä¸¤ä¸ª hashtable çš„åˆå§‹åŒ–</span>
    _dictReset(&amp;d-&gt;ht[<span class="hljs-number">1</span>]);
    d-&gt;type = type;
    d-&gt;privdata = privDataPtr;
    d-&gt;rehashidx = <span class="hljs-number">-1</span>;  <span class="hljs-comment">// åˆå§‹åŒ–ä¸º -1</span>
    d-&gt;iterators = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> DICT_OK;
&#125;</code></pre></div><p>åˆ›å»ºä¸€ä¸ª <code>dict</code>ï¼Œä¸»è¦å°±æ˜¯åˆ†é…å†…å­˜ï¼Œåˆå§‹åŒ–å˜é‡ã€‚</p><h5 id="æ‰©å®¹ - åˆ›å»º hash-table"><a href="# æ‰©å®¹ - åˆ›å»º hash-table" class="headerlink" title="æ‰©å®¹ / åˆ›å»º hash table"></a>æ‰©å®¹ / åˆ›å»º hash table</h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictExpand</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> size)</span></span>
<span class="hljs-function"></span>&#123;
    dictht n; <span class="hljs-comment">// æ–°çš„ dicthtï¼Œç”¨äºæ›¿æ¢</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> realsize = _dictNextPower(size);

    <span class="hljs-comment">// å½“ dict æ­£åœ¨ rehash æˆ–è€… size å°äºç°åœ¨çš„ ht[0].usedï¼Œè¯´æ˜è¿™ä¸ª size æ˜¯ä¸åˆæ³•çš„ï¼Œè¿”å›é”™è¯¯ DICT_ERR</span>
    <span class="hljs-comment">// è¦åŒ…å«ç°åœ¨ dict æ‰€æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆ size ä¸€å®šè¦ &gt;= ht[0].used</span>
    <span class="hljs-keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="hljs-number">0</span>].used &gt; size)
        <span class="hljs-keyword">return</span> DICT_ERR;

    <span class="hljs-comment">// è¦ rehash çš„ dictht å¤§å°è·Ÿç°åœ¨ dictht å¤§å°ç›¸ç­‰ï¼Œå°±æ²¡å¿…è¦åš rehash äº†ï¼Œè¿”å›é”™è¯¯ DICT_ERR</span>
    <span class="hljs-keyword">if</span> (realsize == d-&gt;ht[<span class="hljs-number">0</span>].size) <span class="hljs-keyword">return</span> DICT_ERR;

    n.size = realsize;
    n.sizemask = realsize<span class="hljs-number">-1</span>;
    n.table = zcalloc(realsize*<span class="hljs-keyword">sizeof</span>(dictEntry*));
    n.used = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// è¿™æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–å—ï¼Ÿå¦‚æœçœŸæ˜¯è¿™æ ·ï¼Œé‚£è¿™å°±ä¸æ˜¯ä¸€ä¸ª rehash</span>
    <span class="hljs-comment">// ä»…è®¾ç½®ç¬¬ä¸€ä¸ª hash è¡¨ï¼Œä»¥ä¾¿æ¥æ”¶ keys</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].table == <span class="hljs-literal">NULL</span>) &#123;
        d-&gt;ht[<span class="hljs-number">0</span>] = n;
        <span class="hljs-keyword">return</span> DICT_OK;
    &#125;

    <span class="hljs-comment">// éé¦–æ¬¡åˆå§‹åŒ–ï¼Œé‚£å°±è®¾ç½®ç¬¬äºŒä¸ª hash è¡¨ï¼Œè®¾ç½® rehashidx æ ‡è®°ï¼Œ</span>
    <span class="hljs-comment">// ç°åœ¨å¯ä»¥è¿›è¡Œ rehash äº†</span>
    d-&gt;ht[<span class="hljs-number">1</span>] = n;
    d-&gt;rehashidx = <span class="hljs-number">0</span>; <span class="hljs-comment">// rehash è¿›åº¦ä¸º 0</span>
    <span class="hljs-keyword">return</span> DICT_OK;
&#125;</code></pre></div><h5 id="æ·»åŠ å…ƒç´ "><a href="# æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictAdd</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">void</span> *key, <span class="hljs-keyword">void</span> *val)</span></span>
<span class="hljs-function"></span>&#123;
    dictEntry *entry = dictAddRaw(d,key);

    <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">return</span> DICT_ERR;
    dictSetVal(d, entry, val);
    <span class="hljs-keyword">return</span> DICT_OK;
&#125;</code></pre></div><p><code>dictAddRaw</code>å‡½æ•°åªæ˜¯å¢åŠ äº† keyï¼Œè€Œ value éœ€è¦ key å¢åŠ æˆåŠŸåå†æ¬¡è®¾ç½®ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function">dictEntry *<span class="hljs-title">dictAddRaw</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">void</span> *key)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">int</span> index;
    dictEntry *entry;
    dictht *ht;

    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åœ¨ rehash</span>
    <span class="hljs-keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);

    <span class="hljs-comment">/* è·å¾—è¿™ä¸ªæ–°å…ƒç´ éœ€è¦åŠ åˆ°å“ªä¸ª hash æ¡¶ï¼Œ</span>
<span class="hljs-comment">     * è‹¥è¿”å› -1 è¡¨ç¤ºå·²ç»å­˜åœ¨è¿™ä¸ª key äº†ï¼Œç›´æ¥è¿”å› NULL</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">if</span> ((index = _dictKeyIndex(d, key)) == <span class="hljs-number">-1</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">/* ä¸ºæ–°çš„ key åˆ†é…å†…å­˜å¹¶å­˜åˆ° ht ä¸­</span>
<span class="hljs-comment">     * æŠŠæ–°çš„ key æ”¾åˆ° hash æ¡¶é‡Œ list çš„ç¬¬ä¸€ä¸ªï¼Œå‡å®šåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­æ–°åŠ å…¥çš„ key ä¼šæ›´é¢‘ç¹è®¿é—®åˆ°ï¼Œè¿™ä¼šå‡å°‘æŸ¥è¯¢æ—¶é—´</span>
<span class="hljs-comment">     * */</span>
    <span class="hljs-comment">// dict åœ¨åš rehash çš„è¯ï¼Œç›´æ¥æŠŠæ–° key åŠ åˆ° ht[1]ï¼Œå¦åˆ™åŠ åˆ° ht[0]</span>
    ht = dictIsRehashing(d) ? &amp;d-&gt;ht[<span class="hljs-number">1</span>] : &amp;d-&gt;ht[<span class="hljs-number">0</span>];
    entry = zmalloc(<span class="hljs-keyword">sizeof</span>(*entry));
    entry-&gt;next = ht-&gt;table[index];
    ht-&gt;table[index] = entry;
    ht-&gt;used++;

    dictSetKey(d, entry, key); <span class="hljs-comment">// ä¸º key è®¾ç½® value</span>
    <span class="hljs-keyword">return</span> entry; <span class="hljs-comment">// è¿”å›æ–°åŠ å…¥çš„ entry</span>
&#125;</code></pre></div><h5 id="Replace- å…ƒç´ "><a href="#Replace- å…ƒç´ " class="headerlink" title="Replace å…ƒç´ "></a>Replace å…ƒç´ </h5><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå‡½æ•° <code>dictReplace</code> å’Œ <code>dictReplaceRaw</code>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictReplace</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">void</span> *key, <span class="hljs-keyword">void</span> *val)</span></span>
<span class="hljs-function"></span>&#123;
    dictEntry *entry, auxentry;
    <span class="hljs-comment">// è¦æ·»åŠ çš„ key åœ¨ dict ä¸­ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥æ·»åŠ æˆåŠŸ</span>
    <span class="hljs-keyword">if</span> (dictAdd(d, key, val) == DICT_OK)
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;

   <span class="hljs-comment">// è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜é”® key å·²ç»å­˜åœ¨ï¼Œæ‰¾åˆ°å®ƒ</span>
    entry = dictFind(d, key);

    <span class="hljs-comment">// è®¾ç½®æ–°çš„ valueï¼Œé‡Šæ”¾æ—§çš„ã€‚</span>
    auxentry = *entry;
    dictSetVal(d, entry, val);
    dictFreeVal(d, &amp;auxentry);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-function">dictEntry *<span class="hljs-title">dictReplaceRaw</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">void</span> *key)</span> </span>&#123;
    dictEntry *entry = dictFind(d,key);

    <span class="hljs-comment">// è¿”å›å·²ç»å­˜åœ¨çš„ key ï¼Œæˆ–è€…æ–°åŠ çš„</span>
    <span class="hljs-keyword">return</span> entry ? entry : dictAddRaw(d,key);
&#125;</code></pre></div><h5 id="åˆ é™¤å…ƒç´ "><a href="# åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h5><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictDelete</span><span class="hljs-params">(dict *ht, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key)</span> </span>&#123;
    <span class="hljs-keyword">return</span> dictGenericDelete(ht,key,<span class="hljs-number">0</span>);
&#125;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dictDeleteNoFree</span><span class="hljs-params">(dict *ht, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key)</span> </span>&#123;
    <span class="hljs-keyword">return</span> dictGenericDelete(ht,key,<span class="hljs-number">1</span>);
&#125;</code></pre></div><p>ä¸Šé¢ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«åœ¨äºåˆ é™¤ key çš„æ—¶å€™æ˜¯å¦è°ƒç”¨ key å’Œ value çš„é‡Šæ”¾å‡½æ•°ã€‚è€ŒçœŸæ­£çš„åˆ é™¤å‡½æ•°æ˜¯ <code>dictGenericDelete</code>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">dictGenericDelete</span><span class="hljs-params">(dict *d, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *key, <span class="hljs-keyword">int</span> nofree)</span></span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> h, idx;
    dictEntry *he, *prevHe;
    <span class="hljs-keyword">int</span> table;

     <span class="hljs-comment">/* d-&gt;ht[0].table is NULL */</span>
    <span class="hljs-keyword">if</span> (d-&gt;ht[<span class="hljs-number">0</span>].size == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> DICT_ERR;
    <span class="hljs-keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d); <span class="hljs-comment">// æ‰§è¡Œæ¸è¿›å¼ rehash</span>
    h = dictHashKey(d, key);

    <span class="hljs-keyword">for</span> (table = <span class="hljs-number">0</span>; table &lt;= <span class="hljs-number">1</span>; table++) &#123;
        idx = h &amp; d-&gt;ht[table].sizemask;
        he = d-&gt;ht[table].table[idx];
        prevHe = <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">while</span>(he) &#123;
            <span class="hljs-keyword">if</span> (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) &#123; <span class="hljs-comment">// æ‰¾åˆ°è¿™ä¸ª key</span>
                <span class="hljs-keyword">if</span> (prevHe) <span class="hljs-comment">// æ˜¯ä¸æ˜¯è¯¥ hash slot çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span>
                    prevHe-&gt;next = he-&gt;next;
                <span class="hljs-keyword">else</span>
                    d-&gt;ht[table].table[idx] = he-&gt;next;
                <span class="hljs-keyword">if</span> (!nofree) &#123;
                    dictFreeKey(d, he);
                    dictFreeVal(d, he);
                &#125;
                zfree(he);
                d-&gt;ht[table].used--;
                <span class="hljs-keyword">return</span> DICT_OK;
            &#125;
            prevHe = he;
            he = he-&gt;next;
        &#125;
        <span class="hljs-keyword">if</span> (!dictIsRehashing(d)) <span class="hljs-keyword">break</span>;
    &#125;
    <span class="hljs-keyword">return</span> DICT_ERR; <span class="hljs-comment">/* not found */</span>
&#125;</code></pre></div><h5 id="éå†å…ƒç´ "><a href="# éå†å…ƒç´ " class="headerlink" title="éå†å…ƒç´ "></a>éå†å…ƒç´ </h5><p><code>dictScan</code> è¿™ä¸ªå‡½æ•°æ˜¯ <code>dict</code> ç»“æ„æœ€æœ‰ç‰¹è‰²çš„ä¸€ä¸ªå‡½æ•°ã€‚ç”¨æ¥éå† <code>dict</code>ï¼Œä¸»è¦æ˜¯è¦è€ƒè™‘æ‰©ç¼©å®¹çš„æƒ…å†µã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">dictScan</span><span class="hljs-params">(dict *d,</span></span>
<span class="hljs-function"><span class="hljs-params">                       <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> v,</span></span>
<span class="hljs-function"><span class="hljs-params">                       dictScanFunction *fn,</span></span>
<span class="hljs-function"><span class="hljs-params">                       <span class="hljs-keyword">void</span> *privdata)</span></span>
<span class="hljs-function"></span>&#123;
    dictht *t0, *t1;
    <span class="hljs-keyword">const</span> dictEntry *de;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> m0, m1;

    <span class="hljs-keyword">if</span> (dictSize(d) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (!dictIsRehashing(d)) &#123; <span class="hljs-comment">// ä¸åœ¨ rehashï¼Œç›´æ¥æ‰«æ ht[0] å°±å¥½äº†</span>
        t0 = &amp;(d-&gt;ht[<span class="hljs-number">0</span>]);
        m0 = t0-&gt;sizemask;

        <span class="hljs-comment">/* Emit entries at cursor */</span>
        de = t0-&gt;table[v &amp; m0];
        <span class="hljs-keyword">while</span> (de) &#123; <span class="hljs-comment">// æ‰«æå®Œè¿™ä¸ª slotï¼Œå› ä¸ºå¯èƒ½æ˜¯é“¾è¡¨</span>
            fn(privdata, de);
            de = de-&gt;next;
        &#125;

    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// æ­£åœ¨ rehashingï¼Œå°±å­˜åœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ ht[0]ã€ht[1]</span>
        t0 = &amp;d-&gt;ht[<span class="hljs-number">0</span>];
        t1 = &amp;d-&gt;ht[<span class="hljs-number">1</span>];

        <span class="hljs-comment">// ç¡®ä¿ t0 æ¯” t1 å°</span>
        <span class="hljs-keyword">if</span> (t0-&gt;size &gt; t1-&gt;size) &#123;
            t0 = &amp;d-&gt;ht[<span class="hljs-number">1</span>];
            t1 = &amp;d-&gt;ht[<span class="hljs-number">0</span>];
        &#125;

        m0 = t0-&gt;sizemask;
        m1 = t1-&gt;sizemask;

        de = t0-&gt;table[v &amp; m0];<span class="hljs-comment">// æ‰«æ t0 çš„æŸä¸ª slot</span>
        <span class="hljs-keyword">while</span> (de) &#123;
            fn(privdata, de);
            de = de-&gt;next;
        &#125;

        <span class="hljs-comment">// è¿­ä»£(å¤§è¡¨)t1 ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¾ªç¯è¿­ä»£ï¼Œä¼šæŠŠå°è¡¨æ²¡æœ‰è¦†ç›–çš„ slot å…¨éƒ¨æ‰«æä¸€é</span>
        <span class="hljs-comment">// åŒæ¨¡çš„ slot</span>
        <span class="hljs-keyword">do</span> &#123;
            <span class="hljs-comment">/* Emit entries at cursor */</span>
            de = t1-&gt;table[v &amp; m1];
            <span class="hljs-keyword">while</span> (de) &#123;
                fn(privdata, de);
                de = de-&gt;next;
            &#125;

            <span class="hljs-comment">/* Increment bits not covered by the smaller mask */</span>
            <span class="hljs-comment">// æ–°å¢åŠ çš„ bits ä½æ¯æ¬¡åŠ ä¸€</span>
            v = (((v | m0) + <span class="hljs-number">1</span>) &amp; ~m0) | (v &amp; m0);
        &#125; <span class="hljs-keyword">while</span> (v &amp; (m0 ^ m1)); <span class="hljs-comment">// ç›´åˆ°æ–°åŠ çš„ bits éƒ½éå¤„ç†å®Œäº†</span>
    &#125;

    v |= ~m0;

    <span class="hljs-comment">/* Increment the reverse cursor */</span>
    v = rev(v);
    v++;
    v = rev(v);

    <span class="hljs-keyword">return</span> v;
&#125;</code></pre></div><p>redis é‡‡ç”¨äº†ä¸€ç§é«˜ä½è¿›ä½çš„æ–¹å¼æ¥éå†å“ˆå¸Œæ¡¶ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„åŠ  1ã€‚ä»¥ size ä¸º 8 ä¸ºä¾‹ï¼Œéå†é¡ºåºæ˜¯è¿™æ ·çš„ï¼š000 -&gt; 100 -&gt; 010 -&gt; 110 -&gt; 001 -&gt; 101 -&gt; 011 -&gt; 111ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡éƒ½æ˜¯æœ€åˆ°ä½åŠ  1ï¼Œå‘ä½ä½å»è¿›ä½ï¼Œæ­£å¥½è·Ÿæˆ‘ä»¬å¹³å¸¸çš„è¿ç®—ç›¸åï¼Œå› æ­¤ï¼Œè¿™ä¹Ÿå« <strong>åå‘äºŒè¿›åˆ¶ä½è¿­ä»£</strong>ã€‚</p><p>å…·ä½“åŸç†å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://tech.meituan.com/Redis_Rehash_Practice_Optimization.html">ã€Šç¾å›¢é’ˆå¯¹ Redis Rehash æœºåˆ¶çš„æ¢ç´¢å’Œå®è·µã€‹</a>ï¼ŒåŒæ—¶è¯¥æ–‡ç« ä¹ŸæŒ‡å‡ºäº†è¯¥ç®—æ³•çš„ä¸€ä¸ª bugï¼Œå¹¶æä¾›çš„ä¿®å¤æ–¹æ¡ˆã€‚</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/9ceee0f6.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis æºç ä¹‹ Bio</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/85f7b0b4.html"><span class="hidden-mobile">Redis ä¸­çš„äº‹ä»¶</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ dict&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>