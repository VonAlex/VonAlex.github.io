<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis Cluster è·¯ç”±å˜æ›´ - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-02-23 21:42" pubdate>2021-02-23 21:42</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.1k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 28 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis Cluster è·¯ç”±å˜æ›´</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2021-02-23 21:42</p><div class="markdown-body" id="post-body"><p>Redis Cluster é‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„è·¯ç”±æ–¹æ¡ˆï¼Œcluster ä¸­çš„æ¯ä¸ª node éƒ½å¯ä»¥æ„ŸçŸ¥åˆ°å®Œæ•´è·¯ç”±è¡¨ï¼Œä¸ºäº†èƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®åˆ°æ•°æ®ï¼Œè·¯ç”±è¡¨çš„æ­£ç¡®æ€§ä¿è¯è‡³å…³é‡è¦ã€‚<br><a id="more"></a></p><p>åœ¨ cluster èŠ‚ç‚¹æ•°é‡ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸¤ç§æƒ…å†µå¯ä»¥å¯¼è‡´è·¯ç”±çš„å˜åŒ–ï¼Œå³ä¸»ä»å…³ç³»å˜æ›´å’Œ slot reshardingã€‚<br>åŒæ—¶ï¼Œéœ€è¦è€ƒè™‘ server é‡å¯å’Œ partition æ¢å¤åå¦‚ä½•å»æ›´æ–°æœ¬åœ°æ—§çš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>æœ¬æ–‡å°†ç»“åˆä»£ç ç‰‡æ®µé€ä¸€åˆ†æã€‚</p><h2 id="ä¸»ä»å…³ç³»å˜æ›´"><a href="# ä¸»ä»å…³ç³»å˜æ›´" class="headerlink" title="ä¸»ä»å…³ç³»å˜æ›´"></a>ä¸»ä»å…³ç³»å˜æ›´</h2><h3 id="failover"><a href="#failover" class="headerlink" title="failover"></a>failover</h3><p>æ‰§è¡Œ failover åï¼Œé¦–å…ˆåœ¨æœ¬åœ°åšå˜æ›´ï¼Œç„¶åé€šè¿‡ gossip ä¿¡æ¯ä¼ æ’­ï¼Œä½¿å¾—è·¯ç”±åœ¨ cluster å†…æ‰“å¹³ã€‚</p><h4 id="æœ¬èŠ‚ç‚¹å˜æ›´"><a href="# æœ¬èŠ‚ç‚¹å˜æ›´" class="headerlink" title="æœ¬èŠ‚ç‚¹å˜æ›´"></a>æœ¬èŠ‚ç‚¹å˜æ›´</h4><p>ä¸ç®¡æ˜¯ä¸»åŠ¨ failover è¿˜æ˜¯è¢«åŠ¨ failoverï¼Œæµç¨‹çš„æœ€åä¸€æ­¥éƒ½éœ€è¦è°ƒç”¨ <code>clusterFailoverReplaceYourMaster</code> å‡½æ•°ã€‚</p><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæœ‰ä»¥ä¸‹ 5 ä¸ªæ­¥éª¤ï¼Œ</p><p>1ï¼‰ä¿®æ”¹èŠ‚ç‚¹ flag æ ‡è¯†</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* 1) Turn this node into a master. */</span>
clusterSetNodeAsMaster(myself);</code></pre></div><div class="hljs"><pre><code class="hljs c"> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterSetNodeAsMaster</span><span class="hljs-params">(clusterNode *n)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (nodeIsMaster(n)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (n-&gt;slaveof) &#123;
        clusterNodeRemoveSlave(n-&gt;slaveof,n);
        <span class="hljs-keyword">if</span> (n != myself) n-&gt;flags |= CLUSTER_NODE_MIGRATE_TO;
    &#125;
    n-&gt;flags &amp;= ~CLUSTER_NODE_SLAVE;
    n-&gt;flags |= CLUSTER_NODE_MASTER;
    n-&gt;slaveof = <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">/* Update config and state. */</span>
    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|
                         CLUSTER_TODO_UPDATE_STATE);
&#125;</code></pre></div><p>å»æ‰ <strong>CLUSTER_NODE_SLAVE</strong> æ ‡è¯†ï¼Œå˜æ›´ä¸º <strong>CLUSTER_NODE_MASTER</strong>ï¼Œå–æ¶ˆæœ¬åœ°è·¯ç”±è¡¨ä¸­åŸæœ‰çš„ä¸»ä»å…³ç³»ã€‚</p><p>2ï¼‰æ¥ç®¡ slot</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* 2) Claim all the slots assigned to our master. */</span>

clusterNode *oldmaster = myself-&gt;slaveof;
<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;
    <span class="hljs-keyword">if</span> (clusterNodeGetSlotBit(oldmaster,j)) &#123;
        clusterDelSlot(j);
        clusterAddSlot(myself,j);
    &#125;
&#125;</code></pre></div><p>å°† oldmaster è´Ÿè´£çš„ slot å…¨éƒ¨äº¤ç»™å½“å‰èŠ‚ç‚¹ã€‚</p><p>3ï¼‰æ›´æ–° cluster state çŠ¶æ€ï¼Œå¹¶ä¿å­˜ configã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* 3) Update state and save config. */</span>
clusterUpdateState();
clusterSaveConfigOrDie(<span class="hljs-number">1</span>);</code></pre></div><p>åœ¨ä¿å­˜é…ç½®å‰éœ€è¦å…ˆæ‰§è¡Œ <code>clusterUpdateState</code> å‡½æ•°ã€‚<br>å¯¹äºè¢«åŠ¨ failover çš„æƒ…å†µï¼Œå¿…ç„¶æ˜¯å½“å‰èŠ‚ç‚¹å…ˆæ£€æµ‹åˆ°äº† node failï¼Œé‚£ä¹ˆå¯¹äºé…ç½®äº† <strong>cluster-require-full-coverage</strong> å‚æ•°çš„å®ä¾‹ï¼Œéœ€è¦å°† cluster çŠ¶æ€æ›´æ–°ä¸º <strong>CLUSTER_FAIL</strong>ã€‚</p><p>4ï¼‰å¹¿æ’­è·¯ç”±å˜æ›´</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* 4) Pong all the other nodes so that they can update the state</span>
<span class="hljs-comment">*    accordingly and detect that we switched to master role. */</span>
clusterBroadcastPong(CLUSTER_BROADCAST_ALL);</code></pre></div><p>éå†æœ¬åœ°è·¯ç”±è¡¨ä¸­æ‰€æœ‰è®¤è¯†çš„èŠ‚ç‚¹ï¼Œå‘é€ pong æ¶ˆæ¯ï¼Œå‘ŠçŸ¥å®ƒä»¬æ–°çš„è·¯ç”±ä¿¡æ¯ã€‚</p><p>5ï¼‰é‡ç½® mf çŠ¶æ€</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* 5) If there was a manual failover in progress, clear the state. */</span>
resetManualFailover();</code></pre></div><div class="note note-warning"><p><strong>æ³¨æ„ </strong>ï¼š</p><p>å¦‚æœï¼Œæ­¤æ—¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šæ‰§è¡Œ <code>cluster nodes</code> å‘½ä»¤ï¼Œä¼šçœ‹åˆ°è¯¥èŠ‚ç‚¹å·²ç»åˆ‡æ¢ä¸º masterï¼Œä¸”æºå¸¦ slotï¼Œè€ŒåŸæ¥çš„ master ä¾ç„¶æ˜¯ masterï¼Œåªæ˜¯ä¸å†è´Ÿè´£ slotã€‚</p></div><h4 id="è·¯ç”±æ‰“å¹³"><a href="# è·¯ç”±æ‰“å¹³" class="headerlink" title="è·¯ç”±æ‰“å¹³"></a>è·¯ç”±æ‰“å¹³</h4><p>ä¸Šä¸€å°ç»“æ­¥éª¤ 4ï¼‰ä¸­å‘å‡ºçš„ pong æ¶ˆæ¯ï¼Œä¼šåœ¨ cluster å…¶ä»– node å¼•èµ·è·¯ç”±æ›´æ”¹ã€‚</p><p>ä¸ºè¡¨è¿°æ–¹ä¾¿ï¼Œåšå¦‚ä¸‹å‡è®¾ã€‚<br>æ­£å¸¸ cluster ä¸­æœ‰ä»¥ä¸‹å…³ç³»ï¼šA1 ä¸º slaveï¼ŒA æ˜¯ A1 çš„ masterï¼Œè´Ÿè´£ 0-100 slotï¼Œè·¯äººèŠ‚ç‚¹ Bã€‚</p><p>é‚£ä¹ˆï¼Œè·¯ç”±åœ¨ A/A1/B ä¸‰è€…ä¹‹é—´æ‰“å¹³ï¼Œéœ€è¦ä»¥ä¸‹ 5 ä¸ªæ­¥éª¤ã€‚</p><p>â‘  æ–°ä¸»èŠ‚ç‚¹ A1 æ›´æ–°ï¼ŒA1(myself) role slave â†’ masterï¼Œæ¥ç®¡ slotï¼Œæ­¤æ—¶ A ä»æ˜¯ master ï¼Œä½†æ²¡æœ‰äº† slotsï¼Œå¹¿æ’­ pongã€‚<br>â‘¡ åŸä¸»èŠ‚ç‚¹ A æ›´æ–°ï¼ŒA1 role slave â†’ masterï¼Œæ¥ç®¡ slotsï¼ŒA(myself) role master â†’ slaveï¼ŒæŠ¹æ‰ slotsã€‚A è·¯ç”±æ›´æ–°å®Œæˆã€‚<br>â‘¢ è·¯äººèŠ‚ç‚¹ B æ›´æ–°ï¼ŒA1 role slave â†’ masterï¼Œ[æ¥ç®¡ slots]ï¼ŒA è¿˜æ˜¯ master ï¼Œä½†ä¸è´Ÿè´£ slotsã€‚<br>â‘£ æ–°ä¸»èŠ‚ç‚¹ A1 æ”¶åˆ° A çš„ pingï¼Œæˆ–è€…ä¸»åŠ¨ ping Aï¼ŒA role master â†’ slaveã€‚A1 è·¯ç”±æ›´æ–°å®Œæˆã€‚<br>â‘¤ è·¯äººèŠ‚ç‚¹ B åŒ â‘£ é€»è¾‘ ï¼ˆç­‰å¾…é¢å¤–çš„ pingpongï¼‰ã€‚è·¯äºº B è·¯ç”±æ›´æ–°å®Œæˆã€‚</p><p>å®é™…ä¸Šï¼Œä»¥ä¸Š 5 ä¸ªæ­¥éª¤ä¸­ï¼Œ â‘  å¿…ç„¶ç¬¬ä¸€ä¸ªæ‰§è¡Œï¼Œ ç”±äºç½‘ç»œçš„ä¸å¯é ï¼Œâ‘¢ å’Œ â‘¤ çš„å‘ç”Ÿé¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚</p><p>å¦‚æœ â‘¢ å‘ç”Ÿåœ¨ â‘¤ ä¹‹å‰ï¼Œé‚£ä¹ˆè·¯ç”±æ‰“å¹³é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ</p><p><img src="https://gitee.com/happencc/pics/raw/master/images/failover1.jpg" srcset="/img/loading.gif" alt=""></p><p>è€Œå¦‚æœ â‘¢ å‘ç”Ÿåœ¨ â‘¤ ä¹‹åï¼Œé‚£ä¹ˆè·¯ç”±æ‰“å¹³é€»è¾‘å°†åšå¦‚ä¸‹å˜æ›´ï¼Œ</p><p><img src="https://gitee.com/happencc/pics/raw/master/images/failover2.jpg" srcset="/img/loading.gif" alt=""></p><p>é‡ç‚¹åŒºåˆ«åœ¨è·¯äººèŠ‚ç‚¹ B ä¸Šå¯¹äº A/A1 çš„æ›´æ–°ï¼</p><div class="note note-warning"><p>æ³¨æ„ï¼š</p><p><strong>å¯¹äº node ä¿¡æ¯çš„å˜æ›´ï¼Œä¸€å®šè¦ä»¥â€œå½“äº‹äººâ€è¯´çš„ä¸ºå‡†</strong>ï¼<br>A1 å¯¹åŸ master èŠ‚ç‚¹ A çš„ role ä¿¡æ¯å˜æ›´ä¸€å®šå‘ç”Ÿåœ¨ A è‡ªå·±çš„ role å˜æ›´ä¹‹åï¼<br>A1 åš failover åï¼Œåªæ›´æ”¹äº†è‡ªå·±çš„ä¿¡æ¯ï¼Œä¸å»æ”¹ A çš„ roleï¼Œè‡³äº A è¦æ€ä¹ˆæ”¹ï¼Œéœ€è¦ A å‘ä¿¡æ¯æ¥åŒæ­¥ã€‚</p></div><h3 id="replication"><a href="#replication" class="headerlink" title="replication"></a>replication</h3><p>æ‰§è¡Œ <code>CLUSTER REPLICATE &lt;NODE ID&gt;</code> åï¼Œ<strong>ä»…å¯¹æœ¬åœ°è·¯ç”±è¡¨åšäº†æ›´æ”¹</strong>ï¼Œè·¯ç”±æ‰“å¹³éœ€è¦ä¾é  ping-pong æ¶ˆæ¯å®ç°ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="hljs-number">1</span>]-&gt;ptr,<span class="hljs-string">&quot;replicate&quot;</span>) &amp;&amp; c-&gt;argc == <span class="hljs-number">3</span>) &#123;
    ...
    <span class="hljs-comment">/* Set the master. */</span>
    clusterSetMaster(n);
    clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);
    addReply(c,shared.ok);
&#125;</code></pre></div><p>åœ¨æŸèŠ‚ç‚¹æ”¶åˆ° ping æˆ–è€… pong æ¶ˆæ¯æ—¶ï¼Œå¯¹ role ä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">clusterProcessPacket</span><span class="hljs-params">(clusterLink *link)</span> </span>&#123;
    ...
   <span class="hljs-comment">/* Check for role switch: slave -&gt; master or master -&gt; slave. */</span>
    <span class="hljs-keyword">if</span> (sender) &#123;
    	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">memcmp</span>(hdr-&gt;slaveof, 
          CLUSTER_NODE_NULL_NAME, <span class="hljs-keyword">sizeof</span>(hdr-&gt;slaveof)))
        &#123;
            <span class="hljs-comment">/* sender claimed it is a master. */</span>
         	clusterSetNodeAsMaster(sender);
         &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">/* sender claimed it is a slave. */</span>
            clusterNode *master = clusterLookupNode(hdr-&gt;slaveof);
            ...

            <span class="hljs-comment">/* Master node changed for this slave? */</span>
            <span class="hljs-keyword">if</span> (master &amp;&amp; sender-&gt;slaveof != master) &#123;
                <span class="hljs-keyword">if</span> (sender-&gt;slaveof)
                    clusterNodeRemoveSlave(sender-&gt;slaveof,sender);
                
                <span class="hljs-comment">// ç»‘å®šæ–°çš„ä¸»ä»å…³ç³»</span>
                clusterNodeAddSlave(master,sender);
                sender-&gt;slaveof = master;
                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);
            &#125;
        &#125;
    &#125;
    ...
&#125;</code></pre></div><p>å½“æ£€æµ‹åˆ° sender çš„ master å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨ <code>clusterNodeRemoveSlave</code> å‡½æ•°ï¼ŒæŠŠå®ƒä»åŸæ¥çš„ä¸»ä»å…³ç³»ç»‘å®šä¸­é‡Šæ”¾å‡ºæ¥ï¼Œç»‘å®šæ–°çš„ä¸»ä»å…³ç³»ã€‚</p><h2 id="slot- å˜æ›´"><a href="#slot- å˜æ›´" class="headerlink" title="slot å˜æ›´"></a>slot å˜æ›´</h2><p>åœ¨ slot resharding çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿ slot ownership çš„é‡æ–°ç»‘å®šï¼Œè¯¦ç»†è¿‡ç¨‹å·²ç»åœ¨ä¹‹å‰çš„åšå®¢ ã€Š<a href="https://happencc.gitee.io/91f7e3ff.html">Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§»</a>ã€‹ä¸­è¯¦ç»†ä»‹ç»è¿‡ï¼Œè¿™é‡Œåªè¯´æ˜è·¯ç”±æ‰“å¹³é€»è¾‘ã€‚</p><p>åœ¨ slot è¿ç§»çš„æœ€åä¸€æ­¥ï¼Œæ›´æ”¹ç›®æ ‡èŠ‚ç‚¹è·¯ç”±æ—¶ï¼Œæœ‰ä»¥ä¸‹é€»è¾‘ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="hljs-number">1</span>]-&gt;ptr,<span class="hljs-string">&quot;setslot&quot;</span>) &amp;&amp; c-&gt;argc &gt;= <span class="hljs-number">4</span>) &#123;
    ...
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="hljs-number">3</span>]-&gt;ptr,<span class="hljs-string">&quot;node&quot;</span>) &amp;&amp; c-&gt;argc == <span class="hljs-number">5</span>) &#123;
        ...
        <span class="hljs-keyword">if</span> (n == myself &amp;&amp; 
          server.cluster-&gt;importing_slots_from[slot])
        &#123;
        	<span class="hljs-keyword">if</span> (clusterBumpConfigEpochWithoutConsensus() == C_OK) &#123;&#125;
            server.cluster-&gt;importing_slots_from[slot] = <span class="hljs-literal">NULL</span>;
        &#125;
        clusterDelSlot(slot); 
        clusterAddSlot(n,slot);
    &#125;
&#125;</code></pre></div><p>åœ¨ <code>clusterBumpConfigEpochWithoutConsensus</code> å‡½æ•°ä¸­ï¼Œè¿ç§»ç›®æ ‡èŠ‚ç‚¹è¦ä¿è¯è‡ªå·±çš„ configEpoch ä¸º cluster ä¸­æœ€å¤§ã€‚</p><p>å…¶ä»–èŠ‚ç‚¹åœ¨ ping-pong æ¶ˆæ¯å¤„ç†ä¸­ï¼Œé€šè¿‡ diff å¯¹è·¯ç”±è¿›è¡Œç›¸åº”çš„å˜æ›´ï¼Œä»£ç å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">clusterProcessPacket</span><span class="hljs-params">(clusterLink *link)</span> </span>&#123;
    ...
    clusterNode *sender_master = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* Sender or its master if slave. */</span>
    <span class="hljs-keyword">int</span> dirty_slots = <span class="hljs-number">0</span>; <span class="hljs-comment">/* Sender claimed slots don&#x27;t match my view? */</span>

    <span class="hljs-keyword">if</span> (sender) &#123;
        sender_master = nodeIsMaster(sender) ? sender : sender-&gt;slaveof; 
        <span class="hljs-keyword">if</span> (sender_master) &#123;
            dirty_slots = <span class="hljs-built_in">memcmp</span>(sender_master-&gt;slots,
              hdr-&gt;myslots, <span class="hljs-keyword">sizeof</span>(hdr-&gt;myslots)) != <span class="hljs-number">0</span>; 
        &#125;
    &#125;

    <span class="hljs-keyword">if</span> (sender &amp;&amp; nodeIsMaster(sender) &amp;&amp; dirty_slots)
        clusterUpdateSlotsConfigWith(sender,
          senderConfigEpoch,hdr-&gt;myslots);
    ...
&#125;</code></pre></div><p>ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“æŸèŠ‚ç‚¹çœ‹åˆ°çš„ sender è´Ÿè´£çš„ slotï¼Œä¸ sender æäº¤çš„ä¿¡æ¯ä¸ä¸€è‡´æ—¶ï¼Œè°ƒç”¨ <code>clusterUpdateSlotsConfigWith</code> å‡½æ•°è¿›è¡Œè·¯ç”±çŸ«æ­£ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterUpdateSlotsConfigWith</span><span class="hljs-params">(clusterNode *sender, <span class="hljs-keyword">uint64_t</span> senderConfigEpoch, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *slots)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.cluster-&gt;slots[j] == <span class="hljs-literal">NULL</span> || 
            server.cluster-&gt;slots[j]-&gt;configEpoch &lt; senderConfigEpoch) 
        &#123;
        	...
            clusterDelSlot(j);
            clusterAddSlot(sender,j); 
        	...
        &#125;
    ...
&#125;</code></pre></div><p>è·¯ç”±ä¿¡æ¯æ ¹æ® configEpoch æ›´æ–°ï¼ŒconfigEpoch è¶Šå¤§è¡¨æ˜è·¯ç”±è¶Šæ–°ã€‚</p><p><strong>æ³¨æ„</strong>ï¼Œè¯¥å‡½æ•°ä¸­æœ‰ä¸€ä¸ªé€»è¾‘éœ€è¦æ ¼å¤–æ³¨æ„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c">clusterNode *curmaster, *newmaster = <span class="hljs-literal">NULL</span>;
curmaster = nodeIsMaster(myself) ? myself : myself-&gt;slaveof;

<span class="hljs-keyword">if</span> (server.cluster-&gt;importing_slots_from[j]) <span class="hljs-keyword">continue</span>;

<span class="hljs-keyword">if</span> (server.cluster-&gt;slots[j] == <span class="hljs-literal">NULL</span> || 
                server.cluster-&gt;slots[j]-&gt;configEpoch &lt; senderConfigEpoch) 
&#123;
    ...
    <span class="hljs-keyword">if</span> (server.cluster-&gt;slots[j] == curmaster)
        newmaster = sender;
&#125;
...
    
<span class="hljs-keyword">if</span> (newmaster &amp;&amp; curmaster-&gt;numslots == <span class="hljs-number">0</span>) &#123;
    clusterSetMaster(sender);
&#125;</code></pre></div><p>å¦‚æœå½“å‰èŠ‚ç‚¹æˆ–å½“å‰èŠ‚ç‚¹çš„ master å¤±å»æŸ slot çš„æ‰€æœ‰æƒæ—¶ï¼Œnewmaster ä¼šè®°å½• slot æ‰€æœ‰æƒè¢«è°å¤ºèµ°äº†ã€‚å¦‚æœå…¨éƒ¨è¢«å¤ºèµ°äº†ï¼Œé‚£ä¹ˆå°±è®¤å¯¹æ–¹ä¸ºè‡ªå·±çš„ masterã€‚</p><p>æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå‡è®¾ç°åœ¨é›†ç¾¤è·¯ç”±å…³ç³»å¦‚ä¸‹ï¼Œ<br><img src="https://gitee.com/happencc/pics/raw/master/images/migrate.jpg" srcset="/img/loading.gif" alt=""></p><p>A å¾€ C è¿ç§»æœ€åä¸€ä¸ª slotï¼Œæ­£å¸¸æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>â‘  ç›®çš„ C æ‰§è¡Œ <code>SETSLOT</code> å‘½ä»¤ï¼ŒC æ‹¥æœ‰ slot 1<br>â‘¡ æºèŠ‚ç‚¹ A æ‰§è¡Œ <code>SETSLOT</code> å‘½ä»¤ï¼ŒA å¤±å» slot 1</p><p>ä½†æ˜¯ â‘ â‘¡ ä¸æ˜¯åŸå­æ“ä½œï¼ŒA åœ¨æ‰§è¡Œ <code>SETSLOT</code> å‘½ä»¤ä¹‹å‰ï¼Œæœ‰å¯èƒ½ä¼šå…ˆæ”¶åˆ° C çš„ ping æˆ–è€… pongï¼ŒæŒ‰ç…§ä¸Šé¢ä»£ç åˆ†æçš„é€»è¾‘ï¼ŒA å°±æˆäº† C çš„ slaveï¼Œå³ A1 slaveof Aï¼ŒA slaveof Cã€‚</p><h2 id="è¿‡æœŸä¿®å¤"><a href="# è¿‡æœŸä¿®å¤" class="headerlink" title="è¿‡æœŸä¿®å¤"></a>è¿‡æœŸä¿®å¤</h2><p>å½“ server é‡å¯æˆ– partition æ¢å¤åï¼Œå¯èƒ½ä¼šå› ä¸ºæœ¬åœ°è·¯ç”±ä¿¡æ¯è¿‡æ—§è€Œæä¹±æ•´ä¸ª cluster è·¯ç”±ï¼Œåœ¨ Redis Cluster ä¸­ä½¿ç”¨ <strong>CLUSTERMSG_TYPE_UPDATE</strong> ç±»å‹æ¶ˆæ¯å¯¹æ­¤è¿›è¡Œå¤„ç†ã€‚ä»£ç å¤§è‡´å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">clusterProcessPacket</span><span class="hljs-params">(clusterLink *link)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (sender &amp;&amp; dirty_slots) &#123;
        <span class="hljs-keyword">int</span> j;

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;
            <span class="hljs-keyword">if</span> (bitmapTestBit(hdr-&gt;myslots,j)) &#123;
                <span class="hljs-keyword">if</span> (server.cluster-&gt;slots[j] == sender ||
                    server.cluster-&gt;slots[j] == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">continue</span>;

                <span class="hljs-keyword">if</span> (server.cluster-&gt;slots[j]-&gt;configEpoch &gt; senderConfigEpoch) 
                &#123;
                    clusterSendUpdate(sender-&gt;link, server.cluster-&gt;slots[j]);
                    <span class="hljs-keyword">break</span>;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div><p>å¦‚æœæœ¬åœ°çœ‹åˆ°çš„ slot j çš„æ‰€æœ‰è€…ä¿¡æ¯æ¯” sender å£°æ˜çš„è¦æ–°ï¼Œé‚£ä¹ˆï¼Œé€šçŸ¥å®ƒå»åšæ›´æ–°ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>
    <span class="hljs-keyword">uint64_t</span> configEpoch; <span class="hljs-comment">/* Config epoch of the specified instance. */</span>
    <span class="hljs-keyword">char</span> nodename[CLUSTER_NAMELEN]; <span class="hljs-comment">/* Name of the slots owner. */</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> slots[CLUSTER_SLOTS/<span class="hljs-number">8</span>]; <span class="hljs-comment">/* Slots bitmap. */</span>
&#125; clusterMsgDataUpdate;</code></pre></div><p><strong>CLUSTERMSG_TYPE_UPDATE</strong> æ¶ˆæ¯ä¸­ä¼šå‘Šè¯‰å¯¹æ–¹ï¼Œè¯¥ slot åº”è¯¥å±äºè°ã€‚</p><p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œåªæ˜¯åœ¨æ£€æŸ¥åˆ°ç¬¬ä¸€ä¸ª slot ä¿¡æ¯å‡ºç° diff æ—¶ï¼Œå‘é€ <strong>CLUSTERMSG_TYPE_UPDATE</strong> æ¶ˆæ¯ï¼Œå¦‚æœå‡ºç°å¤šä¸ª slot æœ‰ä¸åŒçš„æŒæœ‰ä¿¡æ¯ï¼Œé‚£ä¹ˆéœ€è¦å¤šæ¬¡ä¿¡æ¯äº¤äº’ã€‚</p><hr><p>ä»¥ä¸Šä¾¿æ˜¯ Redis Cluster ä¸­è·¯ç”±æ›´æ–°çš„æ‰€æœ‰æƒ…å†µã€‚</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/a4c4e01c.html"><span class="hidden-mobile">Redis Cluster availability è®¨è®º</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis Cluster è·¯ç”±å˜æ›´&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>