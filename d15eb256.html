<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis æŒä¹…åŒ–ä¹‹ AOF é‡å†™ - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2019-01-20 01:55" pubdate>2019-01-20 01:55</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.8k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 53 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis æŒä¹…åŒ–ä¹‹ AOF é‡å†™</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2019-01-20 01:55</p><div class="markdown-body" id="post-body"><blockquote><p>å› ä¸º AOF æŒä¹…åŒ–æ˜¯é€šè¿‡ä¿å­˜è¢«æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€çš„ï¼Œæ‰€ä»¥éšç€æœåŠ¡å™¨è¿è¡Œæ—¶é—´çš„æµé€ï¼ŒAOF æ–‡ä»¶ä¸­çš„å†…å®¹ä¼šåŸæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„ä½“ç§¯ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œè‹¥ä¸åŠ ä»¥æ§åˆ¶ï¼Œä½“ç§¯è¿‡å¤§çš„ AOF æ–‡ä»¶å¾ˆå¯èƒ½å¯¹ Redis æœåŠ¡å™¨ã€ç”šè‡³æ•´ä¸ªå®¿ä¸»è®¡ç®—æœºé€ æˆå½±å“ï¼Œå¹¶ä¸”å…¶ä½“ç§¯è¶Šå¤§ï¼Œä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿›è¡Œæ•°æ®è¿˜åŸæ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ã€‚</p></blockquote><!--more----><p>ä¸ºé˜²æ­¢ aofrewrite è¿‡ç¨‹é˜»å¡æœåŠ¡å™¨ï¼ŒRedis æœåŠ¡å™¨ä¼š <code>fork</code> ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œè¯¥è¿‡ç¨‹ï¼Œä¸”ä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå­è¿›ç¨‹åšè¿™ä»¶äº‹ã€‚</p><h2 id="server- ç›¸å…³å˜é‡"><a href="#server- ç›¸å…³å˜é‡" class="headerlink" title="server ç›¸å…³å˜é‡"></a>server ç›¸å…³å˜é‡</h2><p>ä¸ºäº†ä¿è¯ AOF çš„è¿ç»­æ€§ï¼Œçˆ¶è¿›ç¨‹æŠŠ aofrewrite æœŸé—´çš„å†™å‘½ä»¤ç¼“å­˜èµ·æ¥ï¼Œç­‰å­è¿›ç¨‹é‡å†™ä¹‹åå†è¿½åŠ åˆ°æ–°çš„ AOF æ–‡ä»¶ã€‚å¦‚æœ aofrewrite æœŸé—´å†™å‘½ä»¤å†™å…¥é‡è¾ƒå¤§çš„è¯ï¼Œå­è¿›ç¨‹ç»“æŸåï¼Œçˆ¶è¿›ç¨‹çš„è¿½åŠ å°±æ¶‰åŠåˆ° <strong>å¤§é‡çš„å†™ç£ç›˜æ“ä½œ</strong>ï¼Œé€ æˆæœåŠ¡æ€§èƒ½ä¸‹é™ã€‚</p><p>Redis é€šè¿‡åœ¨çˆ¶å­è¿›ç¨‹é—´å»ºç«‹ pipeï¼ŒæŠŠ aofrewrite æœŸé—´çš„å†™å‘½ä»¤é€šè¿‡ pipe åŒæ­¥ç»™å­è¿›ç¨‹ï¼Œè¿™æ ·ä¸€æ¥ï¼Œè¿½åŠ å†™ç›˜çš„æ“ä½œä¹Ÿå°±è½¬å«ç»™äº†å­è¿›ç¨‹ã€‚Redis server ä¸­ä¸ä¹‹ç›¸å…³çš„å˜é‡ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼Œä¸»è¦ä¸‰ä¸ª pipeã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">int</span> aof_pipe_write_data_to_child;
<span class="hljs-keyword">int</span> aof_pipe_read_data_from_parent;
<span class="hljs-keyword">int</span> aof_pipe_write_ack_to_parent;
<span class="hljs-keyword">int</span> aof_pipe_read_ack_from_child;
<span class="hljs-keyword">int</span> aof_pipe_write_ack_to_child;
<span class="hljs-keyword">int</span> aof_pipe_read_ack_from_parent;
<span class="hljs-keyword">int</span> aof_stop_sending_diff; <span class="hljs-comment">/*If true stop sending accumulated diffs to child process. */</span>
sds aof_child_diff;        <span class="hljs-comment">/* AOF diff accumulator child side. */</span></code></pre></div><h2 id="å®ç°åŸç†"><a href="# å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>aofrewrite çš„å…¥å£é€»è¾‘åœ¨ <code>rewriteAppendOnlyFileBackground</code> å‡½æ•°ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFileBackground</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.aof_child_pid != <span class="hljs-number">-1</span> || server.rdb_child_pid != <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> C_ERR;
    ...
&#125;</code></pre></div><p>è¦ç¡®ä¿æ²¡æœ‰åå°è¿›ç¨‹åš aofrewrite æˆ–è€… rdbï¼Œæ‰ä¼šè€ƒè™‘åšæœ¬æ¬¡çš„ aofrewriteã€‚</p><h3 id="pipe- åˆå§‹åŒ–"><a href="#pipe- åˆå§‹åŒ–" class="headerlink" title="pipe åˆå§‹åŒ–"></a>pipe åˆå§‹åŒ–</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFileBackground</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
   ...
   <span class="hljs-keyword">if</span> (aofCreatePipes() != C_OK) <span class="hljs-keyword">return</span> C_ERR;
   ...
&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">aofCreatePipes</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">int</span> fds[<span class="hljs-number">6</span>] = &#123;<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>&#125;;
    <span class="hljs-keyword">int</span> j;

    <span class="hljs-keyword">if</span> (pipe(fds) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> error; <span class="hljs-comment">/* parent -&gt; children data. */</span>
    <span class="hljs-keyword">if</span> (pipe(fds+<span class="hljs-number">2</span>) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> error; <span class="hljs-comment">/* children -&gt; parent ack. */</span>
    <span class="hljs-keyword">if</span> (pipe(fds+<span class="hljs-number">4</span>) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> error; <span class="hljs-comment">/* children -&gt; parent ack. */</span>
    <span class="hljs-comment">/* Parent -&gt; children data is non blocking. */</span>
    <span class="hljs-keyword">if</span> (anetNonBlock(<span class="hljs-literal">NULL</span>,fds[<span class="hljs-number">0</span>]) != ANET_OK) <span class="hljs-keyword">goto</span> error;
    <span class="hljs-keyword">if</span> (anetNonBlock(<span class="hljs-literal">NULL</span>,fds[<span class="hljs-number">1</span>]) != ANET_OK) <span class="hljs-keyword">goto</span> error;

    <span class="hljs-comment">/* æ³¨å†Œè¯»äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè´Ÿè´£å¤„ç†å­è¿›ç¨‹è¦æ±‚åœæ­¢æ•°æ®ä¼ è¾“çš„æ¶ˆæ¯ */</span>
    <span class="hljs-keyword">if</span> (aeCreateFileEvent(server.el, fds[<span class="hljs-number">2</span>], AE_READABLE, aofChildPipeReadable, <span class="hljs-literal">NULL</span>) == AE_ERR) <span class="hljs-keyword">goto</span> error;

    server.aof_pipe_write_data_to_child = fds[<span class="hljs-number">1</span>];
    server.aof_pipe_read_data_from_parent = fds[<span class="hljs-number">0</span>];
    server.aof_pipe_write_ack_to_parent = fds[<span class="hljs-number">3</span>];
    server.aof_pipe_read_ack_from_child = fds[<span class="hljs-number">2</span>];
    server.aof_pipe_write_ack_to_child = fds[<span class="hljs-number">5</span>];
    server.aof_pipe_read_ack_from_parent = fds[<span class="hljs-number">4</span>];
    server.aof_stop_sending_diff = <span class="hljs-number">0</span>; <span class="hljs-comment">/* æ˜¯å¦åœæ­¢ç®¡é“ä¼ è¾“æ ‡è®°ä½ */</span>
    <span class="hljs-keyword">return</span> C_OK;

error:
    serverLog(LL_WARNING,<span class="hljs-string">&quot;Error opening /setting AOF rewrite IPC pipes: %s&quot;</span>,
        strerror(errno));
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">6</span>; j++) <span class="hljs-keyword">if</span>(fds[j] != <span class="hljs-number">-1</span>) close(fds[j]);
    <span class="hljs-keyword">return</span> C_ERR;
&#125;</code></pre></div><p>åœ¨ <code>aofCreatePipes</code> å‡½æ•°ä¸­ï¼Œå¯¹ pipe è¿›è¡Œåˆå§‹åŒ–ï¼Œpipe å„å˜é‡çš„ç”¨å¤„ä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸€å…±æœ‰ä¸‰æ¡ pipeï¼Œæ¯æ¡ pipe ä¸€æ¥ä¸€å›ï¼Œå ç”¨ä¸¤ä¸ª fdã€‚</p><p>pipe 1 ç”¨äºçˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹å‘é€ç¼“å­˜çš„æ–°æ•°æ®ã€‚å­è¿›ç¨‹åœ¨ aofrewrite æ—¶ï¼Œä¼šå®šæœŸä»è¯¥ç®¡é“ä¸­è¯»å–æ•°æ®å¹¶ç¼“å­˜èµ·æ¥ï¼Œå¹¶åœ¨æœ€åå°†ç¼“å­˜çš„æ•°æ®å†™å…¥é‡å†™çš„æ–° AOF æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ª fd éƒ½è®¾ç½®ä¸ºéé˜»å¡å¼çš„ã€‚</p><p>pipe 2 è´Ÿè´£å­è¿›ç¨‹å‘çˆ¶è¿›ç¨‹å‘é€ç»“æŸä¿¡å·ã€‚çˆ¶è¿›ç¨‹ç›‘å¬ <strong>fds[2]</strong> è¯»äº‹ä»¶ï¼Œå›è°ƒå‡½æ•°ä¸º <strong>aofChildPipeReadable</strong>ã€‚çˆ¶è¿›ç¨‹ä¸æ–­åœ°æ¥æ”¶å®¢æˆ·ç«¯å‘½ä»¤ï¼Œä½†æ˜¯å­è¿›ç¨‹ä¸å¯èƒ½æ— ä¼‘æ­¢åœ°ç­‰å¾…çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œå› æ­¤ï¼Œå­è¿›ç¨‹åœ¨éå†å®Œæ•°æ®åº“æ‰€æœ‰æ•°æ®ä¹‹åï¼Œä» pipe 1 ä¸­æ‰§è¡Œä¸€æ®µæ—¶é—´çš„è¯»å–æ“ä½œåï¼Œå°±ä¼šå‘ pipe 2 ä¸­å‘é€ä¸€ä¸ªç‰¹æ®Šæ ‡è®° â€œ<strong>!</strong>â€œï¼Œçˆ¶è¿›ç¨‹æ”¶åˆ°å­è¿›ç¨‹çš„ â€œ<strong>!</strong>â€œ åï¼Œå°±ä¼šç½® <strong>server.aof_stop_sending_diff</strong> ä¸º 1ï¼Œè¡¨ç¤ºä¸å†å‘çˆ¶è¿›ç¨‹å‘é€ç¼“å­˜æ•°æ®äº†ã€‚</p><p>pipe 3 è´Ÿè´£çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹å‘é€åº”ç­”ä¿¡å·ã€‚çˆ¶è¿›ç¨‹æ”¶åˆ°å­è¿›ç¨‹çš„ â€œ<strong>!</strong>â€œ åï¼Œä¼šé€šè¿‡è¯¥ç®¡é“ä¹Ÿå‘å­è¿›ç¨‹åº”ç­”ä¸€ä¸ª â€œ<strong>!</strong>â€œï¼Œè¡¨ç¤ºå·²æ”¶åˆ°äº†åœæ­¢ä¿¡å·ã€‚</p><p>è¯¦ç»†è¿‡ç¨‹åé¢ä¼šç»†è¯´ã€‚</p><h3 id="çˆ¶è¿›ç¨‹å¤„ç†é€»è¾‘"><a href="# çˆ¶è¿›ç¨‹å¤„ç†é€»è¾‘" class="headerlink" title="çˆ¶è¿›ç¨‹å¤„ç†é€»è¾‘"></a>çˆ¶è¿›ç¨‹å¤„ç†é€»è¾‘</h3><h4 id="rewriteAppendOnlyFileBackground- å‡½æ•°"><a href="#rewriteAppendOnlyFileBackground- å‡½æ•°" class="headerlink" title="rewriteAppendOnlyFileBackground å‡½æ•°"></a>rewriteAppendOnlyFileBackground å‡½æ•°</h4><p>æ¥ç€ä¸Šé¢çš„é€»è¾‘ï¼Œserver <code>fork</code> å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸¤ä¸ªè¿›ç¨‹åˆ†åˆ«åšå„æœ‰ä¸åŒçš„å¤„ç†ï¼Œä¸‹é¢å…ˆçœ‹çˆ¶è¿›ç¨‹çš„ä¸€äº›ä¸»è¦å¤„ç†ï¼ˆä»£ç æœ‰åˆ å‡ï¼‰ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFileBackground</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> ((childpid = fork()) == <span class="hljs-number">0</span>) &#123;
        ... ...
    &#125; <span class="hljs-keyword">else</span> &#123;
        server.aof_rewrite_scheduled = <span class="hljs-number">0</span>;
        server.aof_child_pid = childpid;
        updateDictResizePolicy();
        server.aof_selected_db = <span class="hljs-number">-1</span>;
        replicationScriptCacheFlush();
        <span class="hljs-keyword">return</span> C_OK;
    &#125;
    ...
&#125;</code></pre></div><p><strong>server.aof_rewrite_scheduled</strong> ç½®é›¶ï¼Œé˜²æ­¢åœ¨ <code>serverCron</code> å‡½æ•°ä¸­é‡å¤è§¦å‘ aofrewriteï¼Œè¿™æ—¶å› ä¸º <code>serverCron</code> ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFileBackground</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.rdb_child_pid == <span class="hljs-number">-1</span> &amp;&amp; server.aof_child_pid == <span class="hljs-number">-1</span> &amp;&amp;
        server.aof_rewrite_scheduled)
    &#123;
        rewriteAppendOnlyFileBackground();
    &#125;
    ...
&#125;</code></pre></div><p>è¿™é‡Œï¼Œ<code>updateDictResizePolicy</code> å‡½æ•°æ‰€åšçš„æ“ä½œæ˜¯å¾ˆé‡è¦çš„ï¼Œå¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateDictResizePolicy</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (server.rdb_child_pid == <span class="hljs-number">-1</span> &amp;&amp; server.aof_child_pid == <span class="hljs-number">-1</span>)
        dictEnableResize();
    <span class="hljs-keyword">else</span>
        dictDisableResize();
&#125;</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åå°æœ‰å­è¿›ç¨‹åš aofrewrite æˆ– rdb æ—¶ï¼Œå°±ä¸è¦åš dict rehash äº†ã€‚ç°åœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨ <strong>å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼‰æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡</strong>ï¼Œæ‰€ä»¥åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´ï¼Œåº”è¯¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥ï¼Œå¦åˆ™ä¼šå¼•èµ·å¤§é‡çš„å†…å­˜ copyï¼Œå½±å“æ€§èƒ½ã€‚COW çš„çŸ¥è¯†å¯ä»¥å‚è€ƒæ–‡æ¡£ ã€Š<a target="_blank" rel="noopener" href="https://juejin.im/post/5bd96bcaf265da396b72f855">Copy On Write æœºåˆ¶äº†è§£ä¸€ä¸‹</a>ã€‹ã€‚</p><p>å¦å¤–ï¼Œ<strong>server.aof_selected_db</strong> ç½®ä¸º -1ï¼Œæ˜¯ä¸ºäº†åœ¨å­è¿›ç¨‹è¿›è¡Œæ•°æ®åº“æ‰«ææ—¶æ’å…¥ select å‘½ä»¤ï¼Œä»¥ä¾¿é€‰æ‹©æ­£ç¡®çš„æ•°æ®åº“ã€‚</p><h4 id="aofRewriteBufferAppend- å‡½æ•°"><a href="#aofRewriteBufferAppend- å‡½æ•°" class="headerlink" title="aofRewriteBufferAppend å‡½æ•°"></a>aofRewriteBufferAppend å‡½æ•°</h4><p>åœ¨ä¸Šä¸€ç¯‡åšå®¢ä¸­è¯´è¿‡ï¼Œåœ¨ <code>feedAppendOnlyFile</code> å‡½æ•° append å†™å‘½ä»¤æ—¶ï¼Œå¦‚æœå½“å‰æœ‰å­è¿›ç¨‹åœ¨åš aofrewrite æ—¶ï¼Œéœ€è¦å°†å†™å‘½ä»¤å†™åˆ° <strong>server.aof_rewrite_buf_blocks</strong> ä¸­ä¸€ä»½ã€‚è¯¥å˜é‡æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æœ€å¤§ 10MBã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">feedAppendOnlyFile</span><span class="hljs-params">(struct redisCommand *cmd, <span class="hljs-keyword">int</span> dictid, robj **argv, <span class="hljs-keyword">int</span> argc)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.aof_child_pid != <span class="hljs-number">-1</span>)
        aofRewriteBufferAppend((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)buf,sdslen(buf));
&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">aofRewriteBufferAppend</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *s, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> len)</span> </span>&#123;
    ... ...
    <span class="hljs-comment">/* Install a file event to send data to the rewrite child if there is</span>
<span class="hljs-comment">     * not one already. */</span>
    <span class="hljs-keyword">if</span> (aeGetFileEvents(server.el,server.aof_pipe_write_data_to_child) == <span class="hljs-number">0</span>) &#123;
        aeCreateFileEvent(server.el, server.aof_pipe_write_data_to_child,
            AE_WRITABLE, aofChildWriteDiffData, <span class="hljs-literal">NULL</span>);
    &#125;
&#125;</code></pre></div><p>ä¸º <strong>server.aof_pipe_write_data_to_child</strong> æ³¨å†Œå†™äº‹ä»¶ï¼Œå›è°ƒå‡½æ•°ä¸º <code>aofChildWriteDiffData</code>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">aofChildWriteDiffData</span><span class="hljs-params">(aeEventLoop *el, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">int</span> mask)</span> </span>&#123;
    listNode *ln;
    aofrwblock *block;
    <span class="hljs-keyword">ssize_t</span> nwritten;
    UNUSED(el);
    UNUSED(fd);
    UNUSED(privdata);
    UNUSED(mask);

    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;
        ln = listFirst(server.aof_rewrite_buf_blocks);
        block = ln ? ln-&gt;value : <span class="hljs-literal">NULL</span>;
        <span class="hljs-keyword">if</span> (server.aof_stop_sending_diff || !block) &#123;
            aeDeleteFileEvent(server.el,server.aof_pipe_write_data_to_child,
                              AE_WRITABLE);
            <span class="hljs-keyword">return</span>;
        &#125;
        <span class="hljs-keyword">if</span> (block-&gt;used &gt; <span class="hljs-number">0</span>) &#123;
            nwritten = write(server.aof_pipe_write_data_to_child,
                             block-&gt;buf,block-&gt;used);
            <span class="hljs-keyword">if</span> (nwritten &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
            memmove(block-&gt;buf,block-&gt;buf+nwritten,block-&gt;used-nwritten);
            block-&gt;used -= nwritten;
        &#125;
        <span class="hljs-keyword">if</span> (block-&gt;used == <span class="hljs-number">0</span>) listDelNode(server.aof_rewrite_buf_blocks,ln);
    &#125;
&#125;</code></pre></div><p>å½“å­è¿›ç¨‹å‘Šè¯‰çˆ¶è¿›ç¨‹ä¸è¦å‘æ•°æ®ï¼ˆ<strong>server.aof_stop_sending_diff = 1</strong>ï¼‰æˆ–è€… <strong>server.aof_rewrite_buf_blocks</strong> ä¸ºç©ºæ—¶ï¼Œåˆ é™¤å†™äº‹ä»¶ã€‚</p><p>å¦åˆ™ï¼Œå¾€ pipe1 ä¸­å†™å…¥æ•°æ®ï¼Œç„¶åå†™å…¥çš„æ•°æ®ä» <strong>server.aof_rewrite_buf_blocks</strong> åˆ æ‰ã€‚</p><h3 id="å­è¿›ç¨‹å¤„ç†é€»è¾‘"><a href="# å­è¿›ç¨‹å¤„ç†é€»è¾‘" class="headerlink" title="å­è¿›ç¨‹å¤„ç†é€»è¾‘"></a>å­è¿›ç¨‹å¤„ç†é€»è¾‘</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFileBackground</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">char</span> tmpfile[<span class="hljs-number">256</span>];
    closeListeningSockets(<span class="hljs-number">0</span>);               <span class="hljs-comment">/* child å…³é—­ä¸å¿…è¦çš„ socket */</span>
    redisSetProcTitle(<span class="hljs-string">&quot;redis-aof-rewrite&quot;</span>); <span class="hljs-comment">/* ä¿®æ”¹è¿›ç¨‹åä¸º redis-aof-rewrite */</span>
    <span class="hljs-built_in">snprintf</span>(tmpfile,<span class="hljs-number">256</span>,<span class="hljs-string">&quot;temp-rewriteaof-bg-%d.aof&quot;</span>, (<span class="hljs-keyword">int</span>) getpid());
    ...
&#125;</code></pre></div><p>é¦–å…ˆåšä¸€äº›å¿…è¦çš„å¤„ç†ï¼Œä¸´æ—¶ AOF æ–‡ä»¶åä¸º <strong>temp-rewriteaof-bg-%d.aof</strong>ã€‚</p><p>ç„¶åè¿›å…¥æ­£å¼çš„å¤„ç†å‡½æ•° <code>rewriteAppendOnlyFile</code>ï¼Œä»¥ä¸‹è´´ä¸Šä¸»è¦ä»£ç ï¼ˆæœ‰åˆ å‡ï¼‰ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span> </span>&#123;
    ...
    <span class="hljs-built_in">snprintf</span>(tmpfile,<span class="hljs-number">256</span>,<span class="hljs-string">&quot;temp-rewriteaof-%d.aof&quot;</span>, (<span class="hljs-keyword">int</span>) getpid());
    fp = fopen(tmpfile,<span class="hljs-string">&quot;w&quot;</span>);
    server.aof_child_diff = sdsempty(); <span class="hljs-comment">/* åˆå§‹åŒ– aof_child_diff */</span>
    ...
&#125;</code></pre></div><p><strong>aof_child_diff</strong> å˜é‡ä¸­å­˜æ”¾åœ¨ aofwrite æœŸé—´ï¼Œå­è¿›ç¨‹æ¥æ”¶åˆ°çˆ¶è¿›ç¨‹é€šè¿‡ pipe ä¼ è¿‡æ¥çš„ç¼“å­˜æ•°æ®ã€‚</p><p>ç„¶åå°±æ˜¯æ‰«ææ•°æ®åº“çš„æ“ä½œã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span> </span>&#123;
    ...
    rio aof;
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; server.dbnum; j++) &#123;
        redisDb *db = server.db+j;
        dict *d = db-&gt;dict;
        <span class="hljs-keyword">if</span> (dictSize(d) == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// skip empty database</span>
        di = dictGetSafeIterator(d);
        <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) &#123;
            ... ...
            <span class="hljs-keyword">if</span> (aof.processed_bytes &gt; processed+<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>) &#123; <span class="hljs-comment">// 10K</span>
                processed = aof.processed_bytes;
                aofReadDiffFromParent();
            &#125;
        &#125;
        dictReleaseIterator(di);
        di = <span class="hljs-literal">NULL</span>;
    &#125;
    <span class="hljs-keyword">if</span> (fflush(fp) == EOF) <span class="hljs-keyword">goto</span> werr;
    <span class="hljs-keyword">if</span> (fsync(fileno(fp)) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> werr;
    ...
&#125;</code></pre></div><p>ä»¥ä¸Šé€»è¾‘é‡Œï¼Œå­è¿›ç¨‹ä¼šæŒ¨ä¸ª db æ‰«ææ¯ä¸€ä¸ª keyï¼Œæ ¹æ® key çš„ç±»å‹ä½¿ç”¨ä¸åŒçš„å‡½æ•°è¿›è¡Œæ•°æ®é‡å†™ï¼Œå¸¦è¿‡æœŸæ—¶é—´çš„æ•°æ®ï¼Œéƒ½éœ€è¦ append ä¸€ä¸ª <strong>PEXPIREAT</strong> å‘½ä»¤ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå‰é¢è¯´åˆ°åˆ©ç”¨ pipe ä¼˜åŒ– aofwriteï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„é€»è¾‘ï¼Œæ¯éå†ä¸€ä¸ª dbï¼Œå¦‚æœ rio å†™å…¥çš„æ•°æ®é‡è¶…è¿‡äº† <strong>10K</strong>ï¼Œé‚£ä¹ˆå°±é€šè¿‡ pipe ä»çˆ¶è¿›ç¨‹è¯»ä¸€æ¬¡æ•°æ®ï¼Œå°†æ•°æ®ç´¯åŠ åˆ° <strong>server.aof_child_diff</strong>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">aofReadDiffFromParent</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">65536</span>]; <span class="hljs-comment">/* Default pipe buffer size on most Linux systems. */</span>
    <span class="hljs-keyword">ssize_t</span> nread, total = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">while</span> ((nread = read(server.aof_pipe_read_data_from_parent,buf,<span class="hljs-keyword">sizeof</span>(buf))) &gt; <span class="hljs-number">0</span>) &#123;
        server.aof_child_diff = sdscatlen(server.aof_child_diff,buf,nread);
        total += nread;
    &#125;
    <span class="hljs-keyword">return</span> total;
&#125;</code></pre></div><p>å› ä¸ºï¼Œæœ‰å®¢æˆ·ç«¯å¯èƒ½ä¸æ–­æœ‰æµé‡æ‰“åˆ°çˆ¶è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¸å¯èƒ½ä¸€ç›´ç­‰çˆ¶è¿›ç¨‹ï¼Œæ‰€ä»¥è¦æœ‰ä¸€ä¸ªç»“æŸçš„æ—¶åˆ»ï¼Œ Redis ä¸­åšäº†å¦‚ä¸‹å†³å®šã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span> </span>&#123;
    ...
    <span class="hljs-keyword">int</span> nodata = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">mstime_t</span> start = mstime();
    <span class="hljs-keyword">while</span>(mstime()-start &lt; <span class="hljs-number">1000</span> &amp;&amp; nodata &lt; <span class="hljs-number">20</span>) &#123;
        <span class="hljs-comment">/* åœ¨ 1ms ä¹‹å†…ï¼ŒæŸ¥çœ‹ä»çˆ¶è¿›ç¨‹è¯»æ•°æ®çš„ fd æ˜¯å¦å˜æˆå¯è¯»çš„ï¼Œè‹¥ä¸å¯è¯»åˆ™ aeWait()å‡½æ•°è¿”å› 0 */</span>
        <span class="hljs-keyword">if</span> (aeWait(server.aof_pipe_read_data_from_parent, AE_READABLE, <span class="hljs-number">1</span>) &lt;= <span class="hljs-number">0</span>)
        &#123;
            nodata++;
            <span class="hljs-keyword">continue</span>;
        &#125;
        <span class="hljs-comment">// å½“ç®¡é“çš„è¯»ç«¯å¯è¯»æ—¶ï¼Œæ¸…é›¶ nodata</span>
        nodata = <span class="hljs-number">0</span>;
        aofReadDiffFromParent();
    &#125;
    ...
&#125;</code></pre></div><p>1ms è¶…æ—¶ç­‰å¾…çˆ¶è¿›ç¨‹ä» pipe ä¼ æ¥æ•°æ®ï¼Œå¦‚æœåœ¨ 1ms å†…æœ‰ 20 æ¬¡çˆ¶è¿›ç¨‹æ²¡ä¼ æ¥æ•°æ®ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒ <strong>ReadDiffFromParent</strong>ã€‚ç”±äº <strong>server.aof_pipe_read_data_from_parent</strong> åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ä¸ºéé˜»å¡ï¼Œå› æ­¤ <code>aeWait</code> è°ƒç”¨è¿”å›å¾ˆå¿«ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (write(server.aof_pipe_write_ack_to_parent,<span class="hljs-string">&quot;!&quot;</span>,<span class="hljs-number">1</span>) != <span class="hljs-number">1</span>) <span class="hljs-keyword">goto</span> werr;</code></pre></div><p>æ¥ç€é€šè¿‡ pipe2 å‘Šè¯‰çˆ¶è¿›ç¨‹ï¼ˆå‘ç‰¹æ®Šç¬¦å· ï¼ï¼‰ä¸è¦å†å‘æ¥ç¼“å­˜æ•°æ®äº†ã€‚</p><p>è¿˜è®°å¾—å‰é¢åˆå§‹åŒ–æ—¶ï¼Œçˆ¶è¿›ç¨‹ä¸€ç›´åœ¨ç›‘å¬ <strong>server.aof_pipe_read_ack_from_child</strong> çš„å¯è¯»äº‹ä»¶å§ï¼Ÿå½“æ”¶åˆ° â€œ<strong>!</strong>â€ åï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨å¤„ç†å‡½æ•° <code>aofChildPipeReadable</code>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">aofChildPipeReadable</span><span class="hljs-params">(aeEventLoop *el, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *privdata, <span class="hljs-keyword">int</span> mask)</span> </span>&#123;
    <span class="hljs-keyword">char</span> byte;
    <span class="hljs-keyword">if</span> (read(fd,&amp;byte,<span class="hljs-number">1</span>) == <span class="hljs-number">1</span> &amp;&amp; byte == <span class="hljs-string">&#x27;!&#x27;</span>) &#123;
        serverLog(LL_NOTICE,<span class="hljs-string">&quot;AOF rewrite child asks to stop sending diffs.&quot;</span>);
        server.aof_stop_sending_diff = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (write(server.aof_pipe_write_ack_to_child,<span class="hljs-string">&quot;!&quot;</span>,<span class="hljs-number">1</span>) != <span class="hljs-number">1</span>) &#123;
            serverLog(LL_WARNING,<span class="hljs-string">&quot;Can&#x27;t send ACK to AOF child: %s&quot;</span>,
                strerror(errno));
        &#125;
    &#125;
    <span class="hljs-comment">/* Remove the handler since this can be called only one time during a</span>
<span class="hljs-comment">     * rewrite. */</span>
    aeDeleteFileEvent(server.el,server.aof_pipe_read_ack_from_child,AE_READABLE);
&#125;</code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>server.aof_stop_sending_diff</code> ç½®ä¸º 1ï¼Œè¡¨ç¤ºä¸å†ç»™å­è¿›ç¨‹å‘é€ç¼“å­˜æ•°æ®ï¼Œæ¥ç€åˆ é™¤ <strong>server.aof_pipe_read_ack_from_child</strong> ä¸Šå¯è¯»äº‹ä»¶ï¼Œç»™å­è¿›ç¨‹å›å¤ä¸€ä¸ª â€œ<strong>!</strong>â€ã€‚</p><p>ç°åœ¨å›æ¥çœ‹å­è¿›ç¨‹çš„è¡Œä¸ºã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (syncRead(server.aof_pipe_read_ack_from_parent,&amp;byte,<span class="hljs-number">1</span>,<span class="hljs-number">5000</span>) != <span class="hljs-number">1</span> || byte != <span class="hljs-string">&#x27;!&#x27;</span>)
        <span class="hljs-keyword">goto</span> werr;
    ...
&#125;</code></pre></div><p>å­è¿›ç¨‹é˜»å¡ 5s ç­‰å¾…çˆ¶è¿›ç¨‹å‘æ¥ç¡®è®¤æ ‡è®° <strong>â€œ!â€</strong>ï¼Œä¹‹åå°±å¼€å§‹åšè‡ªå·±çš„æ”¶å°¾å·¥ä½œï¼Œå¦‚ä¸‹ï¼š</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rewriteAppendOnlyFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span> </span>&#123;
    ...
    aofReadDiffFromParent(); <span class="hljs-comment">/* æœ€åä¸€æ¬¡ä»çˆ¶è¿›ç¨‹ç´¯è®¡å†™å…¥çš„ç¼“å†²åŒºçš„å·®å¼‚ */</span>

    <span class="hljs-comment">/* å°†å­è¿›ç¨‹ aof_child_diff ä¸­ä¿å­˜çš„å·®å¼‚æ•°æ®å†™åˆ° AOF æ–‡ä»¶ä¸­ */</span>
    <span class="hljs-keyword">if</span> (rioWrite(&amp;aof,server.aof_child_diff,sdslen(server.aof_child_diff)) == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">goto</span> werr;

    <span class="hljs-comment">/* Make sure data will not remain on the OS&#x27;s output buffers */</span>
    <span class="hljs-keyword">if</span> (fflush(fp) == EOF) <span class="hljs-keyword">goto</span> werr;
    <span class="hljs-keyword">if</span> (fsync(fileno(fp)) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> werr;
    <span class="hljs-keyword">if</span> (fclose(fp) == EOF) <span class="hljs-keyword">goto</span> werr;

    <span class="hljs-comment">/* åŸå­æ€§ä¿®æ”¹ä¸´æ—¶æ–‡ä»¶çš„åå­—ä¸º temp-rewriteaof-bg-&lt;pid&gt;.aof */</span>
    <span class="hljs-keyword">if</span> (rename(tmpfile,filename) == <span class="hljs-number">-1</span>) &#123;
        unlink(tmpfile);
        <span class="hljs-keyword">return</span> C_ERR;
    &#125;
    ...
&#125;</code></pre></div><p>æœ€åå†è¯»å–ä¸€æ¬¡ pipe ä¸­çš„æ•°æ®ï¼Œå°†å­è¿›ç¨‹è¿›è¡Œ aofrewrite æœŸé—´ï¼Œ<strong>aof_child_diff</strong> ä»çˆ¶è¿›ç¨‹ç´¯ç§¯çš„æ•°æ®åˆ·ç›˜ï¼Œæœ€åè¿›è¡Œ <code>rename</code> ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>ç»è¿‡ä»¥ä¸Šçš„é€»è¾‘å¤„ç†ï¼Œserver äº¤ç»™å­è¿›ç¨‹çš„ aofrewrite å·¥ä½œå°±å®Œæˆäº†ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ–‡ä»¶ <strong>temp-rewriteaof-bg-<pid>.aof</pid></strong>ï¼ŒæˆåŠŸè¿”å› 0ï¼Œå¦åˆ™è¿”å› 1ã€‚</p><h3 id="çˆ¶è¿›ç¨‹çš„æ”¶å°¾å·¥ä½œ"><a href="# çˆ¶è¿›ç¨‹çš„æ”¶å°¾å·¥ä½œ" class="headerlink" title="çˆ¶è¿›ç¨‹çš„æ”¶å°¾å·¥ä½œ"></a>çˆ¶è¿›ç¨‹çš„æ”¶å°¾å·¥ä½œ</h3><p>å­è¿›ç¨‹åœ¨æ‰§è¡Œå®Œ aofrewrite åé€€å‡ºï¼Œçˆ¶è¿›ç¨‹ <code>wait3</code> åˆ°å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€åï¼Œè¿›è¡Œ aofrewrite çš„æ”¶å°¾å·¥ä½œã€‚åœ¨ <code>serverCron</code> å‡½æ•°é‡Œï¼Œæœ‰å¦‚ä¸‹é€»è¾‘ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">serverCron</span><span class="hljs-params">(struct aeEventLoop *eventLoop, <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> id, <span class="hljs-keyword">void</span> *clientData)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> ((pid = wait3(&amp;statloc,WNOHANG,<span class="hljs-literal">NULL</span>)) != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">/* wait3 ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ */</span>
        <span class="hljs-keyword">int</span> exitcode = WEXITSTATUS(statloc);
        <span class="hljs-keyword">int</span> bysignal = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);

        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>) &#123;
            serverLog(LL_WARNING,<span class="hljs-string">&quot;wait3() returned an error: %s. &quot;</span>
                      <span class="hljs-string">&quot;rdb_child_pid = %d, aof_child_pid = %d&quot;</span>,
                      strerror(errno),
                      (<span class="hljs-keyword">int</span>) server.rdb_child_pid,
                      (<span class="hljs-keyword">int</span>) server.aof_child_pid);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == server.rdb_child_pid) &#123;
            backgroundSaveDoneHandler(exitcode,bysignal);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == server.aof_child_pid) &#123; <span class="hljs-comment">/* aof å­è¿›ç¨‹ç»“æŸ */</span>
            backgroundRewriteDoneHandler(exitcode,bysignal);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">if</span> (!ldbRemoveChild(pid)) &#123;
                serverLog(LL_WARNING,
                          <span class="hljs-string">&quot;Warning, detected child with unmatched pid: %ld&quot;</span>,
                          (<span class="hljs-keyword">long</span>)pid);
            &#125;
        &#125;
        updateDictResizePolicy(); <span class="hljs-comment">/* æ›´æ–° dict resize ä¸ºå¯ç”¨çŠ¶æ€ */</span>
    &#125;
    ...
&#125;</code></pre></div><p><code>wait3</code> å‡½æ•°è¡¨ç¤ºçˆ¶è¿›ç¨‹ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹çš„è¿”å›å€¼ï¼Œ <strong>WNOHANG</strong> é€‰é¡¹è¡¨ç¤ºæ²¡æœ‰å­è¿›ç¨‹ exit æ—¶ç«‹å³è¿”å›ï¼Œman ä¸­å¯¹è¯¥é€‰é¡¹æœ‰å¦‚ä¸‹è¯´æ˜ï¼Œ â€<strong>WNOHANG return immediately if no child has exited</strong>â€œã€‚</p><p>å¯ä»¥çœ‹åˆ°å¦‚æœç­‰åˆ° aofwrite çš„å­è¿›ç¨‹ exitï¼Œé‚£ä¹ˆä½¿ç”¨ <code>backgroundRewriteDoneHandler</code> å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œä¸»è¦å¦‚ä¸‹ï¼ˆä»£ç æœ‰åˆ å‡ï¼‰ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">backgroundRewriteDoneHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> exitcode, <span class="hljs-keyword">int</span> bysignal)</span> </span>&#123;
    ...
    <span class="hljs-built_in">snprintf</span>(tmpfile,<span class="hljs-number">256</span>,<span class="hljs-string">&quot;temp-rewriteaof-bg-%d.aof&quot;</span>, (<span class="hljs-keyword">int</span>)server.aof_child_pid);
    newfd = open(tmpfile,O_WRONLY|O_APPEND);
    <span class="hljs-keyword">if</span> (aofRewriteBufferWrite(newfd) == <span class="hljs-number">-1</span>) &#123;
        close(newfd);
        <span class="hljs-keyword">goto</span> cleanup;
    &#125;
    ...
&#125;</code></pre></div><p>æ‰“å¼€å­è¿›ç¨‹ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ <strong>temp-rewriteaof-bg-<pid>.aof</pid></strong>ï¼Œè°ƒç”¨ <code>aofRewriteBufferWrite</code>ï¼Œå°†æœåŠ¡å™¨ç¼“å­˜çš„å‰©ä¸‹çš„æ–°æ•°æ®å†™å…¥è¯¥ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè¿™æ ·è¯¥ AOF ä¸´æ—¶æ–‡ä»¶å°±å®Œå…¨ä¸å½“å‰æ•°æ®åº“çŠ¶æ€ä¸€è‡´äº†ã€‚</p><p>é‚£ä¹ˆï¼Œä¸‹é¢è¿˜æœ‰ä¸¤ä»¶äº‹è¦åšï¼Œä¸€æ˜¯å°†ä¸´æ—¶ AOF æ–‡ä»¶æ”¹åï¼ŒäºŒæ˜¯åˆ‡æ¢ fdã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">backgroundRewriteDoneHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> exitcode, <span class="hljs-keyword">int</span> bysignal)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.aof_fd == <span class="hljs-number">-1</span>) &#123;
        <span class="hljs-comment">/* AOF disabled */</span>
        oldfd = open(server.aof_filename,O_RDONLY|O_NONBLOCK);
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">/* AOF enabled */</span>
        oldfd = <span class="hljs-number">-1</span>; <span class="hljs-comment">/* We&#x27;ll set this to the current AOF filedes later. */</span>
    &#125;
    <span class="hljs-keyword">if</span> (rename(tmpfile,server.aof_filename) == <span class="hljs-number">-1</span>) &#123;
        close(newfd);
        <span class="hljs-keyword">if</span> (oldfd != <span class="hljs-number">-1</span>) close(oldfd);
        <span class="hljs-keyword">goto</span> cleanup;
    &#125;

    <span class="hljs-keyword">if</span> (server.aof_fd == <span class="hljs-number">-1</span>) &#123;
        <span class="hljs-comment">/* AOF disabled, we don&#x27;t need to set the AOF file descriptor</span>
<span class="hljs-comment">         * to this new file, so we can close it. */</span>
        close(newfd);
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">/* AOF enabled, replace the old fd with the new one. */</span>
        oldfd = server.aof_fd;
        server.aof_fd = newfd;
        <span class="hljs-keyword">if</span> (server.aof_fsync == AOF_FSYNC_ALWAYS)
            aof_fsync(newfd);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (server.aof_fsync == AOF_FSYNC_EVERYSEC)
            aof_background_fsync(newfd);
        server.aof_selected_db = <span class="hljs-number">-1</span>; <span class="hljs-comment">/* Make sure SELECT is re-issued */</span>
        aofUpdateCurrentSize();
        server.aof_rewrite_base_size = server.aof_current_size;

        <span class="hljs-comment">/* Clear regular AOF buffer since its contents was just written to</span>
<span class="hljs-comment">         * the new AOF from the background rewrite buffer. */</span>
        sdsfree(server.aof_buf);
        server.aof_buf = sdsempty();
    &#125;
    ...  ...
    <span class="hljs-comment">/* Asynchronously close the overwritten AOF. */</span>
    <span class="hljs-keyword">if</span> (oldfd != <span class="hljs-number">-1</span>) bioCreateBackgroundJob(BIO_CLOSE_FILE,(<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">long</span>)oldfd,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);
    ...
&#125;</code></pre></div><p>å¦‚ä¸Šï¼Œé¦–å…ˆå°†ä¸´æ—¶ AOF æ–‡ä»¶æ”¹åï¼Œç„¶åå°±æ˜¯ oldfd å’Œ newfd çš„å¤„ç†äº†ï¼Œåˆ† <strong>ä¸¤ç§æƒ…å†µ</strong>ï¼š</p><p>å½“ AOF åŠŸèƒ½å…³é—­æ—¶ï¼Œæ‰“å¼€åŸæ¥çš„ AOF æ–‡ä»¶ï¼Œè·å¾— oldfdï¼Œè¿™é‡Œå¹¶ä¸å…³å¿ƒè¯¥æ“ä½œæ˜¯å¦æ˜¯æˆåŠŸçš„ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œé‚£ä¹ˆ oldfd å€¼ä¸º -1ï¼Œ<code>close(newfd)</code>ã€‚</p><p>å½“ AOF åŠŸèƒ½å¼€å¯æ—¶ï¼Œoldfd ç›´æ¥ç½®ä¸º -1ï¼Œå°† <strong>aof_fd</strong> åˆ‡æ¢æˆ newfdï¼Œæ ¹æ®ä¸åŒçš„æ•°æ®åˆ·ç›˜ç­–ç•¥è¿›è¡Œ AOF åˆ·ç›˜ï¼Œæ›´æ–°ç›¸åº”çš„å‚æ•°ã€‚</p><p>ç„¶åæ˜¯å…³é—­ oldfd çš„é€»è¾‘ï¼Œç”±äº oldfd å¯èƒ½æ˜¯å¯¹æ—§ AOF æ–‡ä»¶çš„æœ€åä¸€ä¸ªå¼•ç”¨ï¼Œç›´æ¥ <code>close</code> å¯èƒ½ä¼šé˜»å¡ serverï¼Œå› æ­¤åˆ›å»ºåå°ä»»åŠ¡å»å…³é—­æ–‡ä»¶ã€‚</p><p>æœ€åè¿›è¡Œæ¸…ç†å·¥ä½œï¼Œå¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">backgroundRewriteDoneHandler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> exitcode, <span class="hljs-keyword">int</span> bysignal)</span> </span>&#123;
    ...
    cleanup:
        aofClosePipes();
        aofRewriteBufferReset();
        aofRemoveTempFile(server.aof_child_pid);
        server.aof_child_pid = <span class="hljs-number">-1</span>;
        server.aof_rewrite_time_last = time(<span class="hljs-literal">NULL</span>)-server.aof_rewrite_time_start;
        server.aof_rewrite_time_start = <span class="hljs-number">-1</span>;
        <span class="hljs-comment">/* Schedule a new rewrite if we are waiting for it to switch the AOF ON. */</span>
        <span class="hljs-keyword">if</span> (server.aof_state == AOF_WAIT_REWRITE)
            server.aof_rewrite_scheduled = <span class="hljs-number">1</span>;
    ...
&#125;</code></pre></div><p>ä»¥ä¸Šï¼Œ çˆ¶è¿›ç¨‹å°±å®Œæˆäº†æ”¶å°¾å·¥ä½œï¼Œå†™å‘½ä»¤å°± <code>write</code> åˆ° newfd äº†ã€‚</p><h3 id="æ—¶åºå›¾"><a href="# æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><p>å¯ä»¥å°†ä»¥ä¸Šçˆ¶å­è¿›ç¨‹çš„äº¤äº’æ•´ç†å‡ºæ—¶åºå›¾å¦‚ä¸‹ï¼Œ</p><p><img src="http://ww1.sinaimg.cn/large/71ca8e3cly1fznp1jin66j20kk0jh77k.jpg" srcset="/img/loading.gif" alt=""></p><p>ä¸Šå›¾å‚è€ƒ <a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2018/12/06/">Redis Â· åŸç†ä»‹ç» Â· åˆ©ç”¨ç®¡é“ä¼˜åŒ– aofrewrite</a></p><h2 id="ä½•æ—¶é‡å†™"><a href="# ä½•æ—¶é‡å†™" class="headerlink" title="ä½•æ—¶é‡å†™"></a>ä½•æ—¶é‡å†™</h2><p>æœ‰ä¸¤ä¸ªæ—¶åˆ»å¯ä»¥è§¦å‘ AOF é‡å†™ã€‚</p><p>ã€1ã€‘æ‰‹åŠ¨æ‰§è¡Œ <code>BGREWRITEAOF</code> å‘½ä»¤ã€‚</p><p>ã€2ã€‘è‡ªåŠ¨æ‰§è¡Œï¼Œåœ¨ <code>serverCron</code> å‡½æ•°ä¸­æ ¹æ®ä¸€å®šé€»è¾‘è¿›è¡Œåˆ¤å®šã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">serverCron</span><span class="hljs-params">(struct aeEventLoop *eventLoop, <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> id, <span class="hljs-keyword">void</span> *clientData)</span> </span>&#123;
    ...
          <span class="hljs-comment">/* Trigger an AOF rewrite if needed */</span>
    <span class="hljs-keyword">if</span> (server.rdb_child_pid == <span class="hljs-number">-1</span> &amp;&amp; server.aof_child_pid == <span class="hljs-number">-1</span> &amp;&amp;
        server.aof_rewrite_perc &amp;&amp;
        server.aof_current_size &gt; server.aof_rewrite_min_size) <span class="hljs-comment">/* é»˜è®¤ 64M */</span>
    &#123;
        <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> base = server.aof_rewrite_base_size ? server.aof_rewrite_base_size : <span class="hljs-number">1</span>;
        <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> growth = (server.aof_current_size*<span class="hljs-number">100</span>/base) - <span class="hljs-number">100</span>;
        <span class="hljs-keyword">if</span> (growth &gt;= server.aof_rewrite_perc) &#123;
            rewriteAppendOnlyFileBackground();
        &#125;
     &#125;
&#125;</code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´ AOF æ–‡ä»¶å¤§å°è¶…è¿‡äº† <strong>server.aof_rewrite_min_size</strong>ï¼Œå¹¶ä¸”å¢é•¿ç‡å¤§äº <strong>server.aof_rewrite_perc</strong> æ—¶å°±ä¼šè§¦å‘ï¼Œå¢é•¿ç‡è®¡ç®—çš„åŸºæ•° <strong>server.aof_rewrite_base_size</strong> æ˜¯ä¸Šæ¬¡ aofrewrite ç»“æŸå AOF æ–‡ä»¶çš„å¤§å°ã€‚</p><h2 id="é™„å½•"><a href="# é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><p>å‡ ä¸ªè§£é‡Šã€‚</p><blockquote><p><strong>é˜»å¡æ¨¡å¼ </strong>ä¸‹ï¼Œè¿›ç¨‹æˆ–æ˜¯çº¿ç¨‹æ‰§è¡Œåˆ°è¿™äº›å‡½æ•°æ—¶å¿…é¡»ç­‰å¾…æŸä¸ªäº‹ä»¶çš„å‘ç”Ÿï¼Œå¦‚æœäº‹ä»¶æ²¡æœ‰å‘ç”Ÿï¼Œè¿›ç¨‹æˆ–çº¿ç¨‹å°±è¢«é˜»å¡(æ­»ç­‰åœ¨è¢«é˜»å¡çš„åœ°æ–¹)ï¼Œå‡½æ•°ä¸ä¼šç«‹å³è¿”å›ã€‚</p><p><strong>éé˜»å¡ non-block æ¨¡å¼ </strong>ä¸‹ï¼Œè¿›ç¨‹æˆ–çº¿ç¨‹æ‰§è¡Œæ­¤å‡½æ•°æ—¶ä¸å¿…éè¦ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿï¼Œä¸€æ—¦æ‰§è¡Œè‚¯å®šè¿”å›ï¼Œä»¥è¿”å›å€¼çš„ä¸åŒæ¥åæ˜ å‡½æ•°çš„æ‰§è¡Œæƒ…å†µï¼Œå¦‚æœäº‹ä»¶å‘ç”Ÿåˆ™ä¸é˜»å¡æ–¹å¼ç›¸åŒï¼Œè‹¥äº‹ä»¶æ²¡æœ‰å‘ç”Ÿåˆ™è¿”å›ä¸€ä¸ªä»£ç æ¥å‘ŠçŸ¥äº‹ä»¶æœªå‘ç”Ÿï¼Œè€Œè¿›ç¨‹æˆ–çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥éé˜»å¡æ¨¡å¼æ•ˆç‡è¾ƒé«˜ã€‚</p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/54df012b.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis æºç ä¹‹æ•…éšœè½¬ç§»</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/fd3e9e30.html"><span class="hidden-mobile">Redis æŒä¹…åŒ–ä¹‹ AOF</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis æŒä¹…åŒ–ä¹‹ AOF é‡å†™&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>