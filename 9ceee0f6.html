<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis æºç ä¹‹ Bio - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2018-10-29 12:35" pubdate>2018-10-29 12:35</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.8k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 23 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis æºç ä¹‹ Bio</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2018-10-29 12:35</p><div class="markdown-body" id="post-body"><p>å¾ˆå¤šäººæåˆ° Redis æ—¶éƒ½ä¼šè®²è¿™æ˜¯ä¸€ä¸ª <strong>å•çº¿ç¨‹ </strong>çš„å†…å­˜æ•°æ®åº“ï¼Œå…¶å®ä¸ç„¶ã€‚è™½ç„¶ Redis æŠŠå¤„ç†ç½‘ç»œæ”¶å‘å’Œæ‰§è¡Œå‘½ä»¤è¿™äº›æ“ä½œéƒ½æ”¾åœ¨äº†ä¸»å·¥ä½œçº¿ç¨‹ï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–è¿˜æœ‰è®¸å¤š bio åå°çº¿ç¨‹ä¹Ÿåœ¨å…¢å…¢ä¸šä¸šçš„å·¥ä½œç€ï¼Œæ¯”å¦‚ç”¨æ¥å¤„ç†å…³é—­æ–‡ä»¶å’Œåˆ·ç›˜è¿™äº›æ¯”è¾ƒé‡çš„ IO æ“ä½œã€‚bioï¼Œå³ Background I/Oã€‚</p><p>Redis æºç ä¸­å…³äº bio çš„éƒ¨åˆ†ï¼Œä¸»è¦åœ¨ <code>bio.h</code> å’Œ <code>bio.c</code> è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚</p><!--more----><h3 id="ä»»åŠ¡ç±»å‹"><a href="# ä»»åŠ¡ç±»å‹" class="headerlink" title="ä»»åŠ¡ç±»å‹"></a>ä»»åŠ¡ç±»å‹</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">/* Background job opcodes */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BIO_CLOSE_FILE    0 <span class="hljs-comment">/* Deferred close(2) syscall. */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BIO_AOF_FSYNC     1 <span class="hljs-comment">/* Deferred AOF fsync. */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BIO_NUM_OPS       2</span></code></pre></div><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ 3.2 çš„ç‰ˆæœ¬çš„ redis ä¸­ Bio è´Ÿè´£ä¸¤ç§ç±»å‹ä»»åŠ¡ã€‚ä¸€æ˜¯å…³é—­æ–‡ä»¶ï¼ŒäºŒæ˜¯ aof æŒä¹…åŒ–ã€‚4.x çš„ç‰ˆæœ¬å¢åŠ äº†æƒ°æ€§åˆ é™¤çš„ä»»åŠ¡ã€‚æ¯ç§ç±»å‹çš„ä»»åŠ¡éƒ½æœ‰å•ç‹¬çš„çº¿ç¨‹å»å¤„ç†ï¼Œå¹¶é…ç½®ç›¸å…³çš„é”å’Œæ¡ä»¶å˜é‡ç”¨äºåŒæ­¥ã€‚åŒä¸€ç±»å‹çš„ä»»åŠ¡ç»„æˆ listï¼ŒæŒ‰ <strong>FIFO</strong> çš„é¡ºåºæ‰§è¡Œã€‚</p><p>æºç ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// ä»»åŠ¡çº¿ç¨‹æ•°ç»„</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">pthread_t</span> bio_threads[BIO_NUM_OPS];
<span class="hljs-comment">// é”</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">pthread_mutex_t</span> bio_mutex[BIO_NUM_OPS];
<span class="hljs-comment">// æ¡ä»¶å˜é‡</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">pthread_cond_t</span> bio_condvar[BIO_NUM_OPS];
<span class="hljs-comment">// ä»»åŠ¡ list æ•°ç»„</span>
<span class="hljs-keyword">static</span> <span class="hljs-built_in">list</span> *bio_jobs[BIO_NUM_OPS];
<span class="hljs-comment">// pending çš„ä»»åŠ¡æ•°é‡</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> bio_pending[BIO_NUM_OPS];</code></pre></div><p>Job çš„æ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œåœ¨æºç ä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_job</span> &#123;</span>
    <span class="hljs-keyword">time_t</span> time; <span class="hljs-comment">/* Time at which the job was created. */</span>
    <span class="hljs-keyword">void</span> *arg1, *arg2, *arg3;
&#125;;</code></pre></div><p>å…¶ä»–æœ‰ç”¨çš„å®å®šä¹‰</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REDIS_THREAD_STACK_SIZE (1024*1024*4)</span></code></pre></div><h3 id="API- è¯¦è§£"><a href="#API- è¯¦è§£" class="headerlink" title="API è¯¦è§£"></a>API è¯¦è§£</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioInit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioCreateBackgroundJob</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type, <span class="hljs-keyword">void</span> *arg1, <span class="hljs-keyword">void</span> *arg2, <span class="hljs-keyword">void</span> *arg3)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-title">bioPendingJobsOfType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioKillThreads</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioWaitPendingJobsLE</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> num)</span></span>; <span class="hljs-comment">// æœ¬ç‰ˆæœ¬æœªå®ç°</span>
<span class="hljs-function"><span class="hljs-keyword">time_t</span> <span class="hljs-title">bioOlderJobOfType</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type)</span></span>; <span class="hljs-comment">// æœ¬ç‰ˆæœ¬æœªå®ç°</span></code></pre></div><h4 id="bioInit- åˆå§‹åŒ–"><a href="#bioInit- åˆå§‹åŒ–" class="headerlink" title="bioInit åˆå§‹åŒ–"></a>bioInit åˆå§‹åŒ–</h4><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioInit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">pthread_attr_t</span> attr;
    <span class="hljs-keyword">pthread_t</span> thread;
    <span class="hljs-keyword">size_t</span> stacksize;
    <span class="hljs-keyword">int</span> j;

    <span class="hljs-comment">// åˆå§‹åŒ–å„ä»»åŠ¡ç±»å‹çš„é”å’Œæ¡ä»¶å˜é‡, BIO_NUM_OPS ä¸ª</span>
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; BIO_NUM_OPS; j++) &#123;
        pthread_mutex_init(&amp;bio_mutex[j],<span class="hljs-literal">NULL</span>);
        pthread_cond_init(&amp;bio_condvar[j],<span class="hljs-literal">NULL</span>);
        bio_jobs[j] = listCreate();
        bio_pending[j] = <span class="hljs-number">0</span>;
    &#125;

    <span class="hljs-comment">// è®¾ç½® stack å¤§å°ï¼Œå› ä¸ºæŸäº›ç³»ç»Ÿé»˜è®¤å€¼å¯èƒ½å¾ˆå°</span>
    pthread_attr_init(&amp;attr);
    pthread_attr_getstacksize(&amp;attr,&amp;stacksize);
    <span class="hljs-keyword">if</span> (!stacksize) stacksize = <span class="hljs-number">1</span>; <span class="hljs-comment">/* The world is full of Solaris Fixes */</span>
    <span class="hljs-keyword">while</span> (stacksize &lt; REDIS_THREAD_STACK_SIZE) stacksize *= <span class="hljs-number">2</span>;
    pthread_attr_setstacksize(&amp;attr, stacksize);

    <span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹ã€‚</span>
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; BIO_NUM_OPS; j++) &#123;
        <span class="hljs-keyword">void</span> *arg = (<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) j;
        <span class="hljs-keyword">if</span> (pthread_create(&amp;thread,&amp;attr,bioProcessBackgroundJobs,arg) != <span class="hljs-number">0</span>) &#123;
            serverLog(LL_WARNING,<span class="hljs-string">&quot;Fatal: Can&#x27;t initialize Background Jobs.&quot;</span>);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
        &#125;
        bio_threads[j] = thread;
    &#125;
&#125;</code></pre></div><p>ä¸Šé¢åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œå›è°ƒå‡½æ•° <code>bioProcessBackgroundJobs</code>ä¼ å…¥ä¸€ä¸ªå‚æ•°æ¥ä»£è¡¨ job ç±»å‹ï¼Œè¿™æ ·æ–¹ä¾¿æ‰¾åˆ°ç›¸åº”çš„çº¿ç¨‹å¤„ç†ä¸åŒçš„ä»»åŠ¡ï¼Œåƒä¸Šé¢è¯´çš„é‚£æ · ï¼Œ 0 è¡¨ç¤ºæ–‡ä»¶å…³é—­ä»»åŠ¡ï¼Œ 1 è¡¨ç¤º aof ä»»åŠ¡ã€‚</p><h4 id="bioProcessBackgroundJobs- ä»»åŠ¡å¤„ç†"><a href="#bioProcessBackgroundJobs- ä»»åŠ¡å¤„ç†" class="headerlink" title="bioProcessBackgroundJobs ä»»åŠ¡å¤„ç†"></a>bioProcessBackgroundJobs ä»»åŠ¡å¤„ç†</h4><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">bioProcessBackgroundJobs</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>&#123;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_job</span> *<span class="hljs-title">job</span>;</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> type = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) arg;<span class="hljs-comment">// ä¼ å…¥å‚æ•°ä¸º job type</span>
    <span class="hljs-keyword">sigset_t</span> sigset;

    <span class="hljs-comment">// æ£€æŸ¥ä¼ å…¥ type çš„åˆç†æ€§</span>
    <span class="hljs-keyword">if</span> (type &gt;= BIO_NUM_OPS) &#123;
        serverLog(LL_WARNING, <span class="hljs-string">&quot;Warning: bio thread started with wrong type %lu&quot;</span>,type);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    &#125;

    <span class="hljs-comment">// è®¾ç½®çº¿ç¨‹å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨ pthread_cancel å‡½æ•°å–æ¶ˆ / ç»ˆæ­¢ ï¼ˆå…¶ä»–çº¿ç¨‹å‘æ¥ cancel è¯·æ±‚ï¼‰</span>
    pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// è®¾ç½®æœ¬çº¿ç¨‹å¯¹ cancel ä¿¡å·çš„ååº”</span>
    <span class="hljs-comment">// æ”¶åˆ°ä¿¡å·åç»§ç»­è¿è¡Œè‡³ä¸‹ä¸€ä¸ªå–æ¶ˆç‚¹å†é€€å‡ºï¼Œé»˜è®¤æ˜¯ç«‹å³é€€å‡ºï¼Œä¸ PTHREAD_CANCEL_ENABLE é…åˆä½¿ç”¨</span>
    pthread_setcanceltype(PTHREAD_CANCEL_ASYNCHRONOUS, <span class="hljs-literal">NULL</span>);

    pthread_mutex_lock(&amp;bio_mutex[type]);
    <span class="hljs-comment">// é˜»å¡ SIGALRMï¼Œ ç¡®ä¿åªæœ‰ä¸»çº¿ç¨‹å°†æ”¶åˆ° watchdog ä¿¡å·</span>
    sigemptyset(&amp;sigset);
    sigaddset(&amp;sigset, SIGALRM);
    <span class="hljs-keyword">if</span> (pthread_sigmask(SIG_BLOCK, &amp;sigset, <span class="hljs-literal">NULL</span>))
        serverLog(LL_WARNING,
            <span class="hljs-string">&quot;Warning: can&#x27;t mask SIGALRM in bio.c thread: %s&quot;</span>, strerror(errno));

    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;
        listNode *ln;

        <span class="hljs-comment">// å½“æ²¡æœ‰ type ç±»å‹çš„ä»»åŠ¡æ—¶ï¼Œä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…æ¡ä»¶å˜é‡è§¦å‘ï¼Œè¿™é‡Œä¼šé‡Šæ”¾é”</span>
        <span class="hljs-comment">// å½“è¢«æ¿€æ´»åä»¬é¦–å…ˆè¦åŠ é”</span>
        <span class="hljs-keyword">if</span> (listLength(bio_jobs[type]) == <span class="hljs-number">0</span>) &#123;
            pthread_cond_wait(&amp;bio_condvar[type],&amp;bio_mutex[type]);
            <span class="hljs-keyword">continue</span>;
        &#125;
        <span class="hljs-comment">// ä»è¿™ç§ä»»åŠ¡çš„ list ä¸­å–å‡ºæ¥ä¸€ä¸ª</span>
        ln = listFirst(bio_jobs[type]);
        job = ln-&gt;value;
        pthread_mutex_unlock(&amp;bio_mutex[type]);

        <span class="hljs-comment">// ä¸åŒç±»å‹çš„ job åšä¸åŒçš„å¤„ç†</span>
        <span class="hljs-keyword">if</span> (type == BIO_CLOSE_FILE) &#123;
            close((<span class="hljs-keyword">long</span>)job-&gt;arg1);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == BIO_AOF_FSYNC) &#123;
            aof_fsync((<span class="hljs-keyword">long</span>)job-&gt;arg1);
        &#125; <span class="hljs-keyword">else</span> &#123;
            serverPanic(<span class="hljs-string">&quot;Wrong job type in bioProcessBackgroundJobs().&quot;</span>);
        &#125;
        zfree(job);

        <span class="hljs-comment">/*</span>
<span class="hljs-comment">         * ä¸‹ä¸€æ¬¡å¾ªç¯å‰éœ€è¦å†ä¸€æ¬¡åŠ é”</span>
<span class="hljs-comment">         * å¦‚æœæ²¡æœ‰ç›¸åº”çš„ jobï¼Œå°†å†ä¸€æ¬¡åœ¨ pthread_cond_wait() é˜»å¡ä½ã€‚</span>
<span class="hljs-comment">         */</span>
        pthread_mutex_lock(&amp;bio_mutex[type]);
        listDelNode(bio_jobs[type],ln); <span class="hljs-comment">// åˆ æ‰æ‰§è¡Œè¿‡çš„ job</span>
        bio_pending[type]--; <span class="hljs-comment">// è¿™ç§ç±»å‹è¿˜æ²¡æœ‰å‡ºæ¥ job æ•°å‡å» 1</span>
    &#125;
&#125;
</code></pre></div><p>ä»¥ä¸Šæ˜¯ bio å¤„ç† job çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸æ–­åœ°å–åˆ° job è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹éœ€è¦å‚è€ƒç€ä»¥ä¸‹æ–°åŠ æŸç§ç±»å‹çš„ä¸€ä¸ª job æ¥çœ‹ã€‚</p><h4 id="bioCreateBackgroundJob- åˆ›å»º -job"><a href="#bioCreateBackgroundJob- åˆ›å»º -job" class="headerlink" title="bioCreateBackgroundJob åˆ›å»º job"></a>bioCreateBackgroundJob åˆ›å»º job</h4><p>ä¸‹é¢çš„å‡½æ•°å°†åˆ›å»ºä¸€ä¸ªç‰¹å®šç±»å‹çš„ jobï¼Œ å¹¶æ”¾å…¥ç›¸åº”çš„ job list ä¸­ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bioCreateBackgroundJob</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type, <span class="hljs-keyword">void</span> *arg1, <span class="hljs-keyword">void</span> *arg2, <span class="hljs-keyword">void</span> *arg3)</span> </span>&#123;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_job</span> *<span class="hljs-title">job</span> = <span class="hljs-title">zmalloc</span>(<span class="hljs-title">sizeof</span>(*<span class="hljs-title">job</span>));</span>
    job-&gt;time = time(<span class="hljs-literal">NULL</span>);
    job-&gt;arg1 = arg1;
    job-&gt;arg2 = arg2;
    job-&gt;arg3 = arg3;

    pthread_mutex_lock(&amp;bio_mutex[type]); <span class="hljs-comment">// åŠ é”</span>
    listAddNodeTail(bio_jobs[type],job); <span class="hljs-comment">// å°†æ–°çš„ job æ”¾åˆ°å¯¹åº” job queue ä¸­</span>
    bio_pending[type]++;
    pthread_cond_signal(&amp;bio_condvar[type]); <span class="hljs-comment">// æ¡ä»¶å˜é‡é€šçŸ¥æœ‰æ–°çš„ job äº§ç”Ÿ</span>
    pthread_mutex_unlock(&amp;bio_mutex[type]);<span class="hljs-comment">// è§£é”</span>
&#125;</code></pre></div><p>åœ¨è¯¥ç‰ˆæœ¬çš„æºç ä¸­ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨åˆ°äº† <code>bioCreateBackgroundJob</code> è¿™ä¸ªå‡½æ•°ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// æ‰§è¡Œ fsync() åˆ·ç›˜çš„åå°ä»»åŠ¡</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">aof_background_fsync</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span> </span>&#123;
    bioCreateBackgroundJob(BIO_AOF_FSYNC,(<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">long</span>)fd,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);
&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// å¼‚æ­¥å…³é—­é‡å†™çš„ aof æ–‡ä»¶</span>
<span class="hljs-keyword">if</span> (oldfd != <span class="hljs-number">-1</span>) &#123;
    bioCreateBackgroundJob(BIO_CLOSE_FILE,(<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">long</span>)oldfd,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);
&#125;
</code></pre></div><p>å¯ä»¥å‘ç°è¿™ä¸ªç”¨ä¾‹ä¸­ï¼Œåˆ›å»º job çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ä¸€ä¸ª fdï¼Œå…¶ä»–å‚æ•°éƒ½ç½®ç©ºäº†ã€‚</p><h3 id="ä¸€ä¸ªå®Œæ•´çš„ -bio- ä»»åŠ¡å¤„ç†è¿‡ç¨‹"><a href="# ä¸€ä¸ªå®Œæ•´çš„ -bio- ä»»åŠ¡å¤„ç†è¿‡ç¨‹" class="headerlink" title="ä¸€ä¸ªå®Œæ•´çš„ bio ä»»åŠ¡å¤„ç†è¿‡ç¨‹"></a>ä¸€ä¸ªå®Œæ•´çš„ bio ä»»åŠ¡å¤„ç†è¿‡ç¨‹</h3><p>é¦–å…ˆæœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œè°ƒç”¨ <code>bioInit</code> å‡½æ•°ï¼Œè¿›è¡Œä¸åŒç±»å‹ job çº¿ç¨‹ã€é”ã€æ¡ä»¶å˜é‡ç­‰çš„åˆå§‹åŒ–ï¼Œæ¯ç§ç±»å‹ job æœ‰è‡ªå·±çš„å¤„ç†çº¿ç¨‹ï¼Œåˆå§‹åŒ–æ—¶ä¼šæ³¨å†Œå›è°ƒå‡½æ•° <code>bioProcessBackgroundJobs</code> å¤„ç†å„ç§ jobã€‚</p><p>è¿˜æ²¡æœ‰ job æ—¶ï¼Œå„ä¸ª job å¤„ç†æµç¨‹åœ¨ç»è¿‡ <code>pthread_mutex_lock(&amp;bio_mutex[type])</code> çš„åŠ é”åï¼Œåœ¨ job å¤„ç†å¾ªç¯ä¸­ <code>pthread_cond_wait(&amp;bio_condvar[type],&amp;bio_mutex[type])</code> å¤„é˜»å¡ä½ï¼Œéšä¹‹ <strong>é‡Šæ”¾é” </strong><code>bio_mutex[type]</code>, <code>pthread_cond_wait</code> åœ¨é˜»å¡æ—¶ï¼Œä¼šé‡Šæ”¾é”ï¼Œæ‰€ä»¥åœ¨<strong> ä½¿ç”¨å‰éœ€è¦å…ˆåŠ é”</strong>ã€‚</p><p>è¿™æ—¶åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºæŸä¸ªç±»å‹çš„ jobï¼Œåˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå…ˆåŠ é” <code>pthread_mutex_lock(&amp;bio_mutex[type])</code>, ç„¶åå¾€æŸç§ç±»å‹çš„ job list ä¸­ æ–°åŠ ä¸€ä¸ª jobã€‚æ¥ç€ä¸»çº¿ç¨‹é€šçŸ¥ bio å»å¤„ç†è¿™ä¸ª jobï¼Œ<code>pthread_cond_signal(&amp;bio_condvar[type])</code>ã€‚</p><p>è¯¥ç±»å‹ job çš„åå°å¤„ç†çº¿ç¨‹ä»é˜»å¡ä¸­è¢«å”¤é†’ï¼Œå®ƒä¼šå»åŠ é”ï¼Œä½†æ˜¯ç”±äºåœ¨ä¸»çº¿ç¨‹ä¸­ <code>bio_mutex[type]</code> è¿™æŠŠé”è¿˜æ²¡æœ‰å¾—åˆ°é‡Šæ”¾ï¼Œå› æ­¤ä¼šç»§ç»­é˜»å¡ã€‚</p><p>æ¥ç€ï¼Œä¸»çº¿ç¨‹é‡Šæ”¾äº†é” <code>pthread_mutex_unlock(&amp;bio_mutex[type])</code>ï¼Œbio çº¿ç¨‹è¿›è¡ŒåŠ é”ï¼Œè¿™ä¸ªç”± <code>pthread_cond_wait</code> å®Œæˆçš„ã€‚ç„¶å <code>continue</code> è¿›å…¥ä¸‹æ¬¡å¾ªç¯ï¼Œåœ¨å–åˆ° job å <code>job = ln-&gt;value</code> è¿›è¡Œè§£é”ã€‚æ‰§è¡Œäº† job ä¹‹åï¼Œåœ¨è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ä¹‹å‰ <strong>å†æ¬¡åŠ é”</strong>ã€‚</p><h3 id="è¡¥å……"><a href="# è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_cond_wait</span><span class="hljs-params">(<span class="hljs-keyword">pthread_cond_t</span> *<span class="hljs-keyword">restrict</span> cond, <span class="hljs-keyword">pthread_mutex_t</span> *<span class="hljs-keyword">restrict</span> mutex)</span></span>;</code></pre></div><p>è¿™ä¸ªå‡½æ•°çš„ç†è§£å¾ˆé‡è¦ã€‚</p><p>åœ¨æ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™, è°ƒç”¨è¯¥å‡½æ•°è¿›å…¥ç­‰å¾…ã€‚ å½“æ¡ä»¶æ»¡è¶³çš„æ—¶å€™, è¯¥å‡½æ•°ä¼šåœæ­¢ç­‰å¾…, ç»§ç»­æ‰§è¡Œã€‚</p><p>è¯¥å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>pthread_mutex_t</code> ç±»å‹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ¡ä»¶åˆ¤æ–­çš„æ—¶å€™, éœ€è¦ <strong>å…ˆè¿›è¡ŒåŠ é”æ¥é˜²æ­¢å‡ºç°é”™è¯¯ </strong>ï¼Œåœ¨æ‰§è¡Œè¯¥å‡½æ•°å‰éœ€è¦ä¸»åŠ¨å¯¹è¿™ä¸ªå˜é‡æ‰§è¡ŒåŠ é”æ“ä½œï¼Œè¿›å…¥è¿™ä¸ªå‡½æ•°ä»¥åï¼Œ <strong>å…¶å†…éƒ¨ä¼šå¯¹ mutex è¿›è¡Œè§£é”æ“ä½œ</strong>ï¼Œè€Œå‡½æ•°æ‰§è¡Œå®Œä»¥å(ä¹Ÿå°±æ˜¯åœæ­¢é˜»å¡ä»¥å)ï¼Œåˆä¼šé‡æ–°åŠ é”ã€‚</p><p>è¯¥å‡½æ•°ä¹Ÿæœ‰å¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ç‰ˆæœ¬ã€‚</p><h3 id="æ€»ç»“"><a href="# æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œredis bio å…¶å®æ˜¯ä¸€ä¸ª C è¯­è¨€å¤šçº¿ç¨‹ç¼–ç¨‹å¾ˆå¥½çš„ä¾‹å­ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/35a9decf.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis æºç ä¹‹å¯åŠ¨æµç¨‹</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/d68bbf73.html"><span class="hidden-mobile">Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ dict</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis æºç ä¹‹ Bio&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>