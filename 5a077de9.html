<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis æºç åˆ†æä¹‹ key è¿‡æœŸ - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-04-06 19:47" pubdate>2020-04-06 19:47</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 39 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis æºç åˆ†æä¹‹ key è¿‡æœŸ</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2020-04-06 19:47</p><div class="markdown-body" id="post-body"><p>redis æ”¯æŒ key çº§åˆ«çš„è¿‡æœŸè®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ <code>EXPIRE</code> ç›¸å…³çš„å‘½ä»¤å¯¹æ­¤è¿›è¡Œè®¾ç½®ï¼ŒåŒæ—¶æ”¯æŒç›¸å¯¹æ—¶é—´å’Œç»å¯¹æ—¶é—´ä¸¤ç§æ–¹å¼ã€‚</p><!--more----><h2 id="è®¾ç½®è¿‡æœŸæ—¶é—´å‘½ä»¤"><a href="# è®¾ç½®è¿‡æœŸæ—¶é—´å‘½ä»¤" class="headerlink" title="è®¾ç½®è¿‡æœŸæ—¶é—´å‘½ä»¤"></a>è®¾ç½®è¿‡æœŸæ—¶é—´å‘½ä»¤</h2><p>redis ä¸­è®¾ç½® key ç›¸å¯¹è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ <code>EXPIRE</code>/ <code>PEXPIRE</code>ï¼Œè®¾ç½® key ç»å¯¹è¿‡æœŸæ—¶é—´çš„å‘½ä»¤ <code>EXPIREAT</code>/<code>PEXPIREAT</code>ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ <code>expireGenericCommand</code> å‡½æ•°å®ç°çš„ã€‚</p><p>ä»£ç åˆ†æå¤§è‡´å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">expireGenericCommand</span><span class="hljs-params">(client *c, <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> basetime, <span class="hljs-keyword">int</span> unit)</span> </span>&#123;
    robj *key = c-&gt;argv[<span class="hljs-number">1</span>], *param = c-&gt;argv[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> when; <span class="hljs-comment">/* unix time in milliseconds when the key will expire. */</span>
    <span class="hljs-keyword">if</span> (getLongLongFromObjectOrReply(c, param, &amp;when, <span class="hljs-literal">NULL</span>) != C_OK)
        <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (unit == UNIT_SECONDS) when *= <span class="hljs-number">1000</span>;
    when += basetime;

    <span class="hljs-comment">/* No key, return zero. */</span>
    <span class="hljs-keyword">if</span> (lookupKeyWrite(c-&gt;db,key) == <span class="hljs-literal">NULL</span>) &#123;
        addReply(c,shared.czero);
        <span class="hljs-keyword">return</span>;
    &#125;

    <span class="hljs-keyword">if</span> (when &lt;= mstime() &amp;&amp; !server.loading &amp;&amp; !server.masterhost) &#123;
        robj *aux;

        serverAssertWithInfo(c,key,dbDelete(c-&gt;db,key));
        server.dirty++;

        <span class="hljs-comment">/* Replicate/AOF this as an explicit DEL. */</span>
        aux = createStringObject(<span class="hljs-string">&quot;DEL&quot;</span>,<span class="hljs-number">3</span>);
        rewriteClientCommandVector(c,<span class="hljs-number">2</span>,aux,key);
        decrRefCount(aux);
        signalModifiedKey(c-&gt;db,key);
        notifyKeyspaceEvent(NOTIFY_GENERIC,<span class="hljs-string">&quot;del&quot;</span>,key,c-&gt;db-&gt;id);
        addReply(c, shared.cone);
        <span class="hljs-keyword">return</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        setExpire(c-&gt;db,key,when);
        addReply(c,shared.cone);
        signalModifiedKey(c-&gt;db,key);
        notifyKeyspaceEvent(NOTIFY_GENERIC,<span class="hljs-string">&quot;expire&quot;</span>,key,c-&gt;db-&gt;id);
        server.dirty++;
        <span class="hljs-keyword">return</span>;
    &#125;
&#125;</code></pre></div><p>é¦–å…ˆæ˜¯è§£æå‚æ•°ï¼Œç›¸å¯¹æ—¶é—´ä¼šè¢«è½¬æ¢æˆç»å¯¹æ—¶é—´ <code>when</code>ã€‚</p><p>æ‰¾ä¸€ä¸ªä¸‹è¿™ä¸ª key æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚</p><p>å¦‚æœ <code>when</code> æ¯”å½“å‰æ—¶é—´è¿˜è¦å°ï¼Œæ²¡æœ‰åšæ•°æ®çš„ loadingï¼Œä¸”å½“å‰èŠ‚ç‚¹æ˜¯ masterï¼ˆslave èŠ‚ç‚¹ç­‰ç€ master ä¼ è¿‡å»çš„ DEL å°±å¥½ï¼‰ï¼Œè¿™æ—¶æŠŠ expire å‘½ä»¤è½¬æ¢æˆ <strong>DEL</strong>ã€‚<br>å¦åˆ™ï¼Œè°ƒç”¨ <code>setExpire</code> å‡½æ•°ä¸º key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œ</p><p>ä»£ç åˆ†æå¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setExpire</span><span class="hljs-params">(redisDb *db, robj *key, <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> when)</span> </span>&#123;
    dictEntry *kde, *de;

    <span class="hljs-comment">/* Reuse the sds from the main dict in the expire dict */</span>
    kde = dictFind(db-&gt;dict,key-&gt;ptr);
    serverAssertWithInfo(<span class="hljs-literal">NULL</span>,key,kde != <span class="hljs-literal">NULL</span>);
    <span class="hljs-comment">// åœ¨ expires ä¸­å¯»æ‰¾ keyï¼Œæ‰¾ä¸åˆ°å°±æ–°å»ºä¸€ä¸ª</span>
    de = dictReplaceRaw(db-&gt;expires,dictGetKey(kde));
    dictSetSignedIntegerVal(de,when);
&#125;</code></pre></div><br>é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥å‘ç°ï¼Œå«æœ‰è¿‡æœŸæ—¶é—´çš„ key éƒ½ä¼šæ”¾åˆ° <code>db-&gt;expires</code> å˜é‡ä¸­ï¼ˆåœ¨æ•°æ®åº“ç»“æ„ä½“ <code>redisDb</code> ä¸­ï¼Œä½¿ç”¨ <code>expires</code> å­—å…¸å­˜æ”¾è¿™äº› keyï¼‰ã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisDb</span> &#123;</span>
    dict *dict; <span class="hljs-comment">// å­˜æ”¾æ‰€æœ‰ key</span>
    dict *expires; <span class="hljs-comment">// å­˜æ”¾è¿‡æœŸ key</span>
    <span class="hljs-keyword">int</span> id; <span class="hljs-comment">// æ•°æ®åº“ id</span>
    ....
&#125; redisDb;</code></pre></div><br>è¿‡æœŸæ—¶é—´é€šè¿‡ <code>dictSetSignedIntegerVal</code> å‡½æ•°ï¼Œå­˜æ”¾åˆ° key æ‰€åœ¨çš„ <code>dictEntry</code> ç»“æ„ï¼Œå¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> &#123;</span>
    <span class="hljs-keyword">void</span> *key;
    <span class="hljs-keyword">union</span> &#123;
        <span class="hljs-keyword">void</span> *val;
        <span class="hljs-keyword">uint64_t</span> u64;
        <span class="hljs-keyword">int64_t</span> s64; <span class="hljs-comment">// å­˜æ”¾è¿‡æœŸæ—¶é—´</span>
        <span class="hljs-keyword">double</span> d;
    &#125; v;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dictEntry</span> *<span class="hljs-title">next</span>;</span>
&#125; dictEntry;</code></pre></div></p><h2 id="æŸ¥è¯¢è¿‡æœŸæ—¶é—´å‘½ä»¤"><a href="# æŸ¥è¯¢è¿‡æœŸæ—¶é—´å‘½ä»¤" class="headerlink" title="æŸ¥è¯¢è¿‡æœŸæ—¶é—´å‘½ä»¤"></a>æŸ¥è¯¢è¿‡æœŸæ—¶é—´å‘½ä»¤</h2><p>æŸ¥è¯¢æŸä¸ª key çš„è¿‡æœŸæ—¶é—´ï¼Œredis æä¾›äº† <code>TTL</code> è¿™ä¸ªå‘½ä»¤ï¼Œæœ‰ä¸‰ç§è¿”å›å€¼ï¼Œ</p><ul><li>è¿”å› <strong>-2</strong>ï¼Œè¡¨ç¤ºæŸ¥è¯¢çš„ key ä¸å­˜åœ¨ã€‚</li><li>è¿”å› <strong>-1</strong>ï¼Œè¡¨ç¤ºæŸ¥è¯¢çš„ key æ²¡æœ‰è®¾ç½®è¿‡æœŸã€‚</li><li>è¿”å›æ­£å¸¸çš„è¿‡æœŸæ—¶é—´ã€‚</li></ul><p>ä¸Šé¢å·²ç»çŸ¥é“ï¼Œkey è¿‡æœŸæ—¶é—´å­˜æ”¾ä½ç½®äº†ï¼Œé‚£ä¹ˆç›´æ¥å–å‡ºæ¥å°±å¥½äº†ã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getExpire</span><span class="hljs-params">(redisDb *db, robj *key)</span> </span>&#123;
    dictEntry *de;

    <span class="hljs-comment">/* No expire? return ASAP */</span>
    <span class="hljs-keyword">if</span> (dictSize(db-&gt;expires) == <span class="hljs-number">0</span> ||
       (de = dictFind(db-&gt;expires,key-&gt;ptr)) == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    serverAssertWithInfo(<span class="hljs-literal">NULL</span>,key,dictFind(db-&gt;dict,key-&gt;ptr) != <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> dictGetSignedIntegerVal(de);
&#125;</code></pre></div><br>é€šè¿‡ <code>dictGetSignedIntegerVal</code> å‡½æ•°å–åˆ°è¿‡æœŸæ—¶é—´ã€‚</p><h2 id="åˆ é™¤è¿‡æœŸæ—¶é—´"><a href="# åˆ é™¤è¿‡æœŸæ—¶é—´" class="headerlink" title="åˆ é™¤è¿‡æœŸæ—¶é—´"></a>åˆ é™¤è¿‡æœŸæ—¶é—´</h2><p>å¦‚æœä¸€ä¸ª key è®¾ç½®äº†è¿‡æœŸæ—¶é—´åæƒ³åˆ é™¤æ€ä¹ˆåŠï¼Ÿredis æä¾›äº† <code>PERSIST</code> å‘½ä»¤ï¼Œæˆ–è€…ç›´æ¥ç”¨ <code>SET</code> å‘½ä»¤å»è¦†ç›–ï¼Œå®ƒä»¬éƒ½æ¶‰åŠåˆ°å‡½æ•° <code>removeExpire</code>ã€‚</p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">removeExpire</span><span class="hljs-params">(redisDb *db, robj *key)</span> </span>&#123;
    <span class="hljs-comment">/* An expire may only be removed if there is a corresponding entry in the</span>
<span class="hljs-comment">     * main dict. Otherwise, the key will never be freed. */</span>
    serverAssertWithInfo(<span class="hljs-literal">NULL</span>,key,dictFind(db-&gt;dict,key-&gt;ptr) != <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">return</span> dictDelete(db-&gt;expires,key-&gt;ptr) == DICT_OK;
&#125;</code></pre></div><br>ä» <code>db-&gt;expires</code> ä¸­åˆ æ‰è¿™ä¸ª keyï¼Œä½†æ˜¯ <code>dictEntry</code> ç»“æ„ä½“ä¸­çš„ <strong>è¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šé‡ç½®</strong>ã€‚</p><h2 id="åˆ é™¤è¿‡æœŸ -key"><a href="# åˆ é™¤è¿‡æœŸ -key" class="headerlink" title="åˆ é™¤è¿‡æœŸ key"></a>åˆ é™¤è¿‡æœŸ key</h2><p>redis 3.x ä¸­ï¼Œè¿‡æœŸ key çš„åˆ é™¤æ–¹å¼æœ‰ä¸¤ç§ï¼Œ<strong>æƒ°æ€§åˆ é™¤ </strong>å’Œ<strong>å‘¨æœŸåˆ é™¤</strong>ã€‚</p><h3 id="æƒ°æ€§åˆ é™¤"><a href="# æƒ°æ€§åˆ é™¤" class="headerlink" title="æƒ°æ€§åˆ é™¤"></a>æƒ°æ€§åˆ é™¤</h3><p>å½“ key è¿‡æœŸåï¼Œå¹¶ä¸ä¼šç«‹åˆ»åˆ é™¤ï¼Œå³ï¼Œå®ƒä»¬å ç”¨çš„å†…å­˜ä¸èƒ½å¤Ÿå¾—åˆ°åŠæ—¶é‡Šæ”¾ã€‚</p><p>redis åœ¨å¯¹æ¯ä¸ª key è¿›è¡Œè¯»å†™æ—¶ï¼Œéƒ½ä¼šå»æ£€æŸ¥è¿™ä¸ª key æ˜¯å¦è¿‡æœŸéœ€è¦åˆ é™¤äº†ï¼Œè¿™æ ·å°± <strong>æŠŠæ¸…ç†è¿‡æœŸ key çš„å·¥ä½œåˆ†æ‘Šåˆ°æ¯ä¸€æ¬¡è®¿é—®ä¸­</strong>ã€‚ç±»ä¼¼çš„æ€è·¯è¿˜æœ‰ï¼Œredis ä¸­çš„ dict çš„æ‰©å®¹ï¼Œç§°ä¸ºæ¸è¿›å¼ rehashã€‚</p><p class="note note-warning">è¿™æ ·ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå½“æ£€æŸ¥åˆ°ä¸€ä¸ªå¤§ key è¦åˆ é™¤æ—¶ï¼Œä¼šå ç”¨æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œå¯¼è‡´æ­¤æ¬¡è®¿é—®çš„å“åº”æ—¶é—´å˜é•¿ã€‚</p><p>æ£€æŸ¥ key çš„ expire çš„é€»è¾‘åœ¨ <code>expireIfNeeded</code> å‡½æ•°ä¸­å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">expireIfNeeded</span><span class="hljs-params">(redisDb *db, robj *key)</span> </span>&#123;
    <span class="hljs-comment">// è·å¾— key çš„è¿‡æœŸæ—¶é—´</span>
    <span class="hljs-keyword">mstime_t</span> when = getExpire(db,key);
    <span class="hljs-keyword">mstime_t</span> now;

    <span class="hljs-comment">// key æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´</span>
    <span class="hljs-keyword">if</span> (when &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// åœ¨ load æ•°æ®æ—¶ï¼Œæš‚æ—¶å…ˆä¸è¦å¤„ç†è¿‡æœŸçš„ key</span>
    <span class="hljs-keyword">if</span> (server.loading) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// æœ‰ lua è„šæœ¬è°ƒç”¨æ—¶ï¼Œnow å– lua è„šæœ¬å¼€å§‹çš„æ—¶é—´ï¼Œå¦åˆ™å–å½“å‰æ—¶é—´</span>
    now = server.lua_caller ? server.lua_time_start : mstime();

    <span class="hljs-comment">// å¦‚æœæœ¬èŠ‚ç‚¹æ˜¯ slaveï¼Œç­‰ç€ master åŒæ­¥ DEL å‘½ä»¤</span>
    <span class="hljs-keyword">if</span> (server.masterhost != <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> now &gt; when;

    <span class="hljs-comment">// å¦‚æœæ²¡è¿‡æœŸï¼Œè¿”å› 0</span>
    <span class="hljs-keyword">if</span> (now &lt;= when) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// è¿‡æœŸ key çš„ç»Ÿè®¡</span>
    server.stat_expiredkeys++;

    <span class="hljs-comment">// åŒæ­¥ DEL å‘½ä»¤ç»™ slave å’Œ aof æ–‡ä»¶</span>
    propagateExpire(db,key);
    notifyKeyspaceEvent(NOTIFY_EXPIRED,
        <span class="hljs-string">&quot;expired&quot;</span>,key,db-&gt;id);

    <span class="hljs-comment">// åˆ  key</span>
    <span class="hljs-keyword">return</span> dbDelete(db,key);
&#125;</code></pre></div><p>ç»è¿‡ä¸€äº›å‰ç½®æ ¡éªŒï¼Œåœ¨ <code>propagateExpire</code> å‡½æ•°ä¸­ï¼Œå°† <code>DEL</code> å‘½ä»¤åˆ†å‘ç»™æ‰€æœ‰çš„ slaveï¼Œä»¥åŠå†™å…¥ aofã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">propagateExpire</span><span class="hljs-params">(redisDb *db, robj *key)</span> </span>&#123;
    robj *argv[<span class="hljs-number">2</span>];

    argv[<span class="hljs-number">0</span>] = shared.del;
    argv[<span class="hljs-number">1</span>] = key;
    incrRefCount(argv[<span class="hljs-number">0</span>]);
    incrRefCount(argv[<span class="hljs-number">1</span>]);

    <span class="hljs-keyword">if</span> (server.aof_state != AOF_OFF)
        feedAppendOnlyFile(server.delCommand,db-&gt;id,argv,<span class="hljs-number">2</span>);
    replicationFeedSlaves(server.slaves,db-&gt;id,argv,<span class="hljs-number">2</span>);

    decrRefCount(argv[<span class="hljs-number">0</span>]);
    decrRefCount(argv[<span class="hljs-number">1</span>]);
&#125;</code></pre></div><br>å½“ä¸€ä¸ª key åœ¨ master ä¸Šè¿‡æœŸåï¼Œå°†ä¼šç»™æ‰€æœ‰çš„ slave å‘é€ç›¸åº”çš„ DEL å‘½ä»¤ï¼Œå¦‚æœ aof æ‰“å¼€äº†ï¼Œä¹Ÿä¼šå†™å…¥ aofã€‚</p><p class="note note-primary">è¿™ç§åœ¨ä¸€ä¸ªåœ°æ–¹é›†ä¸­åŒ–ç®¡ç† key çš„æ–¹å¼ï¼Œå¹¶ä¸”åœ¨ aof å’Œä¸»ä»é“¾æ¥é‡Œä¿è¯æ“ä½œé¡ºåºï¼Œå³ä½¿æœ‰å¯¹äºè¿‡æœŸ key çš„å†™æ“ä½œä¹Ÿæ˜¯å…è®¸çš„ã€‚</p><p>è€Œåˆ  key çš„æ“ä½œï¼Œåœ¨å‡½æ•° <code>dbDelete</code> ä¸­å®Œæˆï¼Œä»£ç å¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dbDelete</span><span class="hljs-params">(redisDb *db, robj *key)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (dictSize(db-&gt;expires) &gt; <span class="hljs-number">0</span>) dictDelete(db-&gt;expires,key-&gt;ptr);
    <span class="hljs-keyword">if</span> (dictDelete(db-&gt;dict,key-&gt;ptr) == DICT_OK) &#123;
        <span class="hljs-keyword">if</span> (server.cluster_enabled) slotToKeyDel(key);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    &#125;
&#125;</code></pre></div><br>å¦‚ä¸Šä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåˆ†åˆ«ä» <code>db-&gt;expires</code> å’Œ <code>db-&gt;dict</code> è¿™ä¸¤ä¸ª dict é‡Œåˆ é™¤ç›¸åº”çš„ keyã€‚å¦‚æœå¼€å¯äº† <strong>cluster æ¨¡å¼</strong>ï¼Œè¿˜æœ‰åœ¨ç›¸åº”çš„ slot é‡Œåˆ æ‰ã€‚</p><h3 id="å‘¨æœŸåˆ é™¤"><a href="# å‘¨æœŸåˆ é™¤" class="headerlink" title="å‘¨æœŸåˆ é™¤"></a>å‘¨æœŸåˆ é™¤</h3><p>ä¸Šé¢çš„æƒ°æ€§åˆ é™¤ï¼Œåªæœ‰åœ¨è®¿é—®åˆ° key æ—¶æ‰ä¼šè§¦å‘ï¼Œè¿™ä½¿å¾—è¿‡æœŸ key çš„æ¸…ç†æ—¶é—´æ‹‰çš„å¾ˆé•¿ï¼Œæ‰€ä»¥åªæœ‰æƒ°æ€§åˆ é™¤ä¸€ç§æ–¹å¼æ˜¯ä¸è¡Œçš„ï¼Œå› æ­¤å¢åŠ å‘¨æœŸåˆ é™¤è¿™ä¸ªæ–¹å¼ä½œä¸ºè¡¥å……ã€‚</p><p>å‘¨æœŸåˆ é™¤ä½¿ç”¨çš„å‡½æ•°æ˜¯ <code>activeExpireCycle</code>ã€‚è¿™ä¸ªå‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼Œå…¥å‚åˆ†æƒ…å†µæœ‰ 2 ç§è¿‡æœŸå¾ªç¯ç±»å‹ï¼Œä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯æ‰§è¡Œæ—¶é—´çš„å·®å¼‚ã€‚</p><ul><li>å¸¸é‡ <code>ACTIVE_EXPIRE_CYCLE_FAST</code> ï¼Œæ‰§è¡Œæ—¶é—´é™åˆ¶æ˜¯ 1000 usã€‚åœ¨ <code>beforeSleep</code> å‡½æ•°ä¸­è°ƒç”¨çš„ï¼Œå³ï¼Œæ¯æ¬¡ redis è¦è¿›å…¥äº‹ä»¶å¾ªç¯ä¹‹å‰è°ƒç”¨ï¼Œå› æ­¤éœ€è¦æ¯”è¾ƒå¿«çš„è¿”å›</li><li><p>å¸¸é‡ <code>ACTIVE_EXPIRE_CYCLE_SLOW</code>ï¼Œæ‰§è¡Œæ—¶é—´é™åˆ¶æœ‰ä¸€ä¸ªå¤æ‚å…¬å¼è®¡ç®—ï¼Œåé¢ä¼šè¯´åˆ°ã€‚åœ¨å‘¨æœŸæ€§ä»»åŠ¡ <code>databasesCron</code> ä¸­è°ƒç”¨çš„ï¼Œæ‰§è¡Œæ—¶é—´å¯ä»¥ç¨å¾®é•¿ä¸€ç‚¹ã€‚</p><p>åœ¨ <code>activeExpireCycle</code> å‡½æ•°é‡Œï¼Œä¼šå°è¯•åˆ é™¤ä¸€äº›è¿‡æœŸçš„ keyã€‚ä½¿ç”¨åˆ°çš„ç®—æ³•æ˜¯ <strong>è‡ªé€‚åº”çš„</strong>ï¼Œå¦‚æœå‡ ä¹æ²¡æœ‰è¿‡æœŸ keyï¼Œä»…ä½¿ç”¨å°‘é‡çš„ CPU å‘¨æœŸï¼Œå¦åˆ™ï¼Œä¸ºäº†é¿å…è¿‡æœŸ key è¿‡å¤šå ç”¨å†…å­˜ï¼Œå°†ä¼šæ›´ç§¯æåœ°ä»æ•°æ®åº“åˆ é™¤å®ƒä»¬ã€‚æ¯è½®æ£€æŸ¥çš„æ•°æ®åº“ä¸ªæ•°ä¸è¶…è¿‡å¸¸é‡ <strong>CRON_DBS_PER_CALL</strong> (16) ä¸ªã€‚</p></li></ul><p>ä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (type == ACTIVE_EXPIRE_CYCLE_FAST) &#123;
      <span class="hljs-keyword">if</span> (!timelimit_exit) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (start &lt; last_fast_cycle + ACTIVE_EXPIRE_CYCLE_FAST_DURATION*<span class="hljs-number">2</span>) <span class="hljs-keyword">return</span>;
      last_fast_cycle = start;
  &#125;</code></pre></div><p>å¦‚æœä¸Šä¸€æ¬¡å¾ªç¯ä¸æ˜¯å› ä¸º timeout è€Œç»“æŸçš„ï¼Œé‚£ä¹ˆè¿™ä¸€æ¬¡æ²¡å¿…è¦è·‘ fast å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ—¶é—´å¤Ÿç”¨äº†ï¼Œå¯ä»¥è·‘ slow å¤šæ¸…ç†ä¸€äº›è¿‡æœŸ keyã€‚<br>å¦å¤–ï¼Œä¸è¦åœ¨ä¸Šä¸€æ¬¡è·‘è¿‡ fast ä¹‹åçš„ 2 å€ <strong>ACTIVE_EXPIRE_CYCLE_FAST_DURATION</strong> (1000) us æ—¶é—´å†…å†è·‘ä¸€æ¬¡ fast å¾ªç¯ã€‚</p><p><code>dbs_per_call</code> å˜é‡ä¿å­˜çš„æ˜¯ï¼Œæœ¬è½®å¾ªç¯éœ€è¦éå†çš„ db æ•°é‡ï¼Œé»˜è®¤å€¼æ˜¯ 16ï¼Œåœ¨ä»¥ä¸‹ 2 ç§æƒ…å†µä¸‹éœ€è¦ä¿®æ”¹ï¼Œ</p><ul><li>æ£€æŸ¥çš„ db æ•°è¶…è¿‡ç°æœ‰çš„ã€‚</li><li>ä¸Šä¸€æ¬¡ä»¥ä¸º timelimit ç¦»å¼€äº†ã€‚æ­¤æ—¶éœ€è¦å°½å¿«çš„æŠŠå·²æœ‰çš„ db é‡Œçš„è¿‡æœŸ key ç»™æ¸…ç†æ‰ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œç•™å‡ºæ›´å¤šç©ºé—´ä¾›æ­£å¸¸ä½¿ç”¨ã€‚</li></ul><p>åˆ¤æ–­ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (dbs_per_call &gt; server.dbnum || timelimit_exit)
    dbs_per_call = server.dbnum;</code></pre></div><p>ä¸‹é¢æ˜¯å¾ªç¯æ—¶é—´ limit çš„è®¡ç®—ï¼Œ<br><div class="hljs"><pre><code class="hljs c">timelimit = <span class="hljs-number">1000000</span>*ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC/server.hz/<span class="hljs-number">100</span>;
timelimit_exit = <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (timelimit &lt;= <span class="hljs-number">0</span>) timelimit = <span class="hljs-number">1</span>;

<span class="hljs-keyword">if</span> (type == ACTIVE_EXPIRE_CYCLE_FAST)
    timelimit = ACTIVE_EXPIRE_CYCLE_FAST_DURATION; <span class="hljs-comment">/* in microseconds. 1000 us */</span></code></pre></div><br>ç„¶åå¼€å¯éå†æ¯ä¸ª db äº†ï¼Œå¦‚ä¸‹é€»è¾‘å‡åœ¨æ­¤å¾ªç¯ä¸­å®ç°ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; dbs_per_call; j++) &#123;&#125;</code></pre></div><br>ä»£ç é‡Œæœ‰ä¸€ä¸ªè®°å½•ä¸Šä¸€æ¬¡éå†åˆ°é‚£ä¸ª db çš„é™æ€å˜é‡ <code>current_db</code>ï¼Œæ¯æ¬¡éƒ½åŠ  1ã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> current_db = <span class="hljs-number">0</span>; <span class="hljs-comment">/* Last DB tested. */</span>
current_db++;</code></pre></div><br>é€‰æ‹©ä¸€ä¸ª db è¿›è¡Œæ•°æ®æ¸…ç†ï¼Œ<br><div class="hljs"><pre><code class="hljs c">redisDb *db = server.db+(current_db % server.dbnum);</code></pre></div><br>ä¸‹é¢å°±æ˜¯åœ¨é€‰æ‹©çš„ db é‡Œå¯¹ key è¿›è¡ŒæŠ½æ ·æ£€æŸ¥çš„è¿‡ç¨‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// å¦‚æœæ²¡æœ‰è¿‡æœŸçš„ keyï¼Œé‚£ä¹ˆè¿™ä¸ª db çš„æ£€æŸ¥ç»“æŸ</span>
<span class="hljs-keyword">if</span> ((num = dictSize(db-&gt;expires)) == <span class="hljs-number">0</span>) &#123;
            db-&gt;avg_ttl = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">break</span>;
&#125;

slots = dictSlots(db-&gt;expires);
<span class="hljs-keyword">if</span> (num &amp;&amp; slots &gt; DICT_HT_INITIAL_SIZE &amp;&amp; (num*<span class="hljs-number">100</span>/slots &lt; <span class="hljs-number">1</span>))
        <span class="hljs-keyword">break</span>;</code></pre></div><br>å¦‚æœ expires å­—å…¸ä¸ä¸ºç©ºï¼Œå­˜å‚¨çš„æ•°æ®å¯èƒ½å·²ç»å¾ˆå°‘äº†ï¼Œä½†æ˜¯å­—å…¸è¿˜æ˜¯å¤§å­—å…¸ (<strong> æ•°æ®ä¸è¶³ 1%</strong>)ï¼Œè¿™æ ·éå†æ•°æ®æœ‰æ•ˆå‘½ä¸­ç‡ä¼šå¾ˆä½ï¼Œå¤„ç†èµ·æ¥ä¼šæµªè´¹æ—¶é—´ï¼Œåé¢çš„è®¿é—®ä¼šå¾ˆå¿«è§¦å‘å­—å…¸çš„ç¼©å®¹ï¼Œç¼©å®¹åå†è¿›è¡Œå¤„ç†æ•ˆç‡æ›´é«˜, æš‚æ—¶ç»“æŸè¿™ä¸ª db çš„æ£€æŸ¥ã€‚</p><p>æ¯ä¸€æ¬¡æŠ½æ ·æœ€å¤š 20 ä¸ª keyã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (num &gt; ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP)
      num = ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP;

<span class="hljs-keyword">while</span> (num--) &#123;
    dictEntry *de;
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> ttl;

    <span class="hljs-keyword">if</span> ((de = dictGetRandomKey(db-&gt;expires)) == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">break</span>;
    ttl = dictGetSignedIntegerVal(de)-now;
    <span class="hljs-keyword">if</span> (activeExpireCycleTryExpire(db,de,now)) expired++; <span class="hljs-comment">// è¿‡æœŸçš„ key åˆ æ‰</span>
    <span class="hljs-keyword">if</span> (ttl &gt; <span class="hljs-number">0</span>) &#123;
        <span class="hljs-comment">/* We want the average TTL of keys yet not expired. */</span>
        ttl_sum += ttl;
        ttl_samples++;
    &#125;
&#125;</code></pre></div><br>éšæœºé€‰å– keyï¼Œè°ƒç”¨ <code>activeExpireCycleTryExpire</code> å‡½æ•°è¿›è¡Œè¿‡æœŸ key çš„åˆ é™¤ï¼Œè¯¥å‡½æ•°é€»è¾‘è§é™„å½•ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸ªç»Ÿè®¡å¹³å‡ ttl çš„é€»è¾‘ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (ttl_samples) &#123;
    <span class="hljs-comment">// æŠ½æ · key çš„å¹³å‡ ttl æ—¶é—´</span>
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> avg_ttl = ttl_sum/ttl_samples;

    <span class="hljs-comment">// æœ¬è½® avg_ttl å æ¯” 2%ï¼Œå†å²å€¼å æ¯” 98%</span>

    <span class="hljs-keyword">if</span> (db-&gt;avg_ttl == <span class="hljs-number">0</span>) db-&gt;avg_ttl = avg_ttl;
    db-&gt;avg_ttl = (db-&gt;avg_ttl/<span class="hljs-number">50</span>)*<span class="hljs-number">49</span> + (avg_ttl/<span class="hljs-number">50</span>);
&#125;</code></pre></div><br>æ¯ä¸ª db çš„æ£€æŸ¥ä»€ä¹ˆæ—¶å€™é€€å‡ºå‘¢ï¼Ÿæœ‰ 2 ä¸ªæ—¶åˆ»ã€‚</p><ol><li>é€šè¿‡è¶…æ—¶æ—¶é—´ <code>timelimit</code>ã€‚<br>æ¯ 16 è½®å¾ªç¯æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è¶…æ—¶ï¼Œåˆ°æ—¶é—´å ï¼Œ<code>timelimit_exit</code> å˜é‡ç½® 1ï¼Œæ¥ç€å°±é€€å‡ºäº†ã€‚<div class="hljs"><pre><code class="hljs c">iteration++;
<span class="hljs-keyword">if</span> ((iteration &amp; <span class="hljs-number">0xf</span>) == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">/* check once every 16 iterations. */</span>
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> elapsed = ustime()-start;

    latencyAddSampleIfNeeded(<span class="hljs-string">&quot;expire-cycle&quot;</span>,elapsed/<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">if</span> (elapsed &gt; timelimit) timelimit_exit = <span class="hljs-number">1</span>;
&#125;
<span class="hljs-keyword">if</span> (timelimit_exit) <span class="hljs-keyword">return</span>;</code></pre></div></li><li>åœ¨æ¯ä¸ª db çš„æ£€æŸ¥å¾ªç¯å¤–ï¼Œæ˜¯æœ‰æ¡ä»¶çš„ã€‚<br>æ¯æ£€æŸ¥åˆ°ä¸€ä¸ªè¿‡æœŸçš„ keyï¼Œå°±æŠŠ <code>expired</code> å˜é‡åŠ  1ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªå¾ªç¯çš„æ¡ä»¶æ—¶ï¼Œå¦‚æœä¸€è½®æŠ½æ ·åˆ°çš„ key ä¸­è¿‡æœŸçš„æ¯”ä¾‹å°äº 25%ï¼Œé‚£ä¹ˆè¿™ä¸ª db å°±ä¸å¿…å†æŠ½æ ·äº†ã€‚<div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP 20</span>
<span class="hljs-keyword">do</span> &#123;
  ...
&#125; <span class="hljs-keyword">while</span> (expired &gt; ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP/<span class="hljs-number">4</span>);</code></pre></div></li></ol><p class="note note-warning">åœ¨ä¸€ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œè¿‡æœŸ key æœ€å¥½ä¸è¦å¤ªå¯†é›†ï¼Œå› ä¸ºç³»ç»Ÿå‘ç°åˆ°æœŸæ•°æ®å¾ˆå¤šï¼Œä¼šè¿«åˆ‡å¸Œæœ›å°½å¿«å¤„ç†æ‰è¿™äº›è¿‡æœŸæ•°æ®ï¼Œæ‰€ä»¥æ¯æ¬¡æ£€æŸ¥éƒ½è¦è€—å°½åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œç›´åˆ°åˆ°æœŸæ•°æ®åˆ°è¾¾ä¸€ä¸ªå¯æ¥å—çš„å¯†åº¦æ¯”ä¾‹ã€‚</p><p class="note note-primary">ç”±ä¸Šæ€»ç»“ï¼Œredis ä¸»é€»è¾‘åœ¨å•è¿›ç¨‹ä¸»çº¿ç¨‹ä¸­å®ç°ï¼Œè¦ä¿è¯ä¸èƒ½å½±å“ä¸»ä¸šåŠ¡å‰æä¸‹ï¼Œæ£€æŸ¥è¿‡æœŸæ•°æ®ï¼Œä¸èƒ½å¤ªå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ä¸»è¦ä¸‰æ–¹é¢è¿›è¡Œé™åˆ¶ï¼š (1) æ£€æŸ¥æ—¶é—´é™åˆ¶ã€‚ (2) è¿‡æœŸæ•°æ®æ£€æŸ¥æ•°é‡é™åˆ¶ã€‚ (3) è¿‡æœŸæ•°æ®æ˜¯å¦è¾¾åˆ°å¯æ¥å—æ¯”ä¾‹ã€‚</p><p>è‡³æ­¤ï¼Œredis ä¸­ key çš„è¿‡æœŸé€»è¾‘å°±è®²å®Œäº†ã€‚é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œä¸ºäº†è§£å†³åˆ å¤§ key å¸¦æ¥çš„é˜»å¡é£é™©ï¼Œåœ¨æ›´é«˜ç‰ˆæœ¬çš„ redis ä¸­ï¼Œå°†åˆ  key æ”¾åˆ°äº† bio åå°çº¿ç¨‹ä¸­ã€‚</p><h2 id="é™„å½•"><a href="# é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><p><code>activeExpireCycleTryExpire</code> å‡½æ•°å°†è¯•ç€å°†å­˜å‚¨çš„è¿‡æœŸ key ä»å…¨å±€ key çš„ dict å’Œ expire çš„ dict ä¸­åˆ æ‰ã€‚å¦‚æœå‘ç° key è¿‡æœŸäº†ï¼Œæ“ä½œåè¿”å› 1ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œè¿”å› 0ã€‚ä»£ç é€»è¾‘å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">activeExpireCycleTryExpire</span><span class="hljs-params">(redisDb *db, dictEntry *de, <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> now)</span> </span>&#123;
    <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> t = dictGetSignedIntegerVal(de);
    <span class="hljs-keyword">if</span> (now &gt; t) &#123;
        sds key = dictGetKey(de);
        robj *keyobj = createStringObject(key,sdslen(key));

        <span class="hljs-comment">// å¹¿æ’­åˆ° slave å’Œ aof</span>
        propagateExpire(db,keyobj);

        <span class="hljs-comment">// åˆ  key</span>
        dbDelete(db,keyobj);
        notifyKeyspaceEvent(NOTIFY_EXPIRED,
            <span class="hljs-string">&quot;expired&quot;</span>,keyobj,db-&gt;id);
        decrRefCount(keyobj);

        <span class="hljs-comment">// æ›´æ–°ç»Ÿè®¡</span>
        server.stat_expiredkeys++;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    &#125;
&#125;</code></pre></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/f0a45582.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis æºç åˆ†æä¹‹å†…å­˜æ·˜æ±°ç­–ç•¥</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/badab03c.html"><span class="hidden-mobile">Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§» (2)</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis æºç åˆ†æä¹‹ key è¿‡æœŸ&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>