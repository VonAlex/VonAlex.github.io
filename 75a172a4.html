<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ SDS - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2017-10-15 17:57" pubdate>2017-10-15 17:57</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.8k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 23 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ SDS</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2017-10-15 17:57</p><div class="markdown-body" id="post-body"><p>æœ¬ç³»åˆ—åšå®¢ä»¥ redis 3.2.8 ç‰ˆæœ¬æ¥ä»‹ç» redis æºç ã€‚</p><p>å­—ç¬¦ä¸²æ˜¯ Redis æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºé”®éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„ï¼Œè€Œå…¶ä»–å‡ ç§æ•°æ®ç»“æ„ä¹Ÿéƒ½å»ºç«‹åœ¨å­—ç¬¦ä¸²ç±»å‹çš„åŸºç¡€ä¹‹ä¸Šã€‚å› æ­¤ï¼Œæˆ‘è®¤ä¸ºä»å­—ç¬¦ä¸²å…¥æ‰‹æ¥æ¢ç©¶ Redis çš„æ•°æ®ç»“æ„æ˜¯ç›¸å¯¹åˆç†çš„ã€‚</p><a id="more"></a><p>redis æ²¡æœ‰ç›´æ¥ä½¿ç”¨ C è¯­è¨€ä¸­ä¼ ç»Ÿçš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€å¥—åä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic string, SDSï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå°†å…¶ä½œä¸º redis çš„é»˜è®¤å­—ç¬¦ä¸²ä½¿ç”¨ã€‚</p><p>SDS ç›¸è¾ƒäºåŸç”Ÿ C å­—ç¬¦ä¸²çš„å¥½å¤„å¦‚ä¸‹ï¼Œ<br>1ï¼‰äºŒè¿›åˆ¶å®‰å…¨ï¼Œå³å­—ç¬¦ä¸²ä¸­å¯ä»¥åŒ…å« <code>\0</code> å­—ç¬¦ï¼›<br>2ï¼‰æ€§èƒ½æ›´å¥½ï¼Œå¦‚ O(1) è·å¾—å­—ç¬¦ä¸²é•¿åº¦ï¼›<br>3ï¼‰å¯åŠ¨æ€æ‰©å±•å†…å­˜ï¼›<br>4ï¼‰å®Œå…¨å…¼å®¹ C å­—ç¬¦ä¸²çš„ API</p><p>redis æºç ä¸­ SDS æ•°æ®ç»“æ„ä¸»è¦å®šä¹‰åœ¨ <code>sds.h</code> å’Œ <code>sds.c</code> è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­ã€‚</p><p>åœ¨é˜…è¯»æºç å‰ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œ<strong>å¦‚ä½•å®ç°ä¸€ä¸ªæ‰©å®¹æ–¹ä¾¿ä¸”äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿ</strong></p><h3 id="SDS- çš„å®šä¹‰"><a href="#SDS- çš„å®šä¹‰" class="headerlink" title="SDS çš„å®šä¹‰"></a>SDS çš„å®šä¹‰</h3><p>SDS æ—¢ç„¶æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‡é’ˆï¼›ä¸ºäº†æ–¹ä¾¿ä¸Šå±‚çš„æ¥å£è°ƒç”¨ï¼Œè¯¥ç»“æ„ä½“è¿˜å­˜æ”¾ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å½“å‰å­—ç¬¦ä¸²é•¿åº¦ã€å‰©ä½™å®¹é‡ç­‰ã€‚</p><p>æœ€åˆç‰ˆæœ¬çš„ SDS æ˜¯è¿™æ ·å®šä¹‰çš„ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">char</span> *sds;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sdshdr</span> &#123;</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-built_in">free</span>;
    <span class="hljs-keyword">char</span> buf[];
&#125;;</code></pre></div><br>ä¼˜ç‚¹å¦‚ä¸‹ï¼Œ<br>1ï¼‰len/free ç»Ÿè®¡å˜é‡ï¼Œæå‡æ€§èƒ½ï¼Œä¸”å­—ç¬¦ä¸²é•¿åº¦ä¾èµ–äº lenï¼Œä¿è¯äº†äºŒè¿›åˆ¶å®‰å…¨ã€‚<br>2ï¼‰æŸ”æ€§æ•°ç»„ buf å­˜æ”¾å­—ç¬¦ä¸²ã€‚SDS å¯¹å¤–æš´éœ²çš„æ˜¯ buf çš„é¦–åœ°å€ï¼Œè€Œä¸æ˜¯ç»“æ„ä½“çš„é¦–åœ°å€ï¼Œè¿™æ ·å¯ä»¥æ›´æ–¹ä¾¿åœ°å…¼å®¹ C å¤„ç†å­—ç¬¦ä¸²çš„å„ç§å‡½æ•°ã€‚</p><div class="note note-info"><p>æŸ”æ€§æ•°ç»„ï¼Œåªèƒ½å®šä¹‰åœ¨ä¸€ä¸ªç»“æ„ä½“çš„ <strong>æœ€åä¸€ä¸ªå­—æ®µ </strong>ä¸Šï¼Œè¯­æ³•å‚è€ƒ <a target="_blank" rel="noopener" href="http://blog.csdn.net/u013165704/article/details/53733412">ç»“æ„ä½“ä¸­ä½¿ç”¨æŸ”æ€§æ•°ç»„ </a>ã€‚<br>ç¨‹åºåœ¨ä¸º hdr åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œ<strong>buf[]</strong> å¹¶ä¸å ç”¨å†…å­˜ç©ºé—´ï¼Œé€šè¿‡ malloc ä¸º buf æŸ”å‹æ•°ç»„æˆå‘˜åˆ†é…å†…å­˜ã€‚<br>æŸ”æ€§æ•°ç»„æˆå‘˜åœ°å€ä¸ç»“æ„ä½“è¿ç»­ï¼Œæ–¹ä¾¿é€šè¿‡å®ƒçš„é¦–åœ°å€åç§»æ‰¾åˆ°ç»“æ„ä½“é¦–åœ°å€ï¼Œè¿›è€Œè·å¾—å…¶ä»–æˆå‘˜å˜é‡ã€‚</p></div><p>len æ˜¯ unsigned int ç±»å‹å˜é‡ï¼Œå ç”¨ 4 ä¸ªå­—èŠ‚ï¼Œæœ€å¤šèƒ½è¡¨ç¤º 2^32-1 é•¿åº¦ã€‚<br>å®é™…åº”ç”¨ä¸­ï¼Œè€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œé•¿å­—ç¬¦ä¸²åœ¨ Redis ä¸­æ˜¯æ¯”è¾ƒå°‘è§çš„ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒçŸ­å­—ç¬¦ä¸²å¹¶ä¸éœ€è¦ 4 å­—èŠ‚è¡¨ç¤ºé•¿åº¦ï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²ä½¿ç”¨åŒä¸€ä¸ª headerï¼Œ<strong>å­˜åœ¨ç€ä¸¥é‡çš„å†…å­˜æµªè´¹ </strong>ã€‚æ‰€ä»¥ï¼Œæœ¬ç€æœ€å¤§ç¨‹åº¦èŠ‚çœå†…å­˜çš„ç›®çš„ï¼Œåœ¨ 3.2 ç‰ˆæœ¬ä»£ç ä¸­å¯¹ SDS è¿›è¡Œçš„é‡æ„ï¼Œ<strong> æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ä½¿ç”¨ä¸åŒçš„ header</strong>ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr5</span> &#123;</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> flags; <span class="hljs-comment">// ä½ 3 ä½è¡¨ç¤ºç±»å‹ï¼Œé«˜ 5 ä½è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼Œå³æœ€é•¿ 31 å­—èŠ‚</span>
    <span class="hljs-keyword">char</span> buf[]; <span class="hljs-comment">// æŸ”æ€§æ•°ç»„ï¼Œå­˜æ”¾å®é™…å­—ç¬¦ä¸²</span>
&#125;;
<span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr8</span> &#123;</span>
    <span class="hljs-keyword">uint8_t</span> len;
    <span class="hljs-keyword">uint8_t</span> alloc;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> flags;
    <span class="hljs-keyword">char</span> buf[];
&#125;;
<span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr16</span> &#123;</span>
    <span class="hljs-keyword">uint16_t</span> len;
    <span class="hljs-keyword">uint16_t</span> alloc;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> flags;
    <span class="hljs-keyword">char</span> buf[];
&#125;;
<span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr32</span> &#123;</span>
    <span class="hljs-keyword">uint32_t</span> len;
    <span class="hljs-keyword">uint32_t</span> alloc;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> flags;
    <span class="hljs-keyword">char</span> buf[];
&#125;;
<span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr64</span> &#123;</span>
    <span class="hljs-keyword">uint64_t</span> len; <span class="hljs-comment">// å­—ç¬¦ä¸²çœŸæ­£é•¿åº¦ï¼Œä¸åŒ…å«ç©ºç»ˆæ­¢å­—ç¬¦</span>
    <span class="hljs-keyword">uint64_t</span> alloc; <span class="hljs-comment">// å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ï¼Œä¸åŒ…å« header å’Œç©ºç»ˆæ­¢å­—ç¬¦</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> flags; <span class="hljs-comment">// ä½ 3 ä½è¡¨ç¤º header ç±»å‹ï¼Œé«˜ 5 ä½æœªä½¿ç”¨</span>
    <span class="hljs-keyword">char</span> buf[];
&#125;;</code></pre></div><p>éœ€è¦æ³¨æ„ <code>__attribute__ ((packed))</code> ä¿®é¥°ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç»“æ„ä½“ä¼šæŒ‰å…¶æ‰€æœ‰æˆå‘˜å˜é‡å¤§å°çš„å…¬å€æ•°åšå­—èŠ‚å¯¹é½ï¼Œè€Œä½¿ç”¨ packed ä¿®é¥°ä»¥åï¼Œç¼–è¯‘å™¨ä»¥ç´§å‡‘æ¨¡å¼æ¥åˆ†é…å†…å­˜ï¼Œç»“æ„ä½“å˜ä¸ºæŒ‰ç…§ 1 å­—èŠ‚å¯¹é½ã€‚è¿™æ ·åšæœ‰ä»¥ä¸‹ä¸¤ä¸ªå¥½å¤„ï¼Œ<br>1ï¼‰æå¤§èŠ‚çœäº†å†…å­˜ï¼Œä¾‹å¦‚ sdshdr32 åªéœ€è¦ 4+4+1=9 ä¸ªå­—èŠ‚ï¼Œè€ŒåŸæœ¬æ˜¯éœ€è¦ 4*3=12 ä¸ªå­—èŠ‚ã€‚<br>2ï¼‰SDS è¿”å›ç»™ä¸Šå±‚çš„ï¼Œä¸æ˜¯ç»“æ„ä½“é¦–åœ°å€ï¼Œè€Œæ˜¯æŒ‡å‘å†…å®¹çš„ buf æŒ‡é’ˆã€‚packed ä¿®é¥°ä¿è¯äº† header å’Œ SDS æ•°æ®éƒ¨åˆ†ç´§ç´§ç›¸é‚»ï¼Œæ–¹ä¾¿æŒ‰ç…§å›ºå®šçš„åç§»ï¼Œ<code>buf[-1]</code>ï¼Œè·å– flagsï¼Œè¿›è€ŒåŒºåˆ† SDS ç±»å‹ã€‚</p><p>ä¸‹é¢ç”»äº†ä¸€ä¸ªå†…å­˜ç®€æ˜“å›¾å¯ä»¥å¸®åŠ©ç†è§£ï¼š</p><center><img src="https://s1.ax1x.com/2018/10/28/icwIM9.jpg" srcset="/img/loading.gif" width="500"></center><h2 id="SDS- å®å®šä¹‰"><a href="#SDS- å®å®šä¹‰" class="headerlink" title="SDS å®å®šä¹‰"></a>SDS å®å®šä¹‰</h2><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// SDS ç±»å‹</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_5 0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_8 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_16 2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_32 3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_64 4</span>

<span class="hljs-comment">// ç±»å‹æ©ç ï¼Œä¸ flag ç›¸ä¸ï¼Œå¯ä»¥å¾—åˆ°ä½ä¸‰ä½</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_MASK 7</span>

<span class="hljs-comment">// ç±»å‹å ç”¨çš„æ¯”ç‰¹ä½æ•°</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_BITS 3</span>

<span class="hljs-comment">// è·å¾— sds header å¤´æŒ‡é’ˆ</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_HDR_VAR(T, s) struct sdshdr##T *sh = (void *)((s) - (sizeof(struct sdshdr##T)));</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_HDR(T, s) ((struct sdshdr##T *)((s) - (sizeof(struct sdshdr##T))))</span>

<span class="hljs-comment">// SDS_TYPE_5 ç±»å‹çš„ sdsï¼Œä½ä¸‰ä½è¡¨ç¤º sds typeï¼Œ é«˜äº”ä½è¡¨ç¤º sds len</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDS_TYPE_5_LEN(f) ((f) &gt;&gt; SDS_TYPE_BITS)</span></code></pre></div><h2 id="SDS- å‡½æ•°"><a href="#SDS- å‡½æ•°" class="headerlink" title="SDS å‡½æ•°"></a>SDS å‡½æ•°</h2><p>æ•°æ®ç±»å‹çš„åŸºæœ¬æ“ä½œä¸å¤–ä¹å¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼ŒSDS ä¹Ÿä¸ä¾‹å¤–ã€‚</p><h3 id="åˆ›å»º -sds"><a href="# åˆ›å»º -sds" class="headerlink" title="åˆ›å»º sds"></a>åˆ›å»º sds</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªæŒ‡å®šé•¿åº¦çš„ sds</span>
<span class="hljs-function">sds <span class="hljs-title">sdsnewlen</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *init, <span class="hljs-keyword">size_t</span> initlen)</span> </span>&#123;
    <span class="hljs-keyword">void</span> *sh;
    sds s;

    <span class="hljs-comment">// æ ¹æ® initlen é€‰æ‹©åˆé€‚ç±»å‹çš„ sds header</span>
    <span class="hljs-keyword">char</span> type = sdsReqType(initlen); 

    <span class="hljs-comment">// ç©ºå­—ç¬¦ä¸²ä¸€èˆ¬ç”¨æ¥åš appendï¼Œä½¿ç”¨ type 8 ä»£æ›¿ type 5ï¼Œå‡å°‘ä¸å¿…è¦çš„ sds æ‰©å®¹</span>
    <span class="hljs-keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="hljs-number">0</span>) type = SDS_TYPE_8;
    <span class="hljs-keyword">int</span> hdrlen = sdsHdrSize(type); <span class="hljs-comment">// æ‰€é€‰æ‹©çš„ sds ç±»å‹çš„ header é•¿åº¦</span>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *fp;

    sh = s_malloc(hdrlen+initlen+<span class="hljs-number">1</span>); <span class="hljs-comment">// header + str + 1</span>
    <span class="hljs-keyword">if</span> (!init)
        <span class="hljs-built_in">memset</span>(sh, <span class="hljs-number">0</span>, hdrlen+initlen+<span class="hljs-number">1</span>); <span class="hljs-comment">// åˆå§‹åŒ– sds</span>
    <span class="hljs-keyword">if</span> (sh == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    s = (<span class="hljs-keyword">char</span>*)sh+hdrlen; <span class="hljs-comment">// s æŒ‡å‘ buf é¦–å…ƒç´ </span>
    fp = ((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)s)<span class="hljs-number">-1</span>; <span class="hljs-comment">// fp æŒ‡å‘ flag</span>
    <span class="hljs-keyword">switch</span>(type) &#123;<span class="hljs-comment">// è®¾ç½® sds çš„ header å„å‚æ•°</span>
        <span class="hljs-keyword">case</span> SDS_TYPE_5: &#123;
            <span class="hljs-comment">// ä½ 3 ä½å­˜ typeï¼Œé«˜ 5 ä½å­˜ len</span>
            *fp = type | (initlen &lt;&lt; SDS_TYPE_BITS);
            <span class="hljs-keyword">break</span>;
        &#125;
        <span class="hljs-keyword">case</span> SDS_TYPE_8: &#123;
            SDS_HDR_VAR(<span class="hljs-number">8</span>,s);
            sh-&gt;len = initlen; <span class="hljs-comment">// len ä¸ alloc èµ·å§‹å€¼ç›¸åŒ</span>
            sh-&gt;alloc = initlen;
            *fp = type;
            <span class="hljs-keyword">break</span>;
        &#125;
        ......
    &#125;
    <span class="hljs-keyword">if</span> (initlen &amp;&amp; init)
        <span class="hljs-built_in">memcpy</span>(s, init, initlen); <span class="hljs-comment">// copy åŸå­—ç¬¦ä¸²</span>
    s[initlen] = <span class="hljs-string">&#x27;\0&#x27;</span>;<span class="hljs-comment">// ç»“æŸ</span>
    <span class="hljs-keyword">return</span> s;
&#125;</code></pre></div><h3 id="é‡Šæ”¾ -sds- å†…å­˜"><a href="# é‡Šæ”¾ -sds- å†…å­˜" class="headerlink" title="é‡Šæ”¾ sds å†…å­˜"></a>é‡Šæ”¾ sds å†…å­˜</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> s_free zfree</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sdsfree</span><span class="hljs-params">(sds s)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;
    s_free((<span class="hljs-keyword">char</span> *)s - sdsHdrSize(s[<span class="hljs-number">-1</span>]));
&#125;</code></pre></div><h3 id="åŠ¨æ€æ‰©å®¹"><a href="# åŠ¨æ€æ‰©å®¹" class="headerlink" title="åŠ¨æ€æ‰©å®¹"></a>åŠ¨æ€æ‰©å®¹</h3><p>å½“é‡åˆ°æœ‰äº›æ‹¼æ¥ sds æ“ä½œæ—¶ï¼Œå¯èƒ½é‡åˆ° sds é•¿åº¦ä¸å¤Ÿçš„æƒ…å†µï¼Œè¿™æ—¶å°±éœ€è¦å¯¹ sds è¿›è¡ŒåŠ¨æ€æ‰©å®¹ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function">sds <span class="hljs-title">sdsMakeRoomFor</span><span class="hljs-params">(sds s, <span class="hljs-keyword">size_t</span> addlen)</span> </span>&#123;
    <span class="hljs-keyword">void</span> *sh, *newsh;
    <span class="hljs-keyword">size_t</span> avail = sdsavail(s); <span class="hljs-comment">// å½“å‰ sds å‰©ä½™é•¿åº¦</span>
    <span class="hljs-keyword">size_t</span> len, newlen;
    <span class="hljs-keyword">char</span> type, oldtype = s[<span class="hljs-number">-1</span>] &amp; SDS_TYPE_MASK;
    <span class="hljs-keyword">int</span> hdrlen;

    <span class="hljs-comment">// å½“å‰ sds è¶³ä»¥å®¹çº³é¢å¤– addlenï¼Œä¸è°ƒæ•´ï¼Œç›´æ¥è¿”å›</span>
    <span class="hljs-keyword">if</span> (avail &gt;= addlen) 
        <span class="hljs-keyword">return</span> s;

    len = sdslen(s);
    sh = (<span class="hljs-keyword">char</span> *)s - sdsHdrSize(oldtype); <span class="hljs-comment">// header å¤´æŒ‡é’ˆ</span>
    newlen = (len + addlen);              <span class="hljs-comment">// æ–°çš„ sds çš„é•¿åº¦</span>

    <span class="hljs-comment">/* sds è§„å®šï¼š</span>
<span class="hljs-comment">     * å¦‚æœæ‰©å±•åçš„å­—ç¬¦ä¸²æ€»é•¿åº¦å°äº 1Mï¼Œåˆ™æ–°å­—ç¬¦ä¸²é•¿åº¦åŠ å€</span>
<span class="hljs-comment">     * å¦åˆ™ï¼Œæ–°é•¿åº¦ä¸ºæ‰©å±•åçš„æ€»é•¿åº¦åŠ ä¸Š 1Mã€‚</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * è¿™æ ·åšçš„ç›®çš„æ˜¯å‡å°‘ Redis å†…å­˜åˆ†é…çš„æ¬¡æ•°ï¼ŒåŒæ—¶å°½é‡èŠ‚çœç©ºé—´ */</span>
    <span class="hljs-keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)
        newlen *= <span class="hljs-number">2</span>;
    <span class="hljs-keyword">else</span>
        newlen += SDS_MAX_PREALLOC;
    type = sdsReqType(newlen);

    <span class="hljs-keyword">if</span> (type == SDS_TYPE_5) type = SDS_TYPE_8;

    hdrlen = sdsHdrSize(type);
    <span class="hljs-keyword">if</span> (oldtype == type) &#123; <span class="hljs-comment">// å¦‚æœ sds ç±»å‹æœªå˜ï¼Œrealloc è°ƒæ•´å†…å­˜</span>
        newsh = s_realloc(sh, hdrlen + newlen + <span class="hljs-number">1</span>); 
        <span class="hljs-keyword">if</span> (newsh == <span class="hljs-literal">NULL</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
        s = (<span class="hljs-keyword">char</span> *)newsh + hdrlen; <span class="hljs-comment">// s æŒ‡å‘ buf</span>
    &#125;
    <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// å¦‚æœ sds ç±»å‹å˜åŒ–äº†ï¼Œéœ€è¦è°ƒæ•´ header</span>
        newsh = s_malloc(hdrlen + newlen + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (newsh == <span class="hljs-literal">NULL</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
        <span class="hljs-built_in">memcpy</span>((<span class="hljs-keyword">char</span> *)newsh + hdrlen, s, len + <span class="hljs-number">1</span>); <span class="hljs-comment">// æ‹·è´åˆ°æ–°çš„å­—ç¬¦ä¸²</span>
        s_free(sh); <span class="hljs-comment">// é‡Šæ”¾ old å­—ç¬¦ä¸²</span>
        s = (<span class="hljs-keyword">char</span> *)newsh + hdrlen;
        s[<span class="hljs-number">-1</span>] = type; <span class="hljs-comment">// è®¾ç½® flag</span>
        sdssetlen(s, len);
    &#125;
    sdssetalloc(s, newlen);
    <span class="hljs-keyword">return</span> s;
&#125;</code></pre></div><hr><p>SDS è¿˜æœªä¸Šå±‚æä¾›äº†è®¸å¤šå…¶ä»– APIï¼Œç¯‡å¹…æœ‰é™ï¼Œä¸å†èµ˜è¿°ã€‚</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/3dbe6014.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">golang åŒ…å¯¼å…¥çš„ä¸€äº›é—®é¢˜</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/e8a575f7.html"><span class="hidden-mobile">linux å¸¸ç”¨åˆ°çš„æ–‡ä»¶åŒæ­¥æ–¹æ³•</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis åŸºæœ¬æ•°æ®ç»“æ„ä¹‹ SDS&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>