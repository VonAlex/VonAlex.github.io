

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png">
  <link rel="icon" type="image/png" href="/images/dolphin.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Happen">
  <meta name="keywords" content="">
  <title>irqbalance 详解之一 - HappenのMemo</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>HappenのMemo</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/images/about-banner.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Happen
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2018-06-29 10:38" pubdate>
        2018年6月29日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      33
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">irqbalance 详解之一</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2018年6月29日 上午
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <p>irqbalance 是什么？<a target="_blank" rel="noopener" href="https://github.com/Irqbalance/irqbalance">项目主页 </a> 上有以下描述：</p>
<blockquote>
<p>Irqbalance is a daemon to help balance the cpu load generated by interrupts across all of a systems cpus.</p>
</blockquote>
<!--more---->
<p>它避免了单 cpu 负载过重情况的出现。用法如下：</p>
<div class="hljs"><pre><code class="hljs gherkin">root<span class="hljs-meta">@a7661ef9b2f8</span> test]<span class="hljs-comment"># irqbalance -h</span>
irqbalance: option requires an argument -- &#x27;h&#x27;
irqbalance [--oneshot |<span class="hljs-string"> -o] [--debug </span>|<span class="hljs-string"> -d] [--foreground </span>|<span class="hljs-string"> -f] [--hintpolicy= </span>|<span class="hljs-string"> -h [exact</span>|<span class="hljs-string">subset</span>|<span class="hljs-string">ignore]] [--banscript= </span>|<span class="hljs-string"> -b &lt;script&gt;]</span>
<span class="hljs-string">	[--powerthresh= </span>|<span class="hljs-string"> -p &lt;off&gt; </span>|<span class="hljs-string"> &lt;n&gt;] [--banirq= </span>|<span class="hljs-string"> -i &lt;n&gt;] [--policyscript= </span>|<span class="hljs-string"> -l &lt;script&gt;] [--pid= </span>|<span class="hljs-string"> -s &lt;file&gt;] [--deepestcache= </span>|<span class="hljs-string"> -c &lt;n&gt;]</span></code></pre></div>
<h2 id="code￼1"><div class="hljs"><pre><code class="hljs routeros"><span class="hljs-comment"># 查看当前运行情况</span>
service irqbalance status

<span class="hljs-comment"># 终止服务</span>
service irqbalance stop</code></pre></div></h2>
<p>首先有一些前置知识需要说明，这涉及到 irqbalance cputree 的分层。</p>
<h3 id="前置知识">前置知识</h3>
<h4 id="中断">中断</h4>
<p>每个硬件设备都需要和 CPU 有某种形式的通信以便 CPU 及时知道发生了什么，这样 CPU 可能就会放下手中的事情去处理应急事件，硬件设备主动打扰 CPU 的现象就可称为硬件中断。就像正在一心一意的写代码时，突然钉钉“噔噔”地响起来，这时我们就知道有事情需要处理，这里的“噔噔”声就可以理解成一次中断。<br>
CPU 和硬件沟通的方式中，还有一种叫做轮询（polling），就是让 CPU 定时对硬件状态进行查询然后做相应处理，这比较浪费 CPU，属于一种硬件被动的方式。相比下来，硬件主动的方式（中断）更有效一些。<br>
那每个硬件设备都有中断，很简单啊，给它们分个唯一的号码，也就是 irq 号，在 <code>/proc/interrupts</code> 文件中的第一列可以看到所有的 irq。<br>
只有 kernel 2.4 以后的版本才支持的把不同的硬件中断请求（IRQs）分配到特定的 CPU 上的绑定技术被称为 SMP IRQ Affinity，这个后面还会详细说。</p>
<h4 id="NUMA 架构">NUMA 架构</h4>
<p>简要介绍一下 NUMA 架构。<br>
NUMA 架构出现前，CPU 频率一路欢脱越来越高，直至碰到物理极限的天花板，后转向核数越来越多的方向发展。</p>
<blockquote>
<p>如果每个 core 的工作性质都是 share-nothing（类似于 map-reduce 的 node 节点的作业属性），那么也许就不会有 NUMA。由于所有 CPU Core 都是通过共享一个北桥来读取内存，随着核数如何的发展，<strong>北桥</strong> 在响应时间上的性能瓶颈越来越明显。于是，聪明的硬件设计师们，先到了把内存控制器（原本北桥中读取内存的部分）也做个拆分，平分到了每个 die 上。于是 NUMA 就出现了！<br>
NUMA 架构中，内存访问有远近之分，只有当 CPU 访问自身直接 attach 内存对应的物理地址时，才会有较短的响应时间（Local Access）。而如果需要访问其他 CPU attach 的内存的数据时，就需要通过 inter-connect 通道访问，响应时间就相比之前变慢了（Remote Access），NUMA（Non-Uniform Memory Access）就此得名。    — 引自 <a target="_blank" rel="noopener" href="http://cenalulu.github.io/linux/numa/">http://cenalulu.github.io/linux/numa/</a></p>
</blockquote>
<p>图画下来大概是下面这个样子：<br>
<img src="https://s1.ax1x.com/2018/10/28/icwcV0.jpg" srcset="/img/loading.gif" width="600" /></p>
<p><code>numactl --hardware</code> 命令可以查看的那个机器的 numa 拓扑，比如这台机器：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>d2b9eb755bb1 ~]# numactl --hardware
available: <span class="hljs-number">2</span> nodes (<span class="hljs-number">0</span><span class="hljs-number">-1</span>)
node <span class="hljs-number">0</span> cpus: <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">10</span> <span class="hljs-number">11</span> <span class="hljs-number">24</span> <span class="hljs-number">25</span> <span class="hljs-number">26</span> <span class="hljs-number">27</span> <span class="hljs-number">28</span> <span class="hljs-number">29</span> <span class="hljs-number">30</span> <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">35</span>
node <span class="hljs-number">0</span> size: <span class="hljs-number">130946</span> MB
node <span class="hljs-number">0</span> free: <span class="hljs-number">9892</span> MB
node <span class="hljs-number">1</span> cpus: <span class="hljs-number">12</span> <span class="hljs-number">13</span> <span class="hljs-number">14</span> <span class="hljs-number">15</span> <span class="hljs-number">16</span> <span class="hljs-number">17</span> <span class="hljs-number">18</span> <span class="hljs-number">19</span> <span class="hljs-number">20</span> <span class="hljs-number">21</span> <span class="hljs-number">22</span> <span class="hljs-number">23</span> <span class="hljs-number">36</span> <span class="hljs-number">37</span> <span class="hljs-number">38</span> <span class="hljs-number">39</span> <span class="hljs-number">40</span> <span class="hljs-number">41</span> <span class="hljs-number">42</span> <span class="hljs-number">43</span> <span class="hljs-number">44</span> <span class="hljs-number">45</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span>
node <span class="hljs-number">1</span> size: <span class="hljs-number">131072</span> MB
node <span class="hljs-number">1</span> free: <span class="hljs-number">35969</span> MB
node distances:
node   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>
  <span class="hljs-number">0</span>:  <span class="hljs-number">10</span>  <span class="hljs-number">21</span>
  <span class="hljs-number">1</span>:  <span class="hljs-number">21</span>  <span class="hljs-number">10</span></code></pre></div>
<p>或者用这个脚本也行:</p>
<div class="hljs"><pre><code class="hljs gradle">[root@d2b9eb755bb1 ~]# <span class="hljs-keyword">for</span> i in `ls <span class="hljs-regexp">/sys/</span>devices<span class="hljs-regexp">/system/</span>node | <span class="hljs-keyword">grep</span> node`;<span class="hljs-keyword">do</span> echo -ne <span class="hljs-string">&quot;$i\t&quot;</span>;cat <span class="hljs-regexp">/sys/</span>devices<span class="hljs-regexp">/system/</span>node<span class="hljs-regexp">/$i/</span>cpulist;done
node0	<span class="hljs-number">0</span>-<span class="hljs-number">11</span>,<span class="hljs-number">24</span>-<span class="hljs-number">35</span>
node1	<span class="hljs-number">12</span>-<span class="hljs-number">23</span>,<span class="hljs-number">36</span>-<span class="hljs-number">47</span></code></pre></div>
<p>或者用 <code>lscpu</code> 这个命令，</p>
<div class="hljs"><pre><code class="hljs yaml">[<span class="hljs-string">root@d2b9eb755bb1</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># lscpu</span>
<span class="hljs-attr">Architecture:</span>          <span class="hljs-string">x86_64</span>
<span class="hljs-string">CPU</span> <span class="hljs-string">op-mode(s):</span>        <span class="hljs-number">32</span><span class="hljs-string">-bit,</span> <span class="hljs-number">64</span><span class="hljs-string">-bit</span>
<span class="hljs-attr">Byte Order:</span>            <span class="hljs-string">Little</span> <span class="hljs-string">Endian</span>
<span class="hljs-string">CPU(s):</span>                <span class="hljs-number">48</span>
<span class="hljs-string">On-line</span> <span class="hljs-string">CPU(s)</span> <span class="hljs-attr">list:</span>   <span class="hljs-number">0</span><span class="hljs-number">-47</span>
<span class="hljs-string">Thread(s)</span> <span class="hljs-attr">per core:</span>    <span class="hljs-number">2</span>
<span class="hljs-string">Core(s)</span> <span class="hljs-attr">per socket:</span>    <span class="hljs-number">12</span>
<span class="hljs-string">Socket(s):</span>             <span class="hljs-number">2</span>
<span class="hljs-string">NUMA</span> <span class="hljs-string">node(s):</span>          <span class="hljs-number">2</span>
<span class="hljs-attr">Vendor ID:</span>             <span class="hljs-string">GenuineIntel</span>
<span class="hljs-attr">CPU family:</span>            <span class="hljs-number">6</span>
<span class="hljs-attr">Model:</span>                 <span class="hljs-number">79</span>
<span class="hljs-attr">Stepping:</span>              <span class="hljs-number">1</span>
<span class="hljs-attr">CPU MHz:</span>               <span class="hljs-number">2197.264</span>
<span class="hljs-attr">BogoMIPS:</span>              <span class="hljs-number">4401.60</span>
<span class="hljs-attr">Virtualization:</span>        <span class="hljs-string">VT-x</span>
<span class="hljs-attr">L1d cache:</span>             <span class="hljs-string">32K</span>
<span class="hljs-attr">L1i cache:</span>             <span class="hljs-string">32K</span>
<span class="hljs-attr">L2 cache:</span>              <span class="hljs-string">256K</span>
<span class="hljs-attr">L3 cache:</span>              <span class="hljs-string">30720K</span>
<span class="hljs-string">NUMA</span> <span class="hljs-string">node0</span> <span class="hljs-string">CPU(s):</span>     <span class="hljs-number">0</span><span class="hljs-number">-11</span><span class="hljs-string">,24-35</span>
<span class="hljs-string">NUMA</span> <span class="hljs-string">node1</span> <span class="hljs-string">CPU(s):</span>     <span class="hljs-number">12</span><span class="hljs-number">-23</span><span class="hljs-string">,36-47</span></code></pre></div>
<h4 id="CPU- 相关">CPU 相关</h4>
<p>cpu cache 结构图如下：<br>
<img src="https://s1.ax1x.com/2018/10/28/icww8g.jpg" srcset="/img/loading.gif" width="650" /><br>
从硬件的角度，上图的 L1 和 L2 Cache 都被两个 HT 共享，且在同一个物理 Core。而 L3 Cache 则在物理 CPU 里，被多个 Core 来共享。 而从 OS 内核角度，每个 HT 都是一个逻辑 CPU。<br>
以 <strong>cpu0</strong> 为例，如下：</p>
<div class="hljs"><pre><code class="hljs gradle">[root@d2b9eb755bb1 ~]# tree -L <span class="hljs-number">1</span> <span class="hljs-regexp">/sys/</span>devices<span class="hljs-regexp">/system/</span>cpu<span class="hljs-regexp">/cpu0/</span>cache/
<span class="hljs-regexp">/sys/</span>devices<span class="hljs-regexp">/system/</span>cpu<span class="hljs-regexp">/cpu0/</span>cache/
├── index0   -&gt; L1 data 缓存
├── index1   -&gt; L1 Instruction 缓存
├── index2   -&gt; L2 缓存
└── index3   -&gt; L3 缓存</code></pre></div>
<p>点到为止，想了解更多可以翻翻以前的课本。更多 cpu 信息可以从 <code>/proc/cpuinfo</code> 文件中获取到。</p>
<h4 id="irq- 亲缘绑定">irq 亲缘绑定</h4>
<p>下面基于实践简单说下这个事情。<br>
<code>/proc/interrupts</code> 文件中可以看到各个 cpu 上的中断情况。<br>
<code>/proc/irq/#/smp_affinity_list</code> 可以查看指定中断当前绑定的 CPU，当然也 可以看 <code>smp_affinity</code> 这个文件，它是一个 16 进制 bitmask，以逗号分隔，比如 <code>0000,00000020</code>表示该 irq 分给了 CPU5。</p>
<p>所以，通过如下脚本获得 <strong> 各网卡中断 </strong> 的当前 cpu 的整体情况（平时只对网卡中断感兴趣）：</p>
<div class="hljs"><pre><code class="hljs gradle">cat <span class="hljs-regexp">/proc/i</span>nterrupts | <span class="hljs-keyword">grep</span> eth0- | cut -d: -f1 | <span class="hljs-keyword">while</span> <span class="hljs-keyword">read</span> i; <span class="hljs-keyword">do</span> echo -ne irq<span class="hljs-string">&quot;:$i\t bind_cpu: &quot;</span>; cat <span class="hljs-regexp">/proc/i</span>rq<span class="hljs-regexp">/$i/</span>smp_affinity_list; done | <span class="hljs-keyword">sort</span> -n -t<span class="hljs-string">&#x27; &#x27;</span> -k3</code></pre></div>
<p>效果大约是这样的：</p>
<div class="hljs"><pre><code class="hljs angelscript">irq:<span class="hljs-number">113</span>	 bind_cpu: <span class="hljs-number">0</span>
irq:<span class="hljs-number">117</span>	 bind_cpu: <span class="hljs-number">1</span>
irq:<span class="hljs-number">136</span>	 bind_cpu: <span class="hljs-number">2</span>
irq:<span class="hljs-number">109</span>	 bind_cpu: <span class="hljs-number">3</span>
irq:<span class="hljs-number">137</span>	 bind_cpu: <span class="hljs-number">4</span>
irq:<span class="hljs-number">106</span>	 bind_cpu: <span class="hljs-number">5</span>
irq:<span class="hljs-number">112</span>	 bind_cpu: <span class="hljs-number">6</span>
irq:<span class="hljs-number">111</span>	 bind_cpu: <span class="hljs-number">7</span>
irq:<span class="hljs-number">115</span>	 bind_cpu: <span class="hljs-number">8</span>
irq:<span class="hljs-number">149</span>	 bind_cpu: <span class="hljs-number">8</span>
irq:<span class="hljs-number">152</span>	 bind_cpu: <span class="hljs-number">8</span>
irq:<span class="hljs-number">133</span>	 bind_cpu: <span class="hljs-number">9</span>
irq:<span class="hljs-number">110</span>	 bind_cpu: <span class="hljs-number">10</span>
irq:<span class="hljs-number">114</span>	 bind_cpu: <span class="hljs-number">11</span>
irq:<span class="hljs-number">130</span>	 bind_cpu: <span class="hljs-number">24</span>
irq:<span class="hljs-number">148</span>	 bind_cpu: <span class="hljs-number">24</span>
irq:<span class="hljs-number">131</span>	 bind_cpu: <span class="hljs-number">25</span>
irq:<span class="hljs-number">139</span>	 bind_cpu: <span class="hljs-number">26</span>
irq:<span class="hljs-number">118</span>	 bind_cpu: <span class="hljs-number">27</span>
irq:<span class="hljs-number">132</span>	 bind_cpu: <span class="hljs-number">27</span>
irq:<span class="hljs-number">123</span>	 bind_cpu: <span class="hljs-number">28</span>
irq:<span class="hljs-number">128</span>	 bind_cpu: <span class="hljs-number">28</span>
irq:<span class="hljs-number">134</span>	 bind_cpu: <span class="hljs-number">28</span>
irq:<span class="hljs-number">142</span>	 bind_cpu: <span class="hljs-number">28</span>
irq:<span class="hljs-number">150</span>	 bind_cpu: <span class="hljs-number">28</span>
irq:<span class="hljs-number">135</span>	 bind_cpu: <span class="hljs-number">29</span>
irq:<span class="hljs-number">108</span>	 bind_cpu: <span class="hljs-number">30</span>
irq:<span class="hljs-number">116</span>	 bind_cpu: <span class="hljs-number">31</span>
irq:<span class="hljs-number">119</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">124</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">126</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">127</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">138</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">151</span>	 bind_cpu: <span class="hljs-number">32</span>
irq:<span class="hljs-number">107</span>	 bind_cpu: <span class="hljs-number">33</span>
irq:<span class="hljs-number">121</span>	 bind_cpu: <span class="hljs-number">34</span>
irq:<span class="hljs-number">140</span>	 bind_cpu: <span class="hljs-number">34</span>
irq:<span class="hljs-number">120</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">122</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">125</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">129</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">141</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">143</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">144</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">145</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">146</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">147</span>	 bind_cpu: <span class="hljs-number">35</span>
irq:<span class="hljs-number">153</span>	 bind_cpu: <span class="hljs-number">35</span></code></pre></div>
<p>可以看到，我这台机器有一半 cpu 是空闲的，已经绑定的 cpu 绑定的 irq 也不太均衡。<br>
假如要更改的话，可以有如下类似的操作 <code>echo 3 &gt; /proc/irq/24/smp_affinity</code>。<br>
这个也是后面 irqbalance 用来调整中断的方法。</p>
<h3 id="irqbalance- 代码分析">irqbalance 代码分析</h3>
<p>下面以 v1.07 为例来进行分析。</p>
<p>irqbalance 中把中断分成了 8 种 class, 4 种 type。</p>
<div class="hljs"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span>
<span class="hljs-comment"> * IRQ Classes</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_OTHER       0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_LEGACY      1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_SCSI        2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_VIDEO       3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_ETH         4</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_GBETH       5</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_10GBETH     6</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_VIRT_EVENT  7</span>

<span class="hljs-comment">/*</span>
<span class="hljs-comment"> * IRQ Types</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_TYPE_LEGACY     0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_TYPE_MSI        1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_TYPE_MSIX       2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IRQ_TYPE_VIRT_EVENT 3</span></code></pre></div>
<p>为啥是 8 种 class 呢？这个是依据 pci 设备初始化时注册的类型，可以通过以下脚本来查看</p>
<div class="hljs"><pre><code class="hljs mel">[root@d2b9eb755bb1 ~]# <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">`ls /sys/bus/pci/devices/*/class`</span>;<span class="hljs-keyword">do</span> echo $((<span class="hljs-string">`cat $i`</span> &gt;&gt; <span class="hljs-number">16</span>));done  | <span class="hljs-keyword">sort</span> -nu | wc -l
<span class="hljs-number">8</span></code></pre></div>
<p>以上的 class 对应 IRQ Classes 使用如下的数组：</p>
<div class="hljs"><pre><code class="hljs autohotkey">static short class_codes[MAX_CLASS] = &#123;
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_SCSI,</span>
<span class="hljs-built_in">	IRQ_ETH,</span>
<span class="hljs-built_in">	IRQ_VIDEO,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_LEGACY,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_LEGACY,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_LEGACY,</span>
<span class="hljs-built_in">	IRQ_ETH,</span>
<span class="hljs-built_in">	IRQ_SCSI,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
<span class="hljs-built_in">	IRQ_OTHER,</span>
&#125;<span class="hljs-comment">;</span></code></pre></div>
<p><code>MAX_CLASS = 0x12</code> 即 18。<br>
不同 class 的中断平衡的时候作用域不同，有的在 PACKAGE，有的在 CACHE，有的在 CORE。这个关系对应依靠以下数组进行转换:</p>
<div class="hljs"><pre><code class="hljs mipsasm">int map_class_to_level[<span class="hljs-number">8</span>] =
&#123; <span class="hljs-keyword">BALANCE_PACKAGE, </span><span class="hljs-keyword">BALANCE_CACHE, </span><span class="hljs-keyword">BALANCE_CORE, </span><span class="hljs-keyword">BALANCE_CORE, </span><span class="hljs-keyword">BALANCE_CORE, </span><span class="hljs-keyword">BALANCE_CORE, </span><span class="hljs-keyword">BALANCE_CORE, </span><span class="hljs-keyword">BALANCE_CORE </span>&#125;;</code></pre></div>
<p>irqbalance 会根据 cpu 的结构由上到下建立了一个树形结构，最顶层是 numa_nodes，向下以此为 CPU packages、Cache domains 以及 CPU cores，自顶向下。</p>
<p>irqbalance 的主函数很简单，10s 一个周期，做以下事情：<br>
【1】清除上次统计结果<br>
【2】分析中断情况<br>
【3】分析中断的负载情况<br>
【4】计算如何平衡中断<br>
【5】实施上面指定的方案</p>
<div class="hljs"><pre><code class="hljs reasonml"><span class="hljs-comment">// irqbalance.c</span>
<span class="hljs-built_in">int</span> main(<span class="hljs-built_in">int</span> argc, <span class="hljs-built_in">char</span>** argv) &#123;
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">while</span> (keep_going) &#123;
        sleep<span class="hljs-constructor">_approx(SLEEP_INTERVAL)</span>; <span class="hljs-comment">// 10s</span>
        clear<span class="hljs-constructor">_work_stats()</span>;
truetrue parse<span class="hljs-constructor">_proc_interrupts()</span>;
truetrue parse<span class="hljs-constructor">_proc_stat()</span>;
truetrue <span class="hljs-comment">// ...</span>
truetrue <span class="hljs-comment">// ...</span>
truetruecalculate<span class="hljs-constructor">_placement()</span>;
truetrueactivate<span class="hljs-constructor">_mappings()</span>;
truetrue<span class="hljs-comment">// ...</span>
    &#125;
    <span class="hljs-comment">// ...</span>
&#125;</code></pre></div>
<p>中断最终是运行在某一个 cpu 上的，所以有的中断虽然分配在 cache、package 层次上，但是最终还是在 cpu 上运行，所有每个 cpu 执行中断数大概等于所有父节点的中断数一级一级平均下来。然后用该 cpu 的负载除以该 cpu 平均处理的中断数，得到单位中断所占用的负载，那么每个中断的负载就等于该中断在单位时间内新增的个数乘以单位中断所占用的负载。那问题来了，如何计算负载的呢？<br>
答案是通过<code>/proc/stat</code> 文件的 <strong>irq + softirq</strong> 获得的，以 cpu0 为例，一个可能的数据如下：</p>
<div class="hljs"><pre><code class="hljs angelscript">cpu0 <span class="hljs-number">200118431</span> <span class="hljs-number">1258</span> <span class="hljs-number">112897097</span> <span class="hljs-number">1062445972</span> <span class="hljs-number">321829</span> <span class="hljs-number">0</span> <span class="hljs-number">1048436</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></code></pre></div>
<p>以上的数组表示从系统启动开始累计到当前时刻的 <strong>jiffies</strong>数(jiffies 是内核中的一个全局变量，用来记录自系统启动一来产生的节拍数，在 linux 中，一个节拍大致可理解为操作系统进程调度的最小时间片，不同 linux 内核可能值有不同，通常在 1ms 到 10ms 之间)。<br>
以上各字段的含义如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">数值</th>
<th style="text-align:left">参数</th>
<th style="text-align:right">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">200118431</td>
<td style="text-align:left">user</td>
<td style="text-align:right">处于用户态的运行时间，不包含 nice 值为负进程。</td>
</tr>
<tr>
<td style="text-align:left">1258</td>
<td style="text-align:left">nice</td>
<td style="text-align:right">nice 值为负的进程所占用的 CPU 时间</td>
</tr>
<tr>
<td style="text-align:left">112897097</td>
<td style="text-align:left">system</td>
<td style="text-align:right">处于核心态的运行时间</td>
</tr>
<tr>
<td style="text-align:left">1062445972</td>
<td style="text-align:left">idle</td>
<td style="text-align:right">除 IO 等待时间以外的其它等待时间</td>
</tr>
<tr>
<td style="text-align:left">321829</td>
<td style="text-align:left">iowait</td>
<td style="text-align:right">IO 等待时间(since 2.5.41)</td>
</tr>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">irq</td>
<td style="text-align:right">硬中断时间</td>
</tr>
<tr>
<td style="text-align:left">1048436</td>
<td style="text-align:left">softirq</td>
<td style="text-align:right">软中断时间</td>
</tr>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">steal</td>
<td style="text-align:right">-</td>
</tr>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">guest</td>
<td style="text-align:right">-</td>
</tr>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">guest_nice</td>
<td style="text-align:right">-</td>
</tr>
</tbody>
</table>
<p>具体可以看 <a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man5/proc.5.html">/proc 目录详解</a>。<br>
所以，<code>cpu-&gt;last_load = (irq_load + softirq_load)</code>。<br>
每个 CORE 的负载是附在上面的中断的负载的总和，<br>
每个 DOMAIN 是包含的 CORE 的总和，<br>
每个 PACKAGE 包含的 DOMAIN 的总和，就像树层次一样的计算。</p>
<p>关于如何平衡上面得到的 load 值呢？下一篇再做讲解。</p>
<p><strong>To be continued…</strong></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/linux/">linux</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/shell/">shell</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/fe52c850.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">dstat 工具使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/1f742d6d.html">
                        <span class="hidden-mobile">从 tcpdump 抓包看 TCP/IP 协议</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw">
    <script type="text/javascript">
      function loadLivere() {
        addScript('https://cdn-city.livere.com/js/embed.dist.js');
      }
      waitElementVisible('lv-container', loadLivere);
    </script>
    <noscript>为正常使用来必力评论功能请允许 JavaScript 运行</noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 2,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "irqbalance 详解之一&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
