<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§» (2) - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-04-02 18:40" pubdate>2020-04-02 18:40</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.1k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 29 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§» (2)</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2020-04-02 18:40</p><div class="markdown-body" id="post-body"><p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œè¯¦ç»†è®²è§£äº† redis cluster ä¸­è¯´æ•°æ®è¿ç§»çš„æµç¨‹ï¼Œé‚£åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹å¯¹æ­£å¸¸ç”¨æˆ·è®¿é—®æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ<br>æœ¬ç¯‡æ–‡ç« å°†æ¢è®¨ä¸€ä¸‹ã€‚</p><!--more----><h3 id="processCommand- å‡½æ•°å¤„ç†"><a href="#processCommand- å‡½æ•°å¤„ç†" class="headerlink" title="processCommand å‡½æ•°å¤„ç†"></a>processCommand å‡½æ•°å¤„ç†</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œ<code>processCommand</code> å‡½æ•°è´Ÿè´£å¤„ç†å…·ä½“çš„å‘½ä»¤å¤„ç†è¿‡ç¨‹ï¼Œ</p><p>åœ¨ cluster æ¨¡å¼ä¸‹ï¼Œæ­¤å‡½æ•°ä¸­ä¼šè¿›è¡Œ cluster é‡å®šå‘ï¼Œä½† 2 ç§æƒ…å†µé™¤å¤–ï¼š</p><ul><li>å‘é€å‘½ä»¤çš„æ˜¯æˆ‘çš„ master</li><li>å‘é€çš„å‘½ä»¤æ²¡æœ‰ key å‚æ•°</li></ul><p>å…·ä½“ä»£ç ï¼Œå¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (server.cluster_enabled &amp;&amp;
Â Â Â Â !(c-&gt;flags &amp; CLIENT_MASTER) &amp;&amp;
    !(c-&gt;flags &amp; CLIENT_LUA &amp;&amp;
    server.lua_caller-&gt;flags &amp; CLIENT_MASTER) &amp;&amp;
    !(c-&gt;cmd-&gt;getkeys_proc == <span class="hljs-literal">NULL</span> &amp;&amp; c-&gt;cmd-&gt;firstkey == <span class="hljs-number">0</span> &amp;&amp;
    c-&gt;cmd-&gt;proc != execCommand))
&#123;
Â Â Â Â <span class="hljs-keyword">int</span> hashslot;
    <span class="hljs-keyword">int</span> error_code;
    clusterNode *n = getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,
                                        &amp;hashslot,&amp;error_code);
    <span class="hljs-keyword">if</span> (n == <span class="hljs-literal">NULL</span> || n != server.cluster-&gt;myself) &#123;
    Â Â Â Â <span class="hljs-keyword">if</span> (c-&gt;cmd-&gt;proc == execCommand) &#123;
        Â Â Â Â discardTransaction(c);
        &#125; <span class="hljs-keyword">else</span> &#123;
            flagTransaction(c);
        &#125;
        clusterRedirectClient(c,n,hashslot,error_code);
        <span class="hljs-keyword">return</span> C_OK;
    &#125;
&#125;</code></pre></div><p>ç”±ä¸Šå¯ä»¥çœ‹å‡ºï¼Œä»£ç ä¸­ä½¿ç”¨ <code>getNodeByQuery</code> å‡½æ•°è´Ÿè´£å¤„ç† hashslot çš„èŠ‚ç‚¹ nã€‚<br>å¦‚æœ n æ˜¯ç©ºçš„ï¼Œæˆ–è€…ä¸æ˜¯æˆ‘è‡ªå·±ï¼Œé‚£ä¹ˆå°±éœ€è¦åšä¸€ä¸ª cluster çš„ redirectionï¼Œä½¿ç”¨ <code>clusterRedirectClient</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯é’ˆå¯¹ <code>getNodeByQuery</code> å‡½æ•°è¿”å›çš„ä¸åŒé”™è¯¯ç ï¼Œç»™ client ä¸åŒçš„è¿”å›ä¿¡æ¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterRedirectClient</span><span class="hljs-params">(client *c, clusterNode *n, <span class="hljs-keyword">int</span> hashslot, <span class="hljs-keyword">int</span> error_code)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (error_code == CLUSTER_REDIR_CROSS_SLOT) &#123;
        addReplySds(c,sdsnew(<span class="hljs-string">&quot;-CROSSSLOT Keys in request don&#x27;t hash to the same slot\r\n&quot;</span>));
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_code == CLUSTER_REDIR_UNSTABLE) &#123;
        addReplySds(c,sdsnew(<span class="hljs-string">&quot;-TRYAGAIN Multiple keys request during rehashing of slot\r\n&quot;</span>));
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_code == CLUSTER_REDIR_DOWN_STATE) &#123;
        addReplySds(c,sdsnew(<span class="hljs-string">&quot;-CLUSTERDOWN The cluster is down\r\n&quot;</span>));
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_code == CLUSTER_REDIR_DOWN_UNBOUND) &#123;
        addReplySds(c,sdsnew(<span class="hljs-string">&quot;-CLUSTERDOWN Hash slot not served\r\n&quot;</span>));
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_code == CLUSTER_REDIR_MOVED || error_code == CLUSTER_REDIR_ASK)
    &#123;
        addReplySds(c,sdscatprintf(sdsempty(),
            <span class="hljs-string">&quot;-%s %d %s:%d\r\n&quot;</span>,
            (error_code == CLUSTER_REDIR_ASK) ? <span class="hljs-string">&quot;ASK&quot;</span> : <span class="hljs-string">&quot;MOVED&quot;</span>,
            hashslot,n-&gt;ip,n-&gt;port));
    &#125; <span class="hljs-keyword">else</span> &#123;
        serverPanic(<span class="hljs-string">&quot;getNodeByQuery() unknown error.&quot;</span>);
    &#125;
&#125;</code></pre></div></p><p>æœ€åè¿”å› <code>C_OK</code>ï¼Œç»“æŸå‘½ä»¤å¤„ç†æµç¨‹ï¼Œå› ä¸ºæ¶‰åŠåˆ°çš„ slot ä¸æ˜¯æœ¬èŠ‚ç‚¹è´Ÿè´£ï¼</p><h3 id="getNodeByQuery- å‡½æ•°å¤„ç†"><a href="#getNodeByQuery- å‡½æ•°å¤„ç†" class="headerlink" title="getNodeByQuery å‡½æ•°å¤„ç†"></a>getNodeByQuery å‡½æ•°å¤„ç†</h3><p>ä¸‹é¢æ¥çœ‹ä¸‹æ¯”è¾ƒé‡è¦çš„ <code>getNodeByQuery</code> å‡½æ•°çš„å¤„ç†é€»è¾‘ï¼Œå®ƒç”¨æ¥è¿”å›è´Ÿè´£è®¿é—® slot çš„çœŸå®èŠ‚ç‚¹ã€‚</p><div class="hljs"><pre><code class="hljs c">multiState *ms, _ms;
multiCmd mc;
<span class="hljs-keyword">int</span> i, slot = <span class="hljs-number">0</span>, migrating_slot = <span class="hljs-number">0</span>, importing_slot = <span class="hljs-number">0</span>, missing_keys = <span class="hljs-number">0</span>;
<span class="hljs-comment">/* Set error code optimistically for the base case. */</span>
<span class="hljs-keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_NONE;
<span class="hljs-keyword">if</span> (cmd-&gt;proc == execCommand) &#123;
Â Â Â Â <span class="hljs-comment">/* If CLIENT_MULTI flag is not set EXEC is just going to return an</span>
<span class="hljs-comment"> Â Â Â Â * error. */</span>
Â Â Â Â <span class="hljs-keyword">if</span> (!(c-&gt;flags &amp; CLIENT_MULTI)) <span class="hljs-keyword">return</span> myself;
        ms = &amp;c-&gt;mstate;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">/* In order to have a single codepath create a fake Multi State</span>
<span class="hljs-comment">         * structure if the client is not in MULTI/EXEC state, this way</span>
<span class="hljs-comment">         * we have a single codepath below. */</span>
        ms = &amp;_ms;
        _ms.commands = &amp;mc;
        _ms.count = <span class="hljs-number">1</span>;
        mc.argv = argv;
        mc.argc = argc;
        mc.cmd = cmd;
&#125;</code></pre></div><p>å½“æ²¡æœ‰é”™è¯¯æ—¶ï¼Œè¯¥å‡½æ•°è¿”å›çš„é”™è¯¯ç æ˜¯ <strong>CLUSTER_REDIR_NONE</strong>ã€‚</p><p><strong>æ³¨æ„ </strong>ï¼š<br>å¦‚æœå½“å‰å¤„äºäº‹åŠ¡æ¨¡å¼ä¸‹ï¼Œåˆ™äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¸­çš„æ‰€æœ‰ keyï¼Œéœ€è¦ä¸€èµ·è¿›è¡Œåˆ¤æ–­ã€‚<br>å¯¹äºéäº‹åŠ¡æ¨¡å¼ä¸‹çš„å‘½ä»¤ï¼Œä¹ŸæŒ‰ç…§äº‹åŠ¡çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œåªä¸è¿‡æœ¬äº‹åŠ¡åªåŒ…å«å½“å‰ä¸€æ¡å‘½ä»¤ã€‚</p><p>å¦‚æœå½“å‰æ‰§è¡Œçš„å‘½ä»¤æ˜¯ <code>EXEC</code>ï¼Œå¹¶ä¸” client æ²¡æœ‰ <strong>CLIENT_MULTI</strong> æ ‡è®°ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› myselfï¼Œè¡¨ç¤ºè‡ªå·±èƒ½å¤„ç†è¿™ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨å‘½ä»¤å¤„ç†å‡½æ•° <code>execCommand</code> ä¸­ï¼Œä¼šç›´æ¥åé¦ˆç»™å®¢æˆ·ç«¯ <strong>EXEC without MULTI</strong> é”™è¯¯ã€‚<br>å¦åˆ™ï¼Œæ„é€ ä¼ªäº‹åŠ¡æ•°æ®ç»“æ„å˜é‡ <code>ms</code>ï¼Œå…¶ä¸­åªåŒ…å«å½“å‰å‘½ä»¤è¿™ä¸€æ¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œé’ˆå¯¹æ¯ä¸€æ¡å‘½ä»¤ï¼Œå³æ‰€æœ‰é€»è¾‘åŒ…è£¹åœ¨å¦‚ä¸‹å¾ªç¯é‡Œï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ms-&gt;count; i++) &#123;&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// æ¯ä¸€ä¸ªå‘½ä»¤çš„ç›¸å…³å‚æ•°</span>
mcmd = ms-&gt;commands[i].cmd;
margc = ms-&gt;commands[i].argc;
margv = ms-&gt;commands[i].argv;
keyindex = getKeysFromCommand(mcmd,margv,margc,&amp;numkeys);</code></pre></div><p><code>getKeysFromCommand</code> å‡½æ•°çš„è¿”å›å€¼ <code>keyindex</code> ä¸ºæœ¬æ¡å‘½ä»¤ä¸­æ‰€æœ‰ key çš„ index æ•°ç»„ï¼Œ<code>numkeys</code> åˆ™ä¸º key çš„ä¸ªæ•°ã€‚<br>æ¥ä¸‹æ¥å°±å¾ªç¯å¤„ç†æœ¬æ¡å‘½ä»¤ä¸­çš„æ‰€æœ‰ keyã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// å¾ªç¯å¤„ç†æ¯ä¸ª key</span>
<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; numkeys; j++) &#123;&#125;</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// æ‹¿åˆ° key</span>
robj *thiskey = margv[keyindex[j]];
<span class="hljs-comment">// æ‹¿åˆ°å¯¹åº”çš„ slot</span>
<span class="hljs-keyword">int</span> thisslot = keyHashSlot((<span class="hljs-keyword">char</span>*)thiskey-&gt;ptr, sdslen(thiskey-&gt;ptr));</code></pre></div><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (firstkey == <span class="hljs-literal">NULL</span>) &#123;
    <span class="hljs-comment">// å¦‚æœæ˜¯è¯¥å‘½ä»¤ä¸­çš„ä¸€ä¸ª keyï¼Œè®°å½•åˆ° firstkey é‡Œ</span>
Â Â Â Â firstkey = thiskey;
    slot = thisslot;
    n = server.cluster-&gt;slots[slot];
    <span class="hljs-comment">// æ‰¾ä¸åˆ°è´Ÿè´£è¯¥ slot çš„èŠ‚ç‚¹ï¼ŒæŠ¥é”™ &quot;-CLUSTERDOWN, unbound slot.&quot;</span>
    <span class="hljs-keyword">if</span> (n == <span class="hljs-literal">NULL</span>) &#123;
    Â Â Â Â getKeysFreeResult(keyindex);
        <span class="hljs-keyword">if</span> (error_code)
        Â Â Â Â *error_code = CLUSTER_REDIR_DOWN_UNBOUND;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
     &#125;
     <span class="hljs-comment">// æ˜¯æˆ‘è´Ÿè´£çš„ slotï¼Œå¹¶ä¸”è¯¥ slot æ­£åœ¨è¿å‡º key</span>
     <span class="hljs-keyword">if</span> (n == myself
         &amp;&amp; server.cluster-&gt;migrating_slots_to[slot] != <span class="hljs-literal">NULL</span>) &#123;
     Â Â Â Â migrating_slot = <span class="hljs-number">1</span>;
     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (server.cluster-&gt;importing_slots_from[slot] != <span class="hljs-literal">NULL</span>) &#123;
         importing_slot = <span class="hljs-number">1</span>;
     &#125;
&#125;</code></pre></div><p>è¿™é‡Œæœ‰ä¸ªé‡è¦çš„é€»è¾‘ã€‚<br>å½“è¦æ“ä½œçš„ key å¯¹åº”çš„ slot æ˜¯æˆ‘è´Ÿè´£çš„ï¼Œå¹¶ä¸”è¯¥ slot æ­£åœ¨è¿å‡º keyï¼Œé‚£ä¹ˆæ ‡è®° <code>migrating_slot = 1</code>ã€‚<br>å¦‚æœè¿™ä¸ª slot ä¸æ˜¯æˆ‘è´Ÿè´£çš„ï¼Œé‚£ä¹ˆæ ‡è®° <code>importing_slot = 1</code>ã€‚</p><p>å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ª keyï¼Œå°±è¦çœ‹ä¸‹ <strong>æ˜¯ä¸æ˜¯æ‰€æœ‰çš„ key éƒ½åœ¨ä¸€ä¸ª slot ä¸Š</strong>ï¼Œå¦åˆ™ï¼Œä¼šæŠ¥é”™ <strong>CROSSSLOT Keys in request donâ€™t hash to the same slot</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!equalStringObjects(firstkey,thiskey)) &#123;
Â Â Â Â <span class="hljs-keyword">if</span> (slot != thisslot) &#123;
       <span class="hljs-comment">/* Error: multiple keys from different slots. */</span>
    Â Â Â Â getKeysFreeResult(keyindex);
        <span class="hljs-keyword">if</span> (error_code)
        Â Â Â Â *error_code = CLUSTER_REDIR_CROSS_SLOT;
Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
     &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">/* Flag this request as one with multiple different keys. */</span>
         multiple_keys = <span class="hljs-number">1</span>;
     &#125;
&#125;</code></pre></div><p>æ‰€ä»¥ï¼Œå¯¹äºå¤š key æ“ä½œï¼Œæ¶‰åŠåˆ°çš„ key éœ€è¦åœ¨ä¸€ä¸ª slot ä¸Šï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><p>åŒæ—¶ï¼Œé‡åˆ°æ­£åœ¨è¿å…¥è¿å‡º key çš„ slot è¿˜è¦ç»Ÿè®¡ missing_keysï¼ˆæœ¬åœ°æ‰¾ä¸åˆ°çš„ keyï¼Œå¯èƒ½å·²ç»è¿ç§»åˆ°ç›®çš„åœ°äº†ï¼‰ã€‚å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((migrating_slot || importing_slot) &amp;&amp;
    lookupKeyRead(&amp;server.db[<span class="hljs-number">0</span>],thiskey) == <span class="hljs-literal">NULL</span>) &#123;
 Â Â Â Â missing_keys++;
&#125;</code></pre></div><p>ç»“æŸäº†æ¯ä¸ªå‘½ä»¤çš„å¤„ç†ï¼Œæ¥ç€å¾€ä¸‹èµ°ï¼Œå¯¹äºæœ‰è¿å…¥è¿å‡º slot çš„æƒ…å†µæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">// å‘½ä»¤é‡Œæ²¡æœ‰ keyï¼Œæœ¬èŠ‚ç‚¹å°±å¯ä»¥å¤„ç†ï¼Œè¿”å› myself</span>
<span class="hljs-keyword">if</span> (n == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> myself;

<span class="hljs-comment">// é›†ç¾¤çŠ¶æ€ä¸æ­£å¸¸ï¼Œè¿”å›é”™è¯¯ -CLUSTERDOWN</span>
<span class="hljs-keyword">if</span> (server.cluster-&gt;state != CLUSTER_OK) &#123;
Â Â Â Â <span class="hljs-keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_DOWN_STATE;
    Â Â Â Â <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
 &#125;

<span class="hljs-comment">// å¦‚æœæœ‰æ­£åœ¨è¿å…¥æˆ–è€…è¿å‡ºçš„ slotï¼Œä¸”æ­£æ‰§è¡Œçš„å‘½ä»¤æ˜¯ MIGRATEï¼Œè¿”å› myself</span>
<span class="hljs-comment">// MIGRATE å‘½ä»¤æ€»æ˜¯åœ¨æœ¬åœ°ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è¿è¡Œçš„</span>
<span class="hljs-keyword">if</span> ((migrating_slot || importing_slot) &amp;&amp; cmd-&gt;proc == migrateCommand)
Â Â Â Â <span class="hljs-keyword">return</span> myself;</code></pre></div><p>å¯¹äºè®¿é—®åˆ°è¿å…¥è¿å‡º slot ä¸­çš„ key çš„å¤„ç†ï¼Œå¦‚ä¸‹</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (migrating_slot &amp;&amp; missing_keys) &#123;
Â Â Â Â <span class="hljs-keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_ASK;
    <span class="hljs-keyword">return</span> server.cluster-&gt;migrating_slots_to[slot];
&#125;

<span class="hljs-keyword">if</span> (importing_slot &amp;&amp;
 (c-&gt;flags &amp; CLIENT_ASKING || cmd-&gt;flags &amp; CMD_ASKING)) &#123;
 Â Â Â Â <span class="hljs-keyword">if</span> (multiple_keys &amp;&amp; missing_keys) &#123;
 Â Â Â Â Â Â Â Â <span class="hljs-keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_UNSTABLE;
 Â Â Â Â Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
     &#125; <span class="hljs-keyword">else</span> &#123;
 Â Â Â Â Â Â Â Â <span class="hljs-comment">// å¦åˆ™è¿”å› myself</span>
 Â Â Â Â Â Â Â Â <span class="hljs-keyword">return</span> myself;
 Â Â Â Â &#125;
&#125;</code></pre></div><p>è‹¥è®¿é—®çš„ slot æ­£åœ¨åšè¿å‡ºï¼Œä¸”å­˜åœ¨æ­£å¸¸è®¿é—®çš„ key åœ¨æœ¬åœ°æŸ¥ä¸åˆ°ï¼Œé‚£ä¹ˆæŠ¥é”™ <strong>-ASK</strong>ï¼Œå¹¶è¿”å›è¯¥ key è¿ç§»åˆ°çš„ç›®çš„èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯è¿åˆ°ç›®çš„èŠ‚ç‚¹äº†ï¼‰ã€‚<br>è‹¥è®¿é—®çš„ slot æ­£åœ¨åšè¿å…¥ï¼Œä¸” client å¸¦æœ‰ <strong>CLIENT_ASKING</strong> æ ‡è®°ï¼Œæˆ–è€… cmd å¸¦æœ‰ <strong>CMD_ASKING</strong> çš„æ ‡è®°ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ¶‰åŠåˆ°å¤š key æ“ä½œï¼Œä¸”æœ‰çš„ key ä¸åœ¨å½“å‰èŠ‚ç‚¹ä¸­ï¼ŒæŠ¥é”™ <strong>-TRYAGAIN</strong>ï¼ˆåé¢é‡è¯•ï¼‰ï¼Œè¿”å› NULLã€‚å¦åˆ™ï¼Œè¿”å› myselfï¼ˆå› ä¸ºæ‰€æœ‰çš„ key æˆ‘éƒ½æœ‰å˜›ï¼‰ã€‚</p><hr><p>ç»è¿‡ä¸Šé¢ä¸¤æ¡åˆ†æï¼Œ<strong>ä¸‹é¢æ€»ç»“ä¸€ä¸‹ </strong>ï¼š<br>å½“è¦è®¿é—®çš„ slot æ°å¥½åœ¨åšè¿ç§»ï¼Œé‚£ä¹ˆ redis æœ‰å¦‚ä¸‹é€»è¾‘ã€‚<br><code>multiple_keys</code> å˜é‡è¡¨ç¤ºè¿™æ˜¯å¦æ˜¯ä¸ªå¤š key æ“ä½œã€‚<br><code>missing_keys</code> å˜é‡è¡¨ç¤ºï¼Œè¦è®¿é—®çš„ keyï¼Œæ˜¯å¦éƒ½åœ¨æœ¬èŠ‚ç‚¹ã€‚</p><p>å¯¹äºå• key æ“ä½œï¼Œ</p><ul><li><p>å†™ key æ—¶ï¼Œå› ä¸ºæœ¬åœ°æ²¡æœ‰è¿™ä¸ª keyï¼Œæ‰€ä»¥é€šè¿‡ ASK é”™è¯¯é‡å®šå‘åˆ°ç›®æ ‡èŠ‚ç‚¹è¿›è¡Œå†™å…¥æ“ä½œã€‚</p></li><li><p>è¯» key æ—¶ï¼Œå¦‚æœæœ¬åœ°èŠ‚ç‚¹æœ‰ï¼Œé‚£ä¹ˆåœ¨æœ¬åœ°èŠ‚ç‚¹è®¿é—®ï¼Œå¦åˆ™é€šè¿‡ ASK é”™è¯¯ï¼Œé‡å®šå‘åˆ°ç›®æ ‡èŠ‚ç‚¹è¿›è¡Œè¯»å–ã€‚</p></li></ul><p>å¯¹äºå¤š key æ“ä½œï¼Œ</p><ul><li><p>å†™ key æ—¶ï¼Œå› ä¸ºæœ¬åœ°æ²¡æœ‰è¿™äº› keyï¼Œæ‰€ä»¥é€šè¿‡ ASK é”™è¯¯é‡å®šå‘åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè€Œåœ¨ç›®æ ‡èŠ‚ç‚¹ä¸­ä¹Ÿæ²¡æœ‰è¿™äº› keyï¼Œè€Œä¸”åˆæ˜¯ä¸ªå¤š key æ“ä½œï¼Œé‚£ä¹ˆæŠ¥é”™ <strong>-TRYAGAIN</strong>ï¼Œåªèƒ½ç­‰åˆ°åé¢è¿™ä¸ª slot è¿ç§»å®Œæˆåæ‰èƒ½åšå¤š key å†™å…¥ã€‚</p></li><li><p>å¤š key æ—¶ï¼Œå¦‚æœæœ¬åœ°æœ‰æ‰€æœ‰çš„ keyï¼Œé‚£ä¹ˆæ­£å¸¸è¿”å›ã€‚å¦‚æœæœ¬åœ°åªæœ‰éƒ¨åˆ† keyï¼Œé‚£ä¹ˆé€šè¿‡ ASK é”™è¯¯é‡å®šå‘åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å…¨éƒ¨çš„ keyï¼Œé‚£ä¹ˆæ­£å¸¸è¿”å›ï¼Œå¦åˆ™æŠ¥é”™ <strong>-TRYAGAIN</strong>ã€‚ï¼ˆå¾…ä¼šå†æ¥è®¿é—®å§ï¼Œç­‰åˆ°æ‰€æœ‰çš„ key éƒ½è¿è¿‡æ¥ï¼‰</p></li></ul><hr><h3 id="MOVED- ä¸ -ASK- é‡å®šå‘"><a href="#MOVED- ä¸ -ASK- é‡å®šå‘" class="headerlink" title="MOVED ä¸ ASK é‡å®šå‘"></a>MOVED ä¸ ASK é‡å®šå‘</h3><p>å¦‚æœè®¿é—®åˆ°çš„ slot ä¸æ˜¯æˆ‘è´Ÿè´£çš„ï¼Œé‚£ä¹ˆæŠ¥é”™ <strong>-MOVED</strong>ï¼Œä¸”è¿”å›æ­£ç¡®çš„è´Ÿè´£èŠ‚ç‚¹ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (n != myself &amp;&amp; error_code) *error_code = CLUSTER_REDIR_MOVED;
Â Â Â Â <span class="hljs-keyword">return</span> n;</code></pre></div><p>å½“ç„¶ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ° <strong>MOVED</strong> å’Œ <strong>ASK</strong> é”™è¯¯çš„åŒºåˆ«ã€‚</p><ul><li><p><strong>ASK</strong> è¡¨ç¤ºï¼Œè¦è®¿é—®çš„ key æ‰€åœ¨çš„ slot å½“å‰æ­£åœ¨åšè¿ç§»ï¼Œå» ASK è¿å…¥èŠ‚ç‚¹å¤„ç†è¯·æ±‚ã€‚</p></li><li><p><strong>MOVED</strong> è¡¨ç¤ºï¼Œè¦è®¿é—®çš„ key æ‰€åœ¨çš„ slot ä¸ç”±æœ¬èŠ‚ç‚¹è´Ÿè´£ï¼ŒMOVED åˆ°æ­£ç¡®çš„èŠ‚ç‚¹å»è®¿é—®å§ã€‚</p></li></ul><p>æ¥æ”¶åˆ° ASK é”™è¯¯åï¼Œclient åº”è¯¥å…ˆå‘é€ <code>ASKING</code> å‘½ä»¤åˆ°è¿å…¥èŠ‚ç‚¹ï¼Œä½¿å¾— client å¸¦ä¸Š <code>CLIENT_ASKING</code> æ ‡è®°ï¼Œç„¶åå†å‘é€æ­£å¸¸å‘½ä»¤ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">askingCommand</span><span class="hljs-params">(client *c)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (server.cluster_enabled == <span class="hljs-number">0</span>) &#123;
        addReplyError(c,<span class="hljs-string">&quot;This instance has cluster support disabled&quot;</span>);
        <span class="hljs-keyword">return</span>;
    &#125;
    c-&gt;flags |= CLIENT_ASKING;
    addReply(c,shared.ok);
&#125;</code></pre></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/5a077de9.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis æºç åˆ†æä¹‹ key è¿‡æœŸ</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/91f7e3ff.html"><span class="hidden-mobile">Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§» (1)</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis æºç åˆ†æä¹‹æ•°æ®è¿ç§» (2)&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>