<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@1&family=Noto+Sans+TC&family=Noto+Serif+SC:wght@200;300&display=swap" rel="stylesheet"><link rel="preconnect" href="https://fonts.gstatic.com"><link rel="apple-touch-icon" sizes="76x76" href="/images/dolphin.png"><link rel="icon" type="image/png" href="/images/dolphin.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#433d3c"><meta name="description" content=""><meta name="author" content="Happen"><meta name="keywords" content=""><title>Redis Cluster write safety åˆ†æ - Happenã®Memo</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/rainbow.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.1.1"></head><body><header style="height:60vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Happenã®Memo</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(https://gitee.com/happencc/pics/raw/master/images/about-banner.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Happen </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-02-18 23:25" pubdate>2021-02-18 23:25</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.3k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 29 åˆ†é’Ÿ </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> æ¬¡</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Redis Cluster write safety åˆ†æ</h1><p class="note note-info">æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2021-02-18 23:25</p><div class="markdown-body" id="post-body"><p>redis cluster æ˜¯ redis çš„åˆ†å¸ƒå¼å®ç°ã€‚<br>å¦‚åŒå®˜æ–¹æ–‡æ¡£ <strong><a target="_blank" rel="noopener" href="https://redis.io/topics/cluster-spec">cluster-spec</a></strong> å¼ºè°ƒçš„é‚£æ ·ï¼Œå…¶è®¾è®¡ <strong>ä¼˜å…ˆè€ƒè™‘é«˜æ€§èƒ½å’Œçº¿æ€§æ‰©å±•èƒ½åŠ›ï¼Œå¹¶å°½æœ€å¤§åŠªåŠ›ä¿è¯ write safety</strong>ã€‚</p><a id="more"></a><p>è¿™é‡Œæ‰€è¯´çš„ write ä¸¢å¤±æ˜¯æŒ‡ï¼Œå›å¤ client ack åï¼Œåç»­è¯·æ±‚ä¸­å‡ºç°æ•°æ®æœªåšå˜æ›´æˆ–ä¸¢å¤±çš„æƒ…å†µï¼Œä¸»è¦æœ‰ä¸»ä»åˆ‡æ¢ã€å®ä¾‹é‡å¯ã€è„‘è£‚ç­‰ä¸‰ç§æƒ…å†µå¯èƒ½å¯¼è‡´è¯¥é—®é¢˜ï¼Œä¸‹é¢ä¾æ¬¡åˆ†æã€‚</p><h2 id="ä¸»ä»åˆ‡æ¢"><a href="# ä¸»ä»åˆ‡æ¢" class="headerlink" title="ä¸»ä»åˆ‡æ¢"></a>ä¸»ä»åˆ‡æ¢</h2><p>failover ä¼šå¸¦æ¥è·¯ç”±çš„å˜æ›´ï¼Œä¸»åŠ¨ / è¢«åŠ¨æƒ…å†µéœ€è¦åˆ†å¼€è®¨è®ºã€‚</p><h3 id="è¢«åŠ¨ -failover"><a href="# è¢«åŠ¨ -failover" class="headerlink" title="è¢«åŠ¨ failover"></a>è¢«åŠ¨ failover</h3><p>ä¸ºè¡¨è¾¾æ–¹ä¾¿ï¼Œæœ‰ä»¥ä¸‹å‡è®¾ï¼Œcluster çŠ¶æ€æ­£å¸¸ï¼Œ node C ä¸º masterï¼Œè´Ÿè´£ slot 1-100ï¼Œå¯¹åº” slave ä¸º Câ€™ã€‚</p><p>master C æŒ‚æ‰åï¼Œslave Câ€™ åœ¨ <strong>æœ€å¤š 2 å€ cluster_node_timeout çš„æ—¶é—´ </strong>å†…æŠŠ C æ ‡è®°æˆ FAILï¼Œè¿›è€Œè§¦å‘ failover é€»è¾‘ã€‚</p><p>åœ¨ slave Câ€™ æˆåŠŸåˆ‡æ¢ä¸º master å‰ï¼Œ1-100 slot ä»ç„¶ç”± C è´Ÿè´£ï¼Œè®¿é—®ä¼šæŠ¥é”™ã€‚<br>Câ€™ åˆ‡ä¸º master åï¼Œgossip å¹¿æ’­è·¯ç”±å˜æ›´ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œclient è®¿é—® Câ€™ï¼Œä»å¯ä»¥å¾—åˆ°æ­£å¸¸çš„å›åº”ï¼Œè€Œè®¿é—®å…¶ä»–æŒæœ‰è€è·¯ç”±çš„ nodeï¼Œè¯·æ±‚ä¼šè¢« MOVED åˆ°æŒ‚æ‰çš„ Cï¼Œè®¿é—®æŠ¥é”™ã€‚</p><p><strong>å”¯ä¸€å¯èƒ½å‡ºç° write ä¸¢å¤±çš„ case ç”±ä¸»ä»å¼‚æ­¥å¤åˆ¶æœºåˆ¶å¯¼è‡´ </strong>ã€‚<br>å¦‚æœå†™åˆ° master ä¸Šçš„æ•°æ®è¿˜æ²¡æœ‰æ¥å¾—åŠåŒæ­¥åˆ° slave å°±æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®å°±ä¼šä¸¢å¤±ï¼ˆ<strong>é‡å¯åä¸å­˜åœ¨ merge æ“ä½œ</strong>ï¼‰ã€‚master å›å¤ client ack ä¸åŒæ­¥ slave å‡ ä¹æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼Œä½†è¿™æ˜¯ä¸€ä¸ªé£é™©ï¼Œæ—¶é—´çª—å£å¾ˆå°ã€‚</p><h3 id="ä¸»åŠ¨ -failover"><a href="# ä¸»åŠ¨ -failover" class="headerlink" title="ä¸»åŠ¨ failover"></a>ä¸»åŠ¨ failover</h3><p>ä¸»åŠ¨ failover é€šè¿‡ sysadmin åœ¨ slave node ä¸Šæ‰§è¡Œ <code>CLUSTER FAILOVER [FORCE|TAKEOVER]</code> å‘½ä»¤è§¦å‘ã€‚</p><p>å®Œæ•´ manual failover è¿‡ç¨‹åœ¨ä¹‹å‰çš„ <a href="https://happencc.gitee.io/54df012b.html">åšå®¢ </a>è¯¦ç»†è®¨è®ºè¿‡ï¼Œæ¦‚æ‹¬ä¸ºä»¥ä¸‹ 6 ä¸ªæ­¥éª¤ï¼š</p><ol><li>slave å‘èµ·è¯·æ±‚ï¼Œgossip æ¶ˆæ¯æºå¸¦ <strong>CLUSTERMSG_TYPE_MFSTART</strong> æ ‡è¯†ã€‚</li><li>master é˜»å¡ clientï¼Œåœæœæ—¶é—´ä¸º 2 å€ <strong>CLUSTER_MF_TIMEOUT</strong>ï¼Œç›®å‰ç‰ˆæœ¬ä¸º 10sã€‚</li><li>slave è¿½èµ¶ä¸»ä»å¤åˆ¶ offset æ•°æ®ã€‚</li><li>slave å¼€å§‹å‘èµ·é€‰ä¸¾ï¼Œå¹¶æœ€ç»ˆå½“é€‰ã€‚</li><li>slave åˆ‡æ¢è‡ªèº« roleï¼Œæ¥ç®¡ slotsï¼Œå¹¶å¹¿æ’­æ–°çš„è·¯ç”±ä¿¡æ¯ã€‚</li><li>å…¶ä»–èŠ‚ç‚¹æ›´æ”¹è·¯ç”±ï¼Œcluster è·¯ç”±æ‰“å¹³ã€‚</li></ol><p>ä¸‰ä¸ªé€‰é¡¹åˆ†åˆ«æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œåˆ†æå¦‚ä¸‹ï¼Œ</p><p>ï¼ˆ1ï¼‰é»˜è®¤é€‰é¡¹ã€‚<br>æ‰§è¡Œå®Œæ•´çš„ mf æµç¨‹ï¼Œmaster æœ‰åœæœè¡Œä¸ºï¼Œå› æ­¤ä¸å­˜åœ¨ write ä¸¢å¤±çš„é—®é¢˜ã€‚</p><p>ï¼ˆ2ï¼‰FORCE é€‰é¡¹ã€‚<br>ä»ç¬¬ 4 æ­¥å¼€å§‹æ‰§è¡Œã€‚åœ¨ <strong>slave Câ€™ ç»Ÿè®¡é€‰ç¥¨é˜¶æ®µï¼Œmaster C ä»ç„¶å¯ä»¥æ­£å¸¸æ¥æ”¶ç”¨æˆ·è¯·æ±‚</strong>ï¼Œä¸”ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œè¿™äº›éƒ½å¯èƒ½å¯¼è‡´ write ä¸¢å¤±ã€‚mf å°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å¼€å§‹æ‰§è¡Œï¼Œtimeout æ—¶é—´ä¸º <strong>CLUSTER_MF_TIMEOUT</strong>ï¼ˆç°ç‰ˆæœ¬ä¸º 5sï¼‰ï¼Œæ¯æ¬¡ <code>clusterCron</code> éƒ½ä¼šæ£€æŸ¥ã€‚</p><p>ï¼ˆ3ï¼‰TAKEOVER é€‰é¡¹ã€‚<br>ä»ç¬¬ 5 æ­¥å¼€å§‹æ‰§è¡Œã€‚slave ç›´æ¥å¢åŠ è‡ªå·±çš„ configEpochï¼ˆæ— éœ€å…¶ä»– node åŒæ„ï¼‰ï¼Œæ¥ç®¡ slotsã€‚<strong>ä» slave Câ€™ åˆ‡æ¢ä¸º master ï¼Œåˆ°åŸ master èŠ‚ç‚¹ C æ›´æ–°è·¯ç”±ï¼Œå‘åˆ° C çš„è¯·æ±‚ï¼Œéƒ½å¯èƒ½å­˜åœ¨ write ä¸¢å¤±çš„å¯èƒ½</strong>ï¼Œä¸€èˆ¬åœ¨ä¸€ä¸ª ping çš„æ—¶é—´å†…å®Œæˆï¼Œæ—¶é—´çª—å£å¾ˆå°ã€‚C å’Œ Câ€™ ä»¥å¤–èŠ‚ç‚¹æ›´æ–°è·¯ç”±æ»ååªä¼šå¸¦æ¥å¤šä¸€æ¬¡çš„ <strong>MOVED</strong> é”™è¯¯ï¼Œä¸ä¼šå¯¼è‡´ write ä¸¢å¤±ã€‚</p><h2 id="master- é‡å¯"><a href="#master- é‡å¯" class="headerlink" title="master é‡å¯"></a>master é‡å¯</h2><h3 id="cluster- çŠ¶æ€åˆå§‹åŒ–"><a href="#cluster- çŠ¶æ€åˆå§‹åŒ–" class="headerlink" title="cluster çŠ¶æ€åˆå§‹åŒ–"></a>cluster çŠ¶æ€åˆå§‹åŒ–</h3><p>clusterState ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª <strong>state</strong> æˆå‘˜å˜é‡ï¼Œè¡¨ç¤º cluster çš„å…¨å±€çŠ¶æ€ï¼Œæ§åˆ¶ç€å½“å‰ cluster æ˜¯å¦å¯ä»¥æä¾›æœåŠ¡ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å–å€¼ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLUSTER_OK 0    <span class="hljs-comment">/* Everything looks ok */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLUSTER_FAIL 1  <span class="hljs-comment">/* The cluster can&#x27;t work */</span></span></code></pre></div><p>server é‡å¯åï¼Œstate è¢«åˆå§‹åŒ–ä¸º <strong>CLUSTER_FAIL</strong>ï¼Œä»£ç é€»è¾‘å¯ä»¥åœ¨ <code>clusterInit</code> å‡½æ•°ä¸­æ‰¾åˆ°ã€‚</p><p>å¯¹äº <strong>CLUSTER_FAIL</strong> çŠ¶æ€çš„ cluster æ˜¯æ‹’ç»æ¥å—è®¿é—®çš„ï¼Œä»£ç å‚è€ƒå¦‚ä¸‹ï¼Œ<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">processCommand</span><span class="hljs-params">(client *c)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (server.cluster_enabled &amp;&amp;
    !(c-&gt;flags &amp; CLIENT_MASTER) &amp;&amp;
    !(c-&gt;flags &amp; CLIENT_LUA &amp;&amp;
        server.lua_caller-&gt;flags &amp; CLIENT_MASTER) &amp;&amp;
    !(c-&gt;cmd-&gt;getkeys_proc == <span class="hljs-literal">NULL</span> &amp;&amp; c-&gt;cmd-&gt;firstkey == <span class="hljs-number">0</span> &amp;&amp;
        c-&gt;cmd-&gt;proc != execCommand))
&#123;
    <span class="hljs-keyword">int</span> hashslot;
    <span class="hljs-keyword">int</span> error_code;
    
    clusterNode *n = getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,
                                    &amp;hashslot,&amp;error_code);
    ...
&#125;</code></pre></div><br>é‡ç‚¹åœ¨ <code>getNodeByQuery</code> å‡½æ•°ï¼Œåœ¨ cluster æ¨¡å¼å¼€å¯åï¼Œç”¨æ¥æŸ¥æ‰¾åˆ°çœŸæ­£è¦æ‰§è¡Œ command çš„ nodeã€‚</p><div class="note note-warning"><p><strong>æ³¨æ„</strong>ï¼š</p><p>redis cluster é‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„è·¯ç”±ç®¡ç†ç­–ç•¥ï¼Œæ¯ä¸€ä¸ª node éƒ½å¯ä»¥ç›´æ¥è®¿é—®ï¼Œå¦‚æœè¦æ‰§è¡Œ command çš„ node ä¸æ˜¯å½“å‰è¿æ¥çš„ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª -MOVED çš„é‡å®šå‘é”™è¯¯ï¼ŒæŒ‡å‘çœŸæ­£è¦æ‰§è¡Œ command çš„ nodeã€‚</p></div><p>ä¸‹é¢çœ‹ <code>getNodeByQuery</code> å‡½æ•°çš„éƒ¨åˆ†é€»è¾‘ï¼Œ</p><div class="hljs"><pre><code class="hljs c">
<span class="hljs-function">clusterNode *<span class="hljs-title">getNodeByQuery</span><span class="hljs-params">(client *c, </span></span>
<span class="hljs-function"><span class="hljs-params">    struct redisCommand *cmd, robj **argv, </span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">int</span> *hashslot, </span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> *error_code)</span> </span>&#123;
        ...
        <span class="hljs-keyword">if</span> (server.cluster-&gt;state != CLUSTER_OK) &#123;
            <span class="hljs-keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_DOWN_STATE;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
        &#125;
        ...
&#125;</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå¿…é¡»æ˜¯ <strong>CLUSTER_OK</strong> çŠ¶æ€çš„ cluster æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚</p><p>æˆ‘ä»¬è¯´ï¼Œè¿™ç§é™åˆ¶å¯¹äº <strong>ä¿è¯ Write safety</strong> æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼<br>å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœ master A æŒ‚æ‰åï¼Œå¯¹åº”çš„ slave Aâ€™ é€šè¿‡é€‰ä¸¾æˆåŠŸå½“é€‰ä¸ºæ–° masterã€‚æ­¤æ—¶ï¼Œ<strong>A é‡å¯ï¼Œä¸”æ°å¥½æœ‰ä¸€äº› client çœ‹åˆ°çš„è·¯ç”±æ²¡æœ‰æ›´æ–°ï¼Œå®ƒä»¬ä»ç„¶ä¼šå¾€ A ä¸Šå†™æ•°æ®ï¼Œå¦‚æœæ¥å—è¿™äº› writeï¼Œå°±ä¼šä¸¢æ•°æ®ï¼</strong>Aâ€™ æ‰æ˜¯è¿™ä¸ª sharding å¤§å®¶å…¬è®¤çš„ masterã€‚æ‰€ä»¥ï¼ŒAâ€™ é‡å¯åéœ€è¦å…ˆç¦ç”¨æœåŠ¡ï¼Œç›´åˆ°è·¯ç”±å˜æ›´å®Œæˆã€‚</p><h3 id="cluster- çŠ¶æ€å˜æ›´"><a href="#cluster- çŠ¶æ€å˜æ›´" class="headerlink" title="cluster çŠ¶æ€å˜æ›´"></a>cluster çŠ¶æ€å˜æ›´</h3><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ cluster æ‰ä¼šå‡ºç° <strong>CLUSTER_FAIL</strong> -&gt; <strong>CLUSTER_OK</strong> çš„çŠ¶æ€å˜æ›´å‘¢ï¼Ÿç­”æ¡ˆè¦åœ¨ <code>clusterCron</code> å®šæ—¶ä»»åŠ¡é‡Œæ‰¾ã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterCron</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (update_state || server.cluster-&gt;state == CLUSTER_FAIL)
        clusterUpdateState();
&#125;</code></pre></div><p>å…³é”®é€»è¾‘åœ¨ <code>clusterUpdateState</code> å‡½æ•°é‡Œã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLUSTER_WRITABLE_DELAY 2000</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterUpdateState</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">mstime_t</span> first_call_time = <span class="hljs-number">0</span>;
    ...
    <span class="hljs-keyword">if</span> (first_call_time == <span class="hljs-number">0</span>) first_call_time = mstime();
    <span class="hljs-keyword">if</span> (nodeIsMaster(myself) &amp;&amp;
        server.cluster-&gt;state == CLUSTER_FAIL &amp;&amp;
        mstime() - first_call_time &lt; CLUSTER_WRITABLE_DELAY) <span class="hljs-keyword">return</span>;
    
    new_state = CLUSTER_OK;
    ...
    <span class="hljs-keyword">if</span> (new_state != server.cluster-&gt;state) &#123;
        ...
        server.cluster-&gt;state = new_state;
    &#125;
&#125;</code></pre></div><br>åœ¨ä»¥ä¸Šé€»è¾‘é‡Œå¯ä»¥çœ‹åˆ°ï¼Œcluster çŠ¶æ€å˜æ›´è¦å»¶è¿Ÿ <strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’ï¼Œç›®å‰ç‰ˆæœ¬ä¸º 2sã€‚</p><p>è®¿é—®å»¶è¿Ÿå°±æ˜¯ä¸ºäº†ç­‰å¾…è·¯ç”±å˜æ›´ï¼Œé‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™è§¦å‘è·¯ç”±å˜æ›´å‘¢ï¼Ÿ<br>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªæ–° server åˆšå¯åŠ¨ï¼Œå®ƒä¸å…¶ä»– node è¿›è¡Œ gossip é€šä¿¡çš„ link éƒ½æ˜¯ nullï¼Œåœ¨ <code>clusterCron</code> é‡Œæ£€æŸ¥å‡ºæ¥åä¼šä¾æ¬¡è¿æ¥ï¼Œå¹¶å‘é€ pingã€‚ä½œä¸ºä¸€ä¸ªè·¯ç”±è¿‡æœŸçš„è€èŠ‚ç‚¹ï¼Œæ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ update æ¶ˆæ¯ï¼Œæ›´æ”¹è‡ªèº«è·¯ç”±ã€‚</p><p><strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’åï¼ŒA èŠ‚ç‚¹æ¢å¤è®¿é—®ï¼Œæˆ‘ä»¬è®¤ä¸º CLUSTER_WRITABLE_DELAY çš„æ—¶é—´çª—å£è¶³å¤Ÿæ›´æ–°è·¯ç”±ã€‚</p><h2 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h2><h3 id="partition- å‘ç”Ÿ"><a href="#partition- å‘ç”Ÿ" class="headerlink" title="partition å‘ç”Ÿ"></a>partition å‘ç”Ÿ</h3><p>ç”±äºç½‘ç»œçš„ä¸å¯é ï¼Œç½‘ç»œåˆ†åŒºæ˜¯ä¸€ä¸ªå¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ï¼Œä¹Ÿå³ CAP ç†è®ºä¸­çš„ Pã€‚</p><p>partition å‘ç”Ÿåï¼Œcluster è¢«å‰²è£‚æˆ majority å’Œ minority ä¸¤éƒ¨åˆ†ï¼Œè¿™é‡Œä»¥åˆ†åŒºä¸­ master èŠ‚ç‚¹çš„æ•°é‡æ¥åŒºåˆ†ã€‚</p><p>ï¼ˆ1ï¼‰<strong>å¯¹äº minority éƒ¨åˆ†</strong>ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œä½†æ˜¯ä¸èƒ½æ”¶åˆ°å¤§å¤šæ•° master çš„é€‰ç¥¨ï¼Œä¹Ÿå°±æ— æ³•å®Œæˆæ­£å¸¸çš„ failover æµç¨‹ã€‚åŒæ—¶åœ¨ <code>clusterCron</code> é‡Œå¤§éƒ¨åˆ†èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸º <strong>CLUSTER_NODE_PFAIL</strong> çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘ <code>clusterUpdateState</code> çš„é€»è¾‘ï¼Œå¤§æ¦‚å¦‚ä¸‹ï¼Œ</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterCron</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    di = dictGetSafeIterator(server.cluster-&gt;nodes);
    <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) &#123;
        ...
        delay = now - node-&gt;ping_sent;
        <span class="hljs-keyword">if</span> (delay &gt; server.cluster_node_timeout) &#123;
            <span class="hljs-keyword">if</span> (!(node-&gt;flags &amp; (CLUSTER_NODE_PFAIL|CLUSTER_NODE_FAIL))) &#123;
                serverLog(LL_DEBUG,<span class="hljs-string">&quot;*** NODE %.40s possibly failing&quot;</span>,
                    node-&gt;name);
                node-&gt;flags |= CLUSTER_NODE_PFAIL;
                update_state = <span class="hljs-number">1</span>;
            &#125;
        &#125;  
    &#125;
    ...
    <span class="hljs-keyword">if</span> (update_state || server.cluster-&gt;state == CLUSTER_FAIL)
        clusterUpdateState();
&#125;</code></pre></div><p>è€Œåœ¨ <code>clusterUpdateState</code> å‡½æ•°é‡Œï¼Œä¼šæ”¹å˜ cluster çš„çŠ¶æ€ã€‚<br><div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterUpdateState</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">mstime_t</span> among_minority_time;
    ...
    &#123;
        dictIterator *di;
        dictEntry *de;
        server.cluster-&gt;size = <span class="hljs-number">0</span>;
        di = dictGetSafeIterator(server.cluster-&gt;nodes);
        <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) &#123;
            clusterNode *node = dictGetVal(de);
            <span class="hljs-keyword">if</span> (nodeIsMaster(node) &amp;&amp; node-&gt;numslots) &#123;
                server.cluster-&gt;size++;
                <span class="hljs-keyword">if</span> ((node-&gt;flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL)) == <span class="hljs-number">0</span>)
                    reachable_masters++;
            &#125;
        &#125;
        dictReleaseIterator(di);
    &#125;
    &#123;
        <span class="hljs-keyword">int</span> needed_quorum = (server.cluster-&gt;size / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (reachable_masters &lt; needed_quorum) &#123;
            new_state = CLUSTER_FAIL;
            among_minority_time = mstime();
        &#125;
    &#125;
    ...
&#125;</code></pre></div><br>ç”±ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨ minority ä¸­ï¼Œcluster çŠ¶æ€åœ¨ä¸€æ®µæ—¶é—´åä¼šè¢«æ›´æ”¹ä¸º <strong>CLUSTER_FAIL</strong>ã€‚ä½†ï¼Œå¯¹äºä¸€ä¸ªåˆ’åˆ†åˆ° minority çš„ master Bï¼Œåœ¨çŠ¶æ€æ›´æ”¹å‰æ˜¯ä¸€ç›´å¯ä»¥è®¿é—®çš„ï¼Œè¿™å°±æœ‰ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œä¼šå¯¼è‡´ write ä¸¢å¤±ï¼ï¼</p><p>åœ¨ <code>clusterCron</code> å‡½æ•°ä¸­å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªæ—¶é—´çª—å£çš„å¤§å°ã€‚ä» partition æ—¶é—´å¼€å§‹ç®—èµ·ï¼Œ<strong>cluster_node_timeout</strong> æ—¶é—´åæ‰ä¼šæœ‰ node æ ‡è®°ä¸º PFAILï¼ŒåŠ ä¸Š gossip æ¶ˆæ¯ä¼ æ’­ä¼šåå‘äºæºå¸¦ PFAIL çš„èŠ‚ç‚¹ï¼Œnode B ä¸å¿…ç­‰åˆ° <strong>cluster_node_timeout/2</strong> æŠŠ cluster nodes ping éï¼Œå°±å¯ä»¥å°† cluster æ ‡è®°ä¸º <strong>CLUSTER_FAIL</strong>ã€‚å¯ä»¥æ¨ç®—å‡ºï¼Œæ—¶é—´çª—å£å¤§çº¦ä¸º <strong>cluster_node_timeout</strong>ã€‚</p><p>å¦å¤–ï¼Œä¼šè®°å½•ä¸‹ç¦ç”¨æœåŠ¡çš„æ—¶é—´ï¼Œå³ among_minority_timeã€‚</p><p>ï¼ˆ2ï¼‰<strong>å¯¹äº majority éƒ¨åˆ† </strong>ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œä»¥ B çš„ slave Bâ€™ ä¸ºä¾‹ï¼Œfailover åˆ‡ä¸ºæ–°çš„ masterï¼Œå¹¶æä¾›æœåŠ¡ã€‚<br>å¦‚æœ partition æ—¶é—´å°äº <strong>cluster_node_timeout</strong>ï¼Œä»¥è‡³äºæ²¡æœ‰ PFAIL æ ‡è¯†å‡ºç°ï¼Œå°±ä¸ä¼šæœ‰ write ä¸¢å¤±ã€‚</p><h3 id="partition- æ¢å¤"><a href="#partition- æ¢å¤" class="headerlink" title="partition æ¢å¤"></a>partition æ¢å¤</h3><p>å½“ partition æ¢å¤åï¼Œminority ä¸­çš„ è€ master B é‡æ–°åŠ è¿› clusterï¼ŒB è¦æƒ³æä¾›æœåŠ¡ï¼Œå°±å¿…é¡»å…ˆå°† cluster çŠ¶æ€ä» <strong>CLUSTER_FAIL</strong> ä¿®æ”¹ä¸º <strong>CLUSTER_OK</strong>ï¼Œé‚£ä¹ˆï¼Œåº”è¯¥ä»€ä¹ˆæ—¶å€™æ”¹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ B ä¸­æ˜¯æ—§è·¯ç”±ï¼Œæ­¤æ—¶å®ƒåº”è¯¥å˜æ›´ä¸º slaveï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´åšè·¯ç”±å˜æ›´ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç° write ä¸¢å¤±çš„é—®é¢˜ï¼ˆå‰é¢åˆ†æè¿‡ï¼‰ï¼ŒåŒæ ·åœ¨ <code>clusterUpdateState</code> å‡½æ•°çš„é€»è¾‘é‡Œã€‚</p><div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLUSTER_MAX_REJOIN_DELAY 5000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CLUSTER_MIN_REJOIN_DELAY 500</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clusterUpdateState</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;
    ...
    <span class="hljs-keyword">if</span> (new_state != server.cluster-&gt;state) &#123;
        <span class="hljs-keyword">mstime_t</span> rejoin_delay = server.cluster_node_timeout;

        <span class="hljs-keyword">if</span> (rejoin_delay &gt; CLUSTER_MAX_REJOIN_DELAY)
            rejoin_delay = CLUSTER_MAX_REJOIN_DELAY;
        <span class="hljs-keyword">if</span> (rejoin_delay &lt; CLUSTER_MIN_REJOIN_DELAY)
            rejoin_delay = CLUSTER_MIN_REJOIN_DELAY;

        <span class="hljs-keyword">if</span> (new_state == CLUSTER_OK &amp;&amp;
            nodeIsMaster(myself) &amp;&amp;
            mstime() - among_minority_time &lt; rejoin_delay)
        &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
    &#125;
&#125;</code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œæ—¶é—´çª—å£ä¸º <strong>cluster_node_timeout</strong>ï¼Œæœ€å¤š 5sï¼Œæœ€å°‘ 500msã€‚</p><h2 id="å°ç»“"><a href="# å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>failover å¯èƒ½å› ä¸ºé€‰ä¸¾å’Œä¸»ä»å¼‚æ­¥å¤åˆ¶æ•°æ®åå·®å¸¦æ¥ write ä¸¢å¤±ã€‚</p><p>master é‡å¯é€šè¿‡ <strong>CLUSTER_WRITABLE_DELAY</strong> å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚</p><p>partition ä¸­çš„ minority éƒ¨åˆ†ï¼Œåœ¨ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_FAIL</strong> ä¹‹å‰ï¼Œå¯èƒ½å­˜åœ¨ write ä¸¢å¤±ã€‚</p><p>partition æ¢å¤åï¼Œé€šè¿‡ rejoin_delay å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/">æºç ç³»åˆ—</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/redis/">redis</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/a4c4e01c.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis Cluster availability è®¨è®º</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/a722b34f.html"><span class="hidden-mobile">git ä½¿ç”¨ç¬”è®°</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNjg1MS8xMzM4Nw"><script type="text/javascript">function loadLivere(){addScript("https://cdn-city.livere.com/js/embed.dist.js")}waitElementVisible("lv-container",loadLivere)</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·å…è®¸ JavaScript è¿è¡Œ</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="footer-content"><div><span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/03/2016 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="ğŸš€ &nbsp"+dnum+"&nbspå¤©",document.getElementById("times").innerHTML=hnum+"&nbspå°æ—¶&nbsp"+mnum+"&nbspåˆ†&nbsp"+snum+"&nbspç§’"}setInterval("createtime()",250)</script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡ </span><span id="busuanzi_container_site_uv" style="display:none">æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:3,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Redis Cluster write safety åˆ†æ&nbsp;"],cursorChar:"|",typeSpeed:72,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "Â§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?14630c2a053c5952e46094f24dabb623";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>